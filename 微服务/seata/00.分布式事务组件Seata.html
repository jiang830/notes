<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.8" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.26" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <title>分布式事务组件Seata</title><meta name="description" content="">
    <link rel="preload" href="/assets/style-CV-aSyL0.css" as="style"><link rel="stylesheet" href="/assets/style-CV-aSyL0.css">
    <link rel="modulepreload" href="/assets/app-CT4bPn0M.js"><link rel="modulepreload" href="/assets/00.分布式事务组件Seata.html-DvBICF5t.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-CSpmhHeK.js" as="script"><link rel="prefetch" href="/assets/index.html--2R5vsdh.js" as="script"><link rel="prefetch" href="/assets/index.html-BnXtwsXL.js" as="script"><link rel="prefetch" href="/assets/index.html-B7hYqSw6.js" as="script"><link rel="prefetch" href="/assets/index.html-DUyfniXY.js" as="script"><link rel="prefetch" href="/assets/index.html-BKnH3ub0.js" as="script"><link rel="prefetch" href="/assets/index.html-BGvXNw7H.js" as="script"><link rel="prefetch" href="/assets/index.html-DKvIwItS.js" as="script"><link rel="prefetch" href="/assets/index.html-BLFHdWAv.js" as="script"><link rel="prefetch" href="/assets/阿里云面试题.html-67Gclmd5.js" as="script"><link rel="prefetch" href="/assets/index.html-Coth3iwF.js" as="script"><link rel="prefetch" href="/assets/index.html-DL1BW0Yy.js" as="script"><link rel="prefetch" href="/assets/index.html-Cv7ToGV2.js" as="script"><link rel="prefetch" href="/assets/index.html-CiOSF6nN.js" as="script"><link rel="prefetch" href="/assets/index.html-wgNrMjyX.js" as="script"><link rel="prefetch" href="/assets/index.html-DMtMjVx-.js" as="script"><link rel="prefetch" href="/assets/index.html-D7jwlDKQ.js" as="script"><link rel="prefetch" href="/assets/index.html-CU5_oyTi.js" as="script"><link rel="prefetch" href="/assets/index.html-Bq6U-nqM.js" as="script"><link rel="prefetch" href="/assets/index.html-BxoJLgxp.js" as="script"><link rel="prefetch" href="/assets/index.html-B04c0mD5.js" as="script"><link rel="prefetch" href="/assets/index.html-gaD97CLH.js" as="script"><link rel="prefetch" href="/assets/index.html-nv6Kc-Od.js" as="script"><link rel="prefetch" href="/assets/index.html-OXo_SpP2.js" as="script"><link rel="prefetch" href="/assets/index.html-DGBnV6QP.js" as="script"><link rel="prefetch" href="/assets/index.html-DRfvV7TW.js" as="script"><link rel="prefetch" href="/assets/index.html-4TFYILmP.js" as="script"><link rel="prefetch" href="/assets/index.html-CGfXoegH.js" as="script"><link rel="prefetch" href="/assets/index.html-DMW40kv2.js" as="script"><link rel="prefetch" href="/assets/index.html-BLfh2K27.js" as="script"><link rel="prefetch" href="/assets/index.html-FnU2NHSk.js" as="script"><link rel="prefetch" href="/assets/index.html-CVyeJ0nv.js" as="script"><link rel="prefetch" href="/assets/index.html-CtS7Hbk_.js" as="script"><link rel="prefetch" href="/assets/index.html-CS-yKKXA.js" as="script"><link rel="prefetch" href="/assets/index.html-g5I17pEN.js" as="script"><link rel="prefetch" href="/assets/index.html-pNX6YByX.js" as="script"><link rel="prefetch" href="/assets/index.html-WBck0DLr.js" as="script"><link rel="prefetch" href="/assets/index.html-R6fBvdOR.js" as="script"><link rel="prefetch" href="/assets/index.html-CRR46Q79.js" as="script"><link rel="prefetch" href="/assets/index.html-X36h9xAV.js" as="script"><link rel="prefetch" href="/assets/index.html-Db4ciJxl.js" as="script"><link rel="prefetch" href="/assets/index.html-B9-qp9Zv.js" as="script"><link rel="prefetch" href="/assets/index.html-BRwRkKjq.js" as="script"><link rel="prefetch" href="/assets/index.html-DkNN0Ggn.js" as="script"><link rel="prefetch" href="/assets/index.html-BevbfSBP.js" as="script"><link rel="prefetch" href="/assets/index.html-DGKoOKvk.js" as="script"><link rel="prefetch" href="/assets/index.html-CczDofwy.js" as="script"><link rel="prefetch" href="/assets/index.html-DrRa28Ct.js" as="script"><link rel="prefetch" href="/assets/index.html-CsU1DR0W.js" as="script"><link rel="prefetch" href="/assets/index.html-Dlzay4Hw.js" as="script"><link rel="prefetch" href="/assets/index.html-LsMzeSDA.js" as="script"><link rel="prefetch" href="/assets/index.html-CHbiAsYT.js" as="script"><link rel="prefetch" href="/assets/index.html-RaZGZNi3.js" as="script"><link rel="prefetch" href="/assets/index.html-D3wsEvzo.js" as="script"><link rel="prefetch" href="/assets/index.html-JrOC7KC5.js" as="script"><link rel="prefetch" href="/assets/index.html-By_gwF0J.js" as="script"><link rel="prefetch" href="/assets/index.html-qWKG5AAK.js" as="script"><link rel="prefetch" href="/assets/index.html-avZIruPQ.js" as="script"><link rel="prefetch" href="/assets/06.MySQL事务原理与优化最佳实践.html-CSvQNied.js" as="script"><link rel="prefetch" href="/assets/07.MySQL锁机制与优化实践以及MVCC底层原理剖析.html-C23WGqOw.js" as="script"><link rel="prefetch" href="/assets/index.html-Cn4Gzbph.js" as="script"><link rel="prefetch" href="/assets/index.html-uCyFZumH.js" as="script"><link rel="prefetch" href="/assets/index.html-Bm22WFrJ.js" as="script"><link rel="prefetch" href="/assets/index.html-CSd8d20G.js" as="script"><link rel="prefetch" href="/assets/index.html-CvtEazEf.js" as="script"><link rel="prefetch" href="/assets/index.html-BeAXTpGW.js" as="script"><link rel="prefetch" href="/assets/20.ShardingJDBC源码与内核解析.html-CwyPvd-u.js" as="script"><link rel="prefetch" href="/assets/index.html-DHNMdh3m.js" as="script"><link rel="prefetch" href="/assets/index.html-CCd71ZlA.js" as="script"><link rel="prefetch" href="/assets/index.html-ynJ_kUEc.js" as="script"><link rel="prefetch" href="/assets/index.html-BVfeOYGv.js" as="script"><link rel="prefetch" href="/assets/index.html-CZxOdSnk.js" as="script"><link rel="prefetch" href="/assets/index.html-B-iFN7DD.js" as="script"><link rel="prefetch" href="/assets/index.html-uTIDrkZJ.js" as="script"><link rel="prefetch" href="/assets/index.html-DazyV-CZ.js" as="script"><link rel="prefetch" href="/assets/index.html-DHXS2c57.js" as="script"><link rel="prefetch" href="/assets/index.html-_Fwj-qwX.js" as="script"><link rel="prefetch" href="/assets/index.html-CSa7fUHZ.js" as="script"><link rel="prefetch" href="/assets/index.html-CrqWKted.js" as="script"><link rel="prefetch" href="/assets/index.html-DzjXF5r0.js" as="script"><link rel="prefetch" href="/assets/index.html-QNlXUK6I.js" as="script"><link rel="prefetch" href="/assets/index.html-BDUKsSrh.js" as="script"><link rel="prefetch" href="/assets/index.html-CE1fU4lb.js" as="script"><link rel="prefetch" href="/assets/index.html-IKd9LHPY.js" as="script"><link rel="prefetch" href="/assets/index.html-BNrR4y_n.js" as="script"><link rel="prefetch" href="/assets/index.html-DfI_4yCq.js" as="script"><link rel="prefetch" href="/assets/index.html-0esUAKmz.js" as="script"><link rel="prefetch" href="/assets/index.html-DAH0eLXe.js" as="script"><link rel="prefetch" href="/assets/404.html-BBVwT601.js" as="script"><link rel="prefetch" href="/assets/index.html-9nyom5YJ.js" as="script"><link rel="prefetch" href="/assets/index.html-Dgaj-2Bf.js" as="script"><link rel="prefetch" href="/assets/index.html-BG3rmTga.js" as="script"><link rel="prefetch" href="/assets/index.html-C2MGwNwF.js" as="script"><link rel="prefetch" href="/assets/index.html-oFdCiLjS.js" as="script"><link rel="prefetch" href="/assets/index.html-BsOyCIBe.js" as="script"><link rel="prefetch" href="/assets/index.html-D6eGZPOp.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-SzV8tJDW.js" as="script"><link rel="prefetch" href="/assets/SearchResult-BFy21v4C.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><!----><!----><!----></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="首页"><span class="font-icon icon circle-question" style=""></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/pages/" aria-label="文档"><span class="font-icon icon circle-question" style=""></span>文档<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">分布式</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">容器</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">并发编程</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">微服务</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">00. Spring Boot原理</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">10. Spring Cloud Alibaba</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Nacos</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">Seata</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/pages/202308030516/" aria-label="Seata事务模式"><!---->Seata事务模式<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html" aria-label="分布式事务组件Seata"><!---->分布式事务组件Seata<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html#分布式事务简介" aria-label="分布式事务简介"><!---->分布式事务简介<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html#本地事务" aria-label="本地事务"><!---->本地事务<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html#分布式事务" aria-label="分布式事务"><!---->分布式事务<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html#两阶段提交协议-2pc" aria-label="两阶段提交协议(2PC)"><!---->两阶段提交协议(2PC)<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html#seata是什么" aria-label="Seata是什么"><!---->Seata是什么<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html#seata的三大角色" aria-label="Seata的三大角色"><!---->Seata的三大角色<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html#seata快速开始" aria-label="Seata快速开始"><!---->Seata快速开始<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html#seata-server-tc-环境搭建" aria-label="Seata Server（TC）环境搭建"><!---->Seata Server（TC）环境搭建<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1/seata/00.%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%BB%84%E4%BB%B6Seata.html#seata-client快速开始" aria-label="Seata Client快速开始"><!---->Seata Client快速开始<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">性能调优</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">源码框架</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">算法</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">计算机网络</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">面试</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->分布式事务组件Seata</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-05-10T04:10:16.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 14 分钟</span><meta property="timeRequired" content="PT14M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#分布式事务简介">分布式事务简介</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#本地事务">本地事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#分布式事务">分布式事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#两阶段提交协议-2pc">两阶段提交协议(2PC)</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#seata是什么">Seata是什么</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#seata的三大角色">Seata的三大角色</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#seata快速开始">Seata快速开始</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#seata-server-tc-环境搭建">Seata Server（TC）环境搭建</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#seata-client快速开始">Seata Client快速开始</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><p>seata版本： v1.5.1</p><p>分布式事务常用方案： AT TCC 基于可靠消息最终一致性</p><h2 id="分布式事务简介" tabindex="-1"><a class="header-anchor" href="#分布式事务简介"><span>分布式事务简介</span></a></h2><p>分布式事务：https://www.processon.com/view/link/61cd52fb0e3e7441570801ab</p><h3 id="本地事务" tabindex="-1"><a class="header-anchor" href="#本地事务"><span>本地事务</span></a></h3><p>大多数场景下，我们的应用都只需要操作单一的数据库，这种情况下的事务称之为本地事务(Local Transaction)。本地事务的ACID特性是数据库直接提供支持。本地事务应用架构如下所示：</p><p>​ <img src="https://img.jssjqd.cn//202305081713521.png" alt="image-20230508171339502"></p><p>在JDBC编程中，我们通过java.sql.Connection对象来开启、关闭或者提交事务。代码如下所示：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>Connection conn = ... //获取数据库连接
conn.setAutoCommit(false); //开启事务
try{
   //...执行增删改查sql
   conn.commit(); //提交事务
}catch (Exception e) {
  conn.rollback();//事务回滚
}finally{
   conn.close();//关闭链接
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分布式事务" tabindex="-1"><a class="header-anchor" href="#分布式事务"><span>分布式事务</span></a></h3><p>在微服务架构中，完成某一个业务功能可能需要横跨多个服务，操作多个数据库。这就涉及到到了分布式事务，需要操作的资源位于多个资源服务器上，而应用需要保证对于多个资源服务器的数据操作，要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同资源服务器的数据一致性。</p><h4 id="典型的分布式事务应用场景" tabindex="-1"><a class="header-anchor" href="#典型的分布式事务应用场景"><span>典型的分布式事务应用场景</span></a></h4><h5 id="跨库事务" tabindex="-1"><a class="header-anchor" href="#跨库事务"><span>跨库事务</span></a></h5><p>跨库事务指的是，一个应用某个功能需要操作多个库，不同的库中存储不同的业务数据。下图演示了一个服务同时操作2个库的情况：</p><p>​ <img src="https://img.jssjqd.cn//202305081715944.png" alt="image-20230508171519681"></p><h5 id="分库分表" tabindex="-1"><a class="header-anchor" href="#分库分表"><span>分库分表</span></a></h5><p>通常一个库数据量比较大或者预期未来的数据量比较大，都会进行分库分表。如下图，将数据库B拆分成了2个库：</p><p>​ <img src="https://img.jssjqd.cn//202305081715512.png" alt="image-20230508171523198"></p><p>对于分库分表的情况，一般开发人员都会使用一些数据库中间件来降低sql操作的复杂性。如，对于sql：insert into user(id,name) values (1,&quot;张三&quot;),(2,&quot;李四&quot;)。这条sql是操作单库的语法，单库情况下，可以保证事务的一致性。 但是由于现在进行了分库分表，开发人员希望将1号记录插入分库1，2号记录插入分库2。所以数据库中间件要将其改写为2条sql，分别插入两个不同的分库，此时要保证两个库要不都成功，要不都失败，因此基本上所有的数据库中间件都面临着分布式事务的问题。</p><h5 id="微服务架构" tabindex="-1"><a class="header-anchor" href="#微服务架构"><span>微服务架构</span></a></h5><p>下图演示了一个3个服务之间彼此调用的微服务架构：</p><p>​ <img src="https://img.jssjqd.cn//202305081715094.png" alt="image-20230508171529046"></p><p>Service A完成某个功能需要直接操作数据库，同时需要调用Service B和Service C，而Service B又同时操作了2个数据库，Service C也操作了一个库。需要保证这些跨服务调用对多个数据库的操作要么都成功，要么都失败，实际上这可能是最典型的分布式事务场景。</p><p>小结：上述讨论的分布式事务场景中，无一例外的都直接或者间接的操作了多个数据库。如何保证事务的ACID特性，对于分布式事务实现方案而言，是非常大的挑战。同时，分布式事务实现方案还必须要考虑性能的问题，如果为了严格保证ACID特性，导致性能严重下降，那么对于一些要求快速响应的业务，是无法接受的。</p><h3 id="两阶段提交协议-2pc" tabindex="-1"><a class="header-anchor" href="#两阶段提交协议-2pc"><span>两阶段提交协议(2PC)</span></a></h3><p>两阶段提交（Two Phase Commit），就是将提交(commit)过程划分为2个阶段(Phase)：</p><p><strong>阶段1：</strong></p><p>TM通知各个RM准备提交它们的事务分支。如果RM判断自己进行的工作可以被提交，那就对工作内容进行持久化，再给TM肯定答复；要是发生了其他情况，那给TM的都是否定答复。</p><p>以mysql数据库为例，在第一阶段，事务管理器向所有涉及到的数据库服务器发出prepare&quot;准备提交&quot;请求，数据库收到请求后执行数据修改和日志记录等处理，处理完成后只是把事务的状态改成&quot;可以提交&quot;,然后把结果返回给事务管理器。</p><p><strong>阶段2</strong></p><p>TM根据阶段1各个RM prepare的结果，决定是提交还是回滚事务。如果所有的RM都prepare成功，那么TM通知所有的RM进行提交；如果有RM prepare失败的话，则TM通知所有RM回滚自己的事务分支。</p><p>以mysql数据库为例，如果第一阶段中所有数据库都prepare成功，那么事务管理器向数据库服务器发出&quot;确认提交&quot;请求，数据库服务器把事务的&quot;可以提交&quot;状态改为&quot;提交完成&quot;状态，然后返回应答。如果在第一阶段内有任何一个数据库的操作发生了错误，或者事务管理器收不到某个数据库的回应，则认为事务失败，回撤所有数据库的事务。数据库服务器收不到第二阶段的确认提交请求，也会把&quot;可以提交&quot;的事务回撤。</p><p>​ <img src="https://img.jssjqd.cn//202305081715669.png" alt="image-20230508171534487"></p><p>两阶段提交方案下全局事务的ACID特性，是依赖于RM的。一个全局事务内部包含了多个独立的事务分支，这一组事务分支要么都成功，要么都失败。各个事务分支的ACID特性共同构成了全局事务的ACID特性。也就是将单个事务分支支持的ACID特性提升一个层次到分布式事务的范畴。</p><p><strong>2PC存在的问题</strong></p><ul><li><strong>同步阻塞问题</strong></li></ul><p>2PC 中的参与者是阻塞的。在第一阶段收到请求后就会预先锁定资源，一直到 commit 后才会释放。</p><ul><li><strong>单点故障</strong></li></ul><p>由于协调者的重要性，一旦协调者TM发生故障，参与者RM会一直阻塞下去。尤其在第二阶段，协调者发生故障，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作。</p><ul><li><strong>数据不一致</strong></li></ul><p>若协调者第二阶段发送提交请求时崩溃，可能部分参与者收到commit请求提交了事务，而另一部分参与者未收到commit请求而放弃事务，从而造成数据不一致的问题。</p><h2 id="seata是什么" tabindex="-1"><a class="header-anchor" href="#seata是什么"><span>Seata是什么</span></a></h2><p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。AT模式是阿里首推的模式，阿里云上有商用版本的GTS（Global Transaction Service 全局事务服务）</p><p>官网：https://seata.io/zh-cn/index.html</p><p>源码: https://github.com/seata/seata</p><p>seata版本：v1.5.1</p><h3 id="seata的三大角色" tabindex="-1"><a class="header-anchor" href="#seata的三大角色"><span>Seata的三大角色</span></a></h3><p>在 Seata 的架构中，一共有三个角色：</p><ul><li><strong>TC (Transaction Coordinator) - 事务协调者</strong></li></ul><p>维护全局和分支事务的状态，驱动全局事务提交或回滚。</p><ul><li><strong>TM (Transaction Manager) - 事务管理器</strong></li></ul><p>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p><ul><li><strong>RM (Resource Manager) - 资源管理器</strong></li></ul><p>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p><p>其中，TC 为单独部署的 Server 服务端，TM 和 RM 为嵌入到应用中的 Client 客户端。</p><p>在 Seata 中，一个分布式事务的生命周期如下：</p><ol><li>TM 请求 TC 开启一个全局事务。TC 会生成一个 XID 作为该全局事务的编号。XID会在微服务的调用链路中传播，保证将多个微服务的子事务关联在一起。</li><li>RM 请求 TC 将本地事务注册为全局事务的分支事务，通过全局事务的 XID 进行关联。</li><li>TM 请求 TC 告诉 XID 对应的全局事务是进行提交还是回滚。</li><li>TC 驱动 RM 们将 XID 对应的自己的本地事务进行提交还是回滚。</li></ol><p>​ <img src="https://img.jssjqd.cn//202305081715781.png" alt="image-20230508171540724"></p><h2 id="seata快速开始" tabindex="-1"><a class="header-anchor" href="#seata快速开始"><span>Seata快速开始</span></a></h2><p>Seata分TC、TM和RM三个角色，TC（Server端）为单独服务端部署，TM和RM（Client端）由业务系统集成。</p><h3 id="seata-server-tc-环境搭建" tabindex="-1"><a class="header-anchor" href="#seata-server-tc-环境搭建"><span>Seata Server（TC）环境搭建</span></a></h3><p><strong>Server端存储模式（store.mode）支持三种：</strong></p><ul><li>file：单机模式，全局事务会话信息内存中读写并持久化本地文件root.data，性能较高</li><li>db：高可用模式，全局事务会话信息通过db共享，相应性能差些</li><li>redis：1.3及以上版本支持,性能较高,存在事务信息丢失风险,请提前配置适合当前场景的redis持久化配置</li></ul><p><strong>资源目录</strong>：</p><ul><li><p>https://github.com/seata/seata/tree/v1.5.1/script</p></li><li><p>client</p><ul><li>存放client端sql脚本，参数配置</li></ul></li><li><p>config-center</p><ul><li>各个配置中心参数导入脚本，config.txt(包含server和client)为通用参数文件</li></ul></li><li><p>server</p><ul><li>server端数据库脚本及各个容器配置</li></ul></li></ul><p><strong>db存储模式+Nacos(注册&amp;配置中心)方式部署</strong></p><p><strong>步骤一：下载安装包</strong></p><p>https://github.com/seata/seata/releases</p><p>​ <img src="https://img.jssjqd.cn//202305081715479.png" alt="image-20230508171558249"></p><p><strong>步骤二：建表(db模式)</strong></p><p>创建数据库seata，执行sql脚本，https://github.com/seata/seata/tree/v1.5.1/script/server/db</p><p>​ <img src="https://img.jssjqd.cn//202305081716166.png" alt="image-20230508171602370"></p><p><strong>步骤三：配置Nacos注册中心</strong></p><p>注册中心可以说是微服务架构中的”通讯录“，它记录了服务和服务地址的映射关系。在分布式架构中，服务会注册到注册中心，当服务需要调用其它服务时，就到注册中心找到服务的地址，进行调用。比如Seata Client端(TM,RM)，发现Seata Server(TC)集群的地址,彼此通信。</p><p>注意：Seata的注册中心是作用于Seata自身的，和Spring Cloud的注册中心无关</p><p>​ <img src="https://img.jssjqd.cn//202305081716782.png" alt="image-20230508171605814"></p><p>Seata支持哪些注册中心?</p><ol><li>eureka</li><li>consul</li><li>nacos</li><li>etcd</li><li>zookeeper</li><li>sofa</li><li>redis</li><li>file (直连)</li></ol><p><strong>配置将Seata Server注册到Nacos，修改conf/application.yml文件</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span>
      <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default
      <span class="token key atrule">username</span><span class="token punctuation">:</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：请确保client与server的注册处于同一个namespace和group，不然会找不到服务。</p><p>​ <img src="https://img.jssjqd.cn//202305081716440.png" alt="image-20230508171632642"></p><p>启动 Seata-Server 后，会发现Server端的服务出现在 Nacos 控制台中的注册中心列表中。</p><p><strong>步骤四：配置Nacos配置中心</strong></p><p>配置中心可以说是一个&quot;大货仓&quot;,内部放置着各种配置文件,你可以通过自己所需进行获取配置加载到对应的客户端。比如Seata Client端(TM,RM),Seata Server(TC),会去读取全局事务开关,事务会话存储模式等信息。</p><p>注意：Seata的配置中心是作用于Seata自身的，和Spring Cloud的配置中心无关</p><p>Seata支持哪些配置中心?</p><ol><li>nacos</li><li>consul</li><li>apollo</li><li>etcd</li><li>zookeeper</li><li>file (读本地文件, 包含conf、properties、yml配置文件的支持)</li></ol><p><strong>1）配置Nacos配置中心地址，修改conf/application.yml文件</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">seata</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token comment"># support: nacos, consul, apollo, zk, etcd3</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 7e838c12<span class="token punctuation">-</span>8554<span class="token punctuation">-</span>4231<span class="token punctuation">-</span>82d5<span class="token punctuation">-</span>6d93573ddf32
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seataServer.properties
     <span class="token key atrule">username</span><span class="token punctuation">:</span>
     <span class="token key atrule">password</span><span class="token punctuation">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ <img src="https://note.youdao.com/yws/public/resource/c480b9d259db401acff9fdd30a770d64/xmlnote/BEE32BE9E2064263B884D69EEA989021/53946" alt="0"></p><p><strong>2）上传配置至Nacos配置中心</strong></p><p>https://github.com/seata/seata/tree/v1.5.1/script/config-center</p><p>a) 获取/seata/script/config-center/config.txt，修改为db存储模式，并修改mysql连接配置</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">store.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span>
<span class="token key attr-name">store.lock.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span>
<span class="token key attr-name">store.session.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span>
<span class="token key attr-name">store.db.driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.jdbc.Driver</span>
<span class="token key attr-name">store.db.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span>
<span class="token key attr-name">store.db.user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">store.db.password</span><span class="token punctuation">=</span><span class="token value attr-value">root  </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在store.mode=db，由于seata是通过jdbc的executeBatch来批量插入全局锁的，根据MySQL官网的说明，连接参数中的rewriteBatchedStatements为true时，在执行executeBatch，并且操作类型为insert时，jdbc驱动会把对应的SQL优化成<code>insert into () values (), ()</code>的形式来提升批量插入的性能。 根据实际的测试，该参数设置为true后，对应的批量插入性能为原来的10倍多，因此在数据源为MySQL时，建议把该参数设置为true。</p><p><img src="https://img.jssjqd.cn//202305081720569.png" alt="image-20230508172037632"></p><p>b) 配置事务分组， 要与client配置的事务分组一致</p><ul><li>事务分组：seata的资源逻辑，可以按微服务的需要，在应用程序（客户端）对自行定义事务分组，每组取一个名字。</li><li>集群：seata-server服务端一个或多个节点组成的集群cluster。 应用程序（客户端）使用时需要指定事务逻辑分组与Seata服务端集群的映射关系。</li></ul><p>​ <img src="https://img.jssjqd.cn//202305081720351.png" alt="image-20230508172042501"></p><p>事务分组如何找到后端Seata集群（TC）？</p><ol><li>首先应用程序（客户端）中配置了事务分组（GlobalTransactionScanner 构造方法的txServiceGroup参数）。若应用程序是SpringBoot则通过seata.tx-service-group 配置。</li><li>应用程序（客户端）会通过用户配置的配置中心去寻找service.vgroupMapping .[事务分组配置项]，取得配置项的值就是TC集群的名称。若应用程序是SpringBoot则通过seata.service.vgroup-mapping.事务分组名=集群名称 配置</li><li>拿到集群名称程序通过一定的前后缀+集群名称去构造服务名，各配置中心的服务名实现不同（前提是Seata-Server已经完成服务注册，且Seata-Server向注册中心报告cluster名与应用程序（客户端）配置的集群名称一致）</li><li>拿到服务名去相应的注册中心去拉取相应服务名的服务列表，获得后端真实的TC服务列表（即Seata-Server集群节点列表）</li></ol><p>c) 在nacos配置中心中新建配置，dataId为seataServer.properties，配置内容为上面修改后的config.txt中的配置信息</p><p>从v1.4.2版本开始，seata已支持从一个Nacos dataId中获取所有配置信息,你只需要额外添加一个dataId配置项。</p><p>​ <img src="https://img.jssjqd.cn//202305081720874.png" alt="image-20230508172046979"></p><p>添加后查看：</p><p><img src="https://img.jssjqd.cn//202305081720802.png" alt="image-20230508172050917"></p><p><strong>步骤五：启动Seata Server</strong></p><p>启动命令:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>bin/seata-server.sh              
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>​ <img src="https://note.youdao.com/yws/public/resource/c480b9d259db401acff9fdd30a770d64/xmlnote/3F66707112A3482088AE3909878826CF/54044" alt="0"></p><p>启动成功，查看控制台，账号密码都是seata。http://localhost:7091/#/login</p><p><img src="https://img.jssjqd.cn//202305081721571.png" alt="image-20230508172122611"></p><p>在Nacos注册中心中可以查看到seata-server注册成功</p><p>​ <img src="https://img.jssjqd.cn//202305081721792.png" alt="image-20230508172126820"></p><p>支持的启动参数</p><table><thead><tr><th>参数</th><th>全写</th><th>作用</th><th>备注</th></tr></thead><tbody><tr><td>-h</td><td>--host</td><td>指定在注册中心注册的 IP</td><td>不指定时获取当前的 IP，外部访问部署在云环境和容器中的 server 建议指定</td></tr><tr><td>-p</td><td>--port</td><td>指定 server 启动的端口</td><td>默认为 8091</td></tr><tr><td>-m</td><td>--storeMode</td><td>事务日志存储方式</td><td>支持file,db,redis，默认为 file 注:redis需seata-server 1.3版本及以上</td></tr><tr><td>-n</td><td>--serverNode</td><td>用于指定seata-server节点ID</td><td>如 1,2,3..., 默认为 1</td></tr><tr><td>-e</td><td>--seataEnv</td><td>指定 seata-server 运行环境</td><td>如 dev, test 等, 服务启动时会使用 registry-dev.conf 这样的配置</td></tr></tbody></table><p>比如：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>bin/seata-server.sh <span class="token parameter variable">-p</span> <span class="token number">8091</span> <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-m</span> db              
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="seata-client快速开始" tabindex="-1"><a class="header-anchor" href="#seata-client快速开始"><span>Seata Client快速开始</span></a></h3><p><strong>Spring Cloud Alibaba整合Seata AT模式实战</strong></p><p><strong>业务场景</strong></p><p>用户下单，整个业务逻辑由三个微服务构成：</p><ul><li>库存服务：对给定的商品扣除库存数量。</li><li>订单服务：根据采购需求创建订单。</li><li>帐户服务：从用户帐户中扣除余额。</li></ul><p>​ <img src="https://img.jssjqd.cn//202305081721382.png" alt="image-20230508172144585"></p><p><strong>1) 环境准备</strong></p><ul><li>父pom指定微服务版本</li></ul><table><thead><tr><th>Spring Cloud Alibaba Version</th><th>Spring Cloud Version</th><th>Spring Boot Version</th><th>Seata Version</th></tr></thead><tbody><tr><td>2.2.8.RELEASE</td><td>Spring Cloud Hoxton.SR12</td><td>2.3.12.RELEASE</td><td>1.5.1</td></tr></tbody></table><ul><li>启动Seata Server(TC)端，Seata Server使用nacos作为配置中心和注册中心</li><li>启动nacos服务</li></ul><p><strong>2) 微服务导入seata依赖</strong></p><p>spring-cloud-starter-alibaba-seata内部集成了seata，并实现了xid传递</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- seata--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3)微服务对应数据库中添加undo_log表(仅AT模式)</strong></p><p>https://github.com/seata/seata/blob/v1.5.1/script/client/at/db/mysql.sql</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- for AT mode you must to init this sql for you business database. the seata server not need it.</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>undo_log<span class="token punctuation">`</span></span>
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>     <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;branch transaction id&#39;</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>           <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;global transaction id&#39;</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>context<span class="token punctuation">`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;undo_log context,such as serialization&#39;</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>rollback_info<span class="token punctuation">`</span></span> <span class="token keyword">LONGBLOB</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;rollback info&#39;</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>log_status<span class="token punctuation">`</span></span>    <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;0:normal status,1:defense status&#39;</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>log_created<span class="token punctuation">`</span></span>   <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;create datetime&#39;</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>log_modified<span class="token punctuation">`</span></span>  <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;modify datetime&#39;</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ux_undo_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
  <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COMMENT</span> <span class="token operator">=</span><span class="token string">&#39;AT transaction mode undo table&#39;</span><span class="token punctuation">;</span>   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4) 微服务application.yml中添加seata配置</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">seata</span><span class="token punctuation">:</span>
  <span class="token key atrule">application-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
  <span class="token comment"># seata 服务分组，要与服务端配置service.vgroup_mapping的后缀对应</span>
  <span class="token key atrule">tx-service-group</span><span class="token punctuation">:</span> default_tx_group
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token comment"># 指定nacos作为注册中心</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP

  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token comment"># 指定nacos作为配置中心</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 7e838c12<span class="token punctuation">-</span>8554<span class="token punctuation">-</span>4231<span class="token punctuation">-</span>82d5<span class="token punctuation">-</span>6d93573ddf32
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seataServer.properties           
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：请确保client与server的注册中心和配置中心namespace和group一致</p><p><strong>5） 在全局事务发起者中添加@GlobalTransactional注解</strong></p><p>核心代码</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;createOrder&quot;</span><span class="token punctuation">,</span>rollbackFor<span class="token operator">=</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderVo</span> orderVo<span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;=============用户下单=================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前 XID: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RootContext</span><span class="token punctuation">.</span><span class="token function">getXID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 保存订单</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setCommodityCode</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getCommodityCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">INIT</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Integer</span> saveOrderRecord <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;保存订单{}&quot;</span><span class="token punctuation">,</span> saveOrderRecord <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot;成功&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//扣减库存</span>
    storageFeignService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getCommodityCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>orderVo<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//扣减余额</span>
    accountFeignService<span class="token punctuation">.</span><span class="token function">debit</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>orderVo<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//更新订单</span>
    <span class="token class-name">Integer</span> updateOrderRecord <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;更新订单id:{} {}&quot;</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> updateOrderRecord <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot;成功&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>6）测试分布式事务是否生效</strong></p><ul><li>分布式事务成功，模拟正常下单、扣库存，扣余额</li><li>分布式事务失败，模拟下单扣库存成功、扣余额失败，事务是否回滚</li></ul><p>​ ![<img src="https://img.jssjqd.cn//202305081723206.png" alt="image-20230508172327973">C3D46904C24/54068)</p></div><!--[--><!----><!--]--><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: thejqd@gmail.com">jiangqingdong</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/pages/202308030516/" aria-label="Seata事务模式"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Seata事务模式</div></a><!----></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CT4bPn0M.js" defer></script>
  </body>
</html>
