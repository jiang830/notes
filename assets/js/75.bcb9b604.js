(window.webpackJsonp=window.webpackJsonp||[]).push([[75],{389:function(a,s,e){"use strict";e.r(s);var t=e(7),r=Object(t.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h2",{attrs:{id:"配置证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置证书"}},[a._v("#")]),a._v(" 配置证书")]),a._v(" "),s("h3",{attrs:{id:"创建一个存放证书目录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建一个存放证书目录"}},[a._v("#")]),a._v(" 创建一个存放证书目录")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /usr/local/ca\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /usr/local/ca\n")])])]),s("h3",{attrs:{id:"创建一键生成证书脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建一键生成证书脚本"}},[a._v("#")]),a._v(" 创建一键生成证书脚本")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("vi ca.sh\n")])])]),s("p",[a._v("按 A 按键切换为输入模式，然后把下面代码粘贴上去")]),a._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token shebang important"}},[a._v("#!/bin/bash")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("SERVER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"服务器公网IP"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"密码"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("COUNTRY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"CN"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("STATE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"hangzhou"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("CITY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"hangzhou"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("ORGANIZATION")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"jiangqingdong"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("ORGANIZATIONAL_UNIT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"dev"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("EMAIL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"邮箱"')]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"starting..."')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /usr/local/ca\nopenssl genrsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-aes256")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-passout")]),a._v(" pass:"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$PASSWORD")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" ca-key.pem "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\nopenssl req "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x509")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-passin")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"pass:'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$PASSWORD")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-days")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3650")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-key")]),a._v(" ca-key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-sha256")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" ca.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-subj")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/C='),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$COUNTRY")]),a._v("/ST="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$STATE")]),a._v("/L="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$CITY")]),a._v("/O="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$ORGANIZATION")]),a._v("/OU="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$ORGANIZATIONAL_UNIT")]),a._v("/CN="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$SERVER")]),a._v("/emailAddress="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$EMAIL")]),a._v('"')]),a._v("\nopenssl genrsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" server-key.pem "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\nopenssl req "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-subj")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/CN='),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$SERVER")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-key")]),a._v(" server-key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" server.csr\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'echo \"subjectAltName = IP:'")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$SERVER")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("',IP:0.0.0.0\" >> extfile.cnf'")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'echo \"extendedKeyUsage = serverAuth\" >> extfile.cn'")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'echo \"extendedKeyUsage = serverAuth\" >> extfile.cnf'")]),a._v("\nopenssl x509 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-req")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-days")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3650")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-in")]),a._v(" server.csr "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CA")]),a._v(" ca.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CAkey")]),a._v(" ca-key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-passin")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"pass:'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$PASSWORD")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CAcreateserial")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" server-cert.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-extfile")]),a._v(" extfile.cnf\nopenssl genrsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" key.pem "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\nopenssl req "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-subj")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/CN=client"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-key")]),a._v(" key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" client.csr\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'echo extendedKeyUsage=clientAuth >> extfile-client.cnf'")]),a._v("\nopenssl x509 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-req")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-days")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3650")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-sha256")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-in")]),a._v(" client.csr "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CA")]),a._v(" ca.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CAkey")]),a._v(" ca-key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-passin")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"pass:'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$PASSWORD")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-CAcreateserial")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-out")]),a._v(" cert.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-extfile")]),a._v(" extfile-client.cnf\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" client.csr server.csr\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" server-*.pem  /etc/docker/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" ca.pem /etc/docker/\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"========end========"')]),a._v("\n")])])]),s("h3",{attrs:{id:"保存脚本后执行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#保存脚本后执行"}},[a._v("#")]),a._v(" 保存脚本后执行")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sh")]),a._v(" ca.sh\n")])])]),s("h3",{attrs:{id:"修改docker配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改docker配置"}},[a._v("#")]),a._v(" 修改Docker配置")]),a._v(" "),s("ol",[s("li",[a._v("使 Docker 守护程序仅接收来自提供 CA 信任的证书的客户端的链接")])]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /lib/systemd/system/docker.service\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[a._v("将 ExecStart 属性值进行替换")])]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("ExecStart")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/usr/bin/dockerd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlsverify")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlscacert")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/usr/local/ca/ca.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlscert")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/usr/local/ca/server-cert.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlskey")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/usr/local/ca/server-key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-H")]),a._v(" tcp://0.0.0.0:2375 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-H")]),a._v(" unix:///var/run/docker.sock\n")])])]),s("p",[s("img",{attrs:{src:"https://img.jssjqd.cn/202304041605818.png",alt:"image-20230404160558327"}})]),a._v(" "),s("h3",{attrs:{id:"重载服务并重启docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重载服务并重启docker"}},[a._v("#")]),a._v(" 重载服务并重启docker")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("systemctl daemon-reload "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" systemctl restart "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n")])])]),s("h3",{attrs:{id:"保存证书客户端文件到本地"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#保存证书客户端文件到本地"}},[a._v("#")]),a._v(" 保存证书客户端文件到本地")]),a._v(" "),s("h3",{attrs:{id:"测试证书是否配置成功"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试证书是否配置成功"}},[a._v("#")]),a._v(" 测试证书是否配置成功")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlsverify")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlscacert")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("ca.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlscert")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("cert.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tlskey")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("key.pem "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-H")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("服务器外网ip:2375 version\n")])])]),s("p",[s("img",{attrs:{src:"https://img.jssjqd.cn/202304101618722.png",alt:"image-20230404160756318"}})]),a._v(" "),s("h3",{attrs:{id:"使用idea连接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用idea连接"}},[a._v("#")]),a._v(" 使用idea连接")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.jssjqd.cn/202304101618331.png",alt:"image-20230404160953751"}})]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.jssjqd.cn/202304101618488.png",alt:"image-20230404160939246"}})])])}),[],!1,null,null,null);s.default=r.exports}}]);