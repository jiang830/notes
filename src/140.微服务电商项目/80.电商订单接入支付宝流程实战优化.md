---
title: 电商订单接入支付宝流程实战优化
date: 2023-05-04 07:13:04
categories: 
  - 微服务电商平台
permalink: /pages/64aad3/
author: 
  name: 江
---

当前电商项目中，通过接入支付宝提供了订单在线支付功能，并且后续针对用户下单后的支付流程做了定制化的设计。采用了一套基于RocketMQ事务消息实现的订单确认机制，来完成订单超时回退功能。这一节课主要就是带大家理解电商项目中对于订单支付功能的设计。当然，重点是希望大家能够针对不同的支付场景，尝试进行不同的优化设计。

今天课程的关注点是以下几个问题。

- 了解支付宝支付能力接入方式。项目中主要是通过支付宝的沙箱环境，快速接入支付宝进行订单支付。
- 电商项目如何对支付流程进行设计及优化。

## 支付宝接入流程简介

当今互联网时代，第三方支付已经成了人们不可或缺的一个生活工具，也成为了互联网公司必不可少的业务拼图。但是支付实际上是一个风险非常大的业务，真正能够自主开发第三方支付产品的企业非常少。国内目前有支付牌照的公司总共只有两百来家。因此大部分企业都需要接入第三方支付产品，通过他们形成自己的支付能力。比较有名的第三方支付产品有支付宝、云闪付、和包支付、翼支付等。当前电商项目采用支付宝作为第三方支付产品。这一章节先来了解下如何接入支付宝。

### 支付宝接入哪些应用场景

支付宝提供了两个重要的服务开放平台，对外开放自己的核心支付能力。第三方企业都可以通过这两个服务开放平台接入支付宝，借助支付宝开发自己的支付场景。一个是面向商家的**支付宝商家中心**(https://b.alipay.com/page/portal/home)，另一个是面向开发者的**支付宝开放平台**(https://open.alipay.com/)。当然我们这次更关心的是在技术层面如何快速接入支付宝，所以更关心的是后面的支付宝开放平台，后面简称支付宝平台。

首先可以进入支付宝平台，快速了解一下支付宝有哪些接入方式。

![image.png](https://img.jssjqd.cn//202305040345152.png)

可以看到，当前支付宝的接入场景是非常丰富的。当前电商项目会采用当面付支付场景进行接入。官网上对于当面付有非常多详细的文档(文档地址：https://opendocs.alipay.com/open/194/105072?ref=api)，并且还提供了非常丰富的示例。 当面付有两种的典型的场景，一种是用户出示付款码，商家扫描二维码付款。另一种是购买商品后，商家出示二维码，用户使用支付宝扫描二维码完成付款。

![image.png](https://img.jssjqd.cn//202305040345986.png)

这两种支付场景相信你一定不陌生，或多或少的都应该通过这种模式购买过产品。图灵电商采用的是第二种扫码支付的场景，即用户下单后，图灵电商会在网站上给用户展示一个二维码，然后用户扫码完成支付。有兴趣你可以仔细阅读理解下官方的文档，理解一下在你日常购买过程中，整个数据是如何流转的。

### 了解支付宝沙箱环境与正式环境

如果你仔细看下这个文档，一定会注意到一个章节是计费模式。是的，第三方应用采用这种方式，每一笔交易都是需要付费给支付宝的。这样对于开发很不方便。在支付宝开放平台上，给开发者提供了一个测试用的沙箱环境。https://openhome.alipay.com/develop/sandbox/app。

![image.png](https://img.jssjqd.cn//202305040345164.png)

沙箱环境提供了一系列开发调试所需要的帐号以应用信息，这些测试帐号会定期改变。这里最重要的是PID和APPID两个参数。沙箱环境直接给出了对应的尝试数据，正是环境都需要向支付宝进行申请才能获取。

 其中，PID表示商家账户ID，在正式环境中，需要由商户登录支付宝商家中心后获取。

![image.png](https://img.jssjqd.cn//202305040345108.png)

 而APPID表示在支付宝上注册的第三方应用的ID。需要由开发者创建应用获取。

 开发者登录支付宝开放平台后，进入控制台，需要在控制台创建对应的应用。

![image.png](https://img.jssjqd.cn//202305040345267.png)

创建应用后还不算完，需要商户绑定应用，这样的PID和APPID才可以一起使用。商户登录商家平台后，在账户中心，选择APPID绑定，设置绑定开发者创建的应用。

![image.png](https://img.jssjqd.cn//202305040345545.png)

> 这里省略掉了正式环境各种提交资料，审批的复杂过程。

另外，沙箱环境还提供了一个沙箱版本的支付宝APP，这个在后面电商项目中也是需要用到的，需要大家下载沙箱版支付宝APP并安装到手机当中。下载页面： https://open.alipay.com/develop/sandbox/tool

在页面下方，有个产品列表部分，可以看到，沙箱环境中的商户已经完成了很多重要产品的签约，在正式环境，都是需要单独进行签约的。

> 支付宝的正式环境和沙箱环境的接口并不完全一样。真实应用在沙箱环境调试成功后，并不能保证在正式环境就一定没有问题，还需要迁移到正式环境重新测试验收。

### 当面付应用测试接入支付宝

在支付宝开放平台上，针对各种应用场景提供了非常丰富的SDK工具包以及配套的Demo。这里我们直接提供一个包含了支付宝当面支付和电脑网站支付的Demo案例，节省大家找文档的时间。

> 见测试项目 AlipayDemo

当面付模块只需要启动Main.java即可运行。但是在运行之前，需要调整一些配置配置信息。这些配置信息都在zfbinfo.properties文件中。

![image.png](https://img.jssjqd.cn//202305040345910.png)

> 电脑网站支付的配置信息在com.example.demo.config.AlipayConfig中

- app_id 和 pid属性可以在沙箱应用页面直接获取。
- open_api_domain这个属性是请求网关地址URL，默认是正式环境的网关地址。沙箱环境的网关地址是： https://openapi.alipaydev.com/gateway.do 。 mcloud_api_domain是一个用于统计的网关。
- alipay_public_key是支付宝公钥属性，需要在沙箱应用页面查看。
- private_key和public_key是应用自己设置的私钥。其中，这个密钥需要生成一对公私钥，将应用的公钥上传到支付宝上，而私钥自己保存。

![image.png](https://img.jssjqd.cn//202305040345817.png)

> 支付宝采用的是RSA非对称加密的方式来保证业务请求的安全性，RSA加密方式需要两个成对生成的公私钥，来对报文分别进行加密和解密，其中私钥自己保存，而公钥则分发给对应业务方。通常用于一次请求的加解密过程。而支付宝开放平台采用的是双向非对称加密的安全机制。
>
> 应用注册时，支付宝会生成一组支付宝公私钥，公钥分发给应用，私钥支付宝自己保存。应用往支付宝发起请求时，需要自己获取公钥，用来对发往支付宝的请求报文进行加密。支付宝会尝试使用对应的私钥进行解密，如果解密不成功则会报验签错误的异常，不允许访问服务。
>
> 支付宝在往应用推送业务报文时，同样需要应用自己生成一组应用公私钥，应用自己保存私钥，公钥则上传到支付宝中。支付宝在推送业务报文时，会使用公钥进行加密。应用只有使用对应的私钥解密才能获取到业务数据。这样才能保证业务报文的安全性。

生成密钥时，可以下载支付宝提供的密钥生成工具进行生成。工具下载参见网页： https://opendocs.alipay.com/common/02kipl

 配置修改完成后，需要在MAIN.java中做一下小修改，在他的435行，需要配置一下二维码图片的生成地址，并且把生成二维码的那一行代码解除注释。

```java
// 需要修改为运行机器上的路径
String filePath = String.format("D:/alipay/qr-%s.png", response.getOutTradeNo());
log.info("filePath:" + filePath);
ZxingUtils.getQRCodeImge(response.getQrCode(), 256, filePath);
break;
```

> 保存二维码的目录要提前手动创建。

然后执行MAIN.java。如果参数没有问题，会提示支付宝预下单成功的日志信息。

```shell
19:26:18.367 [main] INFO com.example.f2f.Main - 支付宝预下单成功: )
19:26:18.367 [main] INFO com.example.f2f.Main - code:10000, msg:Success
19:26:18.367 [main] INFO com.example.f2f.Main - body:{"alipay_trade_precreate_response":{"code":"10000","msg":"Success","out_trade_no":"tradeprecreate16632411762145609885","qr_code":"https:\/\/qr.alipay.com\/bax046621l7l0boqqkcf001d"},"sign":"eELa9G0YxKEjMsXiSDSMbFEvBfJuhOwBjTZ239ZdiKfVYkdjmZjCy59iNlBS/b0N+13y1XL3K9yd1En48VFSYk3PJ5aJBoJLheeEB9vAqW1a26L2Gx6AuIeK8A8y2//B4jGUSobjq2X5m1WbbJL2zgLDjnaS9bvWW3mzEXg2A2OL/fo+L0l8pM8lGrVifxiPTQ1hPu1i+eYrIz3/nIVjQWlWIGalNKAjA9Nckt9vKbk8Cd1pWpNtj63Y1alp3b08KG7qph1risUQcu0bdZ0FZryLpAHK6sazIlZZtWSG10p0yR7yoZQGjuNtMZEj5Uv0/tTORN9/ylNtnR2tAKqghQ=="}
19:26:18.367 [main] INFO com.example.f2f.Main - filePath:D:/alipay/qr-tradeprecreate16632411762145609885.png
```

然后在配置的目录中可以看到生成的二维码图片。

![image.png](https://img.jssjqd.cn//202305040345032.png)

在做实际应用集成时，这个二维码图片就可以展示到应用的前端页面上，然后给客户扫描支付。需要注意的是，这个二维码图片是对接支付宝沙箱环境生成的，那么扫描时也必须用沙箱环境的支付宝APP扫码支付。

> 在示例中还有其他的一些业务操作，比如查询、退货等，可以自行体验。

测试的结果可以到沙箱环境查看买家和卖家的余额变化，确认交易是否正常完成。

![image.png](https://img.jssjqd.cn//202305040345133.png)

## 电商项目优化订单支付流程

### 梳理支付宝当面付的预下单流程

在熟悉了支付宝的接入方式之后，再来思考在电商场景下，要如何接入支付宝来提供订单支付功能。结合图灵电商的业务场景，自然能够想到这样的接入流程：

![image.png](https://img.jssjqd.cn//202305040345490.png)

 1、用户在图灵电商上选好商品，从购物车开始选择下单。

 2、图灵电商记录用户的订单数据后，会往支付宝进行一次预下单，可以理解为申请一个支付订单。

 3、如果预下单没有问题的话，支付宝会给图灵电商同步返回一个二维码图片。

 4、图灵电商将二维码图片保存到本地服务器上，并与自己的业务订单建立绑定关系。

 5、图灵电商将二维码图片展现给用户，用户使用自己的支付宝扫描二维码，完成登录、支付的一系列操作。

 6、支付完成后，支付宝会给图灵电商发送一个异步通知，告知订单支付完成。图灵电商接收到这个通知，就可以完成订单后续的业务操作。

主流程是没有什么问题，基本上就照搬刚才的流程就可以了。但是，就按照这个流程实现订单管理，你会发现有个小问题，对于流程图下方的订单取消操作还没有进行设计。而实际上，图灵电商项目跟网上其他的电商项目都是一样，用户下完订单后是需要及时进行支付的。电商项目在用户下单时就需要锁定商品库存，如果用户长期不支付，锁定的商品就无法正常销售。

所以，通常对于订单都会设定一个支付时间，比如五分钟内需要完成支付。如果没有支付，就需要取消订单，释放库存。那应该如何设计订单的超时判断流程？

### 使用延迟任务实现支付超时判断

有朋友说，那简单，做个定时任务，五分钟后去支付宝查一下订单是否完成了支付。

![image.png](https://img.jssjqd.cn//202305040345396.png)

 1、下单时增加一个定时任务，在五分钟后对订单进行超时判断。

 2、超时判断时，可以先去支付宝上查询订单支付状态。

如果已支付，则判断订单是否正常结束，这是因为在用户完成扫码支付后，支付宝正常会往图灵电商发送支付成功的通知。但是这个通知是没有事务保证的，所以是非常有可能失败的，这时就需要在订单超时判断时对状态进行对齐。

如果未支付，则需要释放库存，取消本地订单，然后通知支付宝取消支付订单。

这种设计方式很自然。但是会有一个小问题，就是对订单状态的判断会不及时。订单支付状态只有在五分钟后的超时判断时才能最终确定，这就不太及时。这样对于一些并发量比较高的场景就不太合适。比如在12306抢火车票，是不是你一支付完成，12306马上就知道了？就给你发火车票了？或者你回顾一下日常使用支付宝进行支付的场景，是不是你一支付，商家马上就知道了？更别说对于秒杀等超高并发的场景了。

那要如何优化呢？通常企业中的做法并不会等到订单超时时才去查询订单状态，而是在后台会多次频繁查询支付宝支付状态，这样可以更及时的获得支付结果。例如五分钟超时时间，至少需要半分钟或者一分钟去查一次支付宝订单状态，如果支付成功了，就及时结束后续等待处理过程。如果没有完成支付，就再开启下一个定时任务，等待下次检查。

这样一分析，你会不会觉得这个定时任务光是流程控制就有点麻烦了？再跟业务逻辑绑定在一起，这个任务的逻辑会变得非常复杂。有没有现成的框架可以帮我们来优化这个复杂的定时任务逻辑，让我们只要专心关注业务逻辑呢？有，RocketMQ的事务消息就是一个比较好的工具。

### 用RocketMQ事务消息改造支付超时判断流程。

RocketMQ的事务消息机制在VIP课程中做过详细讲解，很多同学表示流程大概懂，但是不知道具体怎么用。RocketMQ事务消息机制的核心是对消息状态进行不断的确认。循环确认的过程就正好可以用来改造，解决上面说的频繁任务调度的问题。这样就可以专注于开发业务逻辑，而不用关注频繁复杂的任务调度逻辑。

![image.png](https://img.jssjqd.cn//202305040345349.png)

在图灵电商项目中，是在向支付宝进行预下单时，发送一条事务消息。只不过这里发送的消息，是用来通知下游服务进行本地订单取消的。

下面结合项目代码进行流程分解

核心代码流程：

1、支付宝预下单时发送事务消息。 OmsPortalOrderController#tradeQrCode： 使用orderMessageSender.sendCreateOrderMsg(orderId,memberId); 发送消息，这个消息实际上是用来通知下游服务进行订单取消的。

2、发送消息后，就会先执行本地事务。 TransactionListenerImpl#executeLocalTransaction方法。在这个方法中会将订单ID放到Redis中，这样可以在后续进行支付状态检查时，快速找到对应的业务信息。只要下单成功，就会返回UNKOWN状态，这样RocketMQ会在之后进行状态回查。

3、然后在事务状态回查时，会执行 TransactionListenerImpl#checkLocalTransaction方法。在这个方法里会自行记录回查次数，超过最大次数就直接取消订单。`注意，这里最大回查次数需要根据业务要求进行定制。`

如果没有超过最大次数，就可以去支付宝中查询订单支付状态。

如果已经支付完成，则返回ROLLBACK状态，消息取消，后续就不会再进行本地订单取消了。

如果未支付，则记录回查次数后，返回UNKNOWN状态，等待下次回查。

4、如果事务消息最终发送出去，也就是订单已经超时，就会将消息发送到RocketMQ的${rocketmq.tulingmall.asyncOrderTopic}这个Topic下。下游的消费者RocketMqCancelOrderReciever就会完成取消本地订单，释放库存等操作。

> 补充一个小知识点，RocketMQ的事务消息回查间隔可以通过参数 transactionCheckInterval 定制

 在这个流程中，表面上利用RocketMQ的事务消息机制将频繁的定时任务拆解成事务回查的过程，实际上是通过不断的事务回查来确保分布式事务的最终一致性。

**这里要加一个设计点，在下单时要加一个分布式锁(可以用redis实现)，后续取消订单时需要能拿到锁(redis中的锁过期了)才能取消。防止并发？？诸葛老师的公开课中讲了这个设计点。**

**流程扩展**：

当前图灵电商的实现流程，实际上就是一个基础，在面临更多更复杂的业务场景时，还需要对业务层面的细节问题进行详细设计。例如：

**1、通过聚合支付进行分布式事务控制**：当前图灵电商项目，只完成了与支付宝的对接，而在对接过程中，是直接使用支付宝的二维码通知用户进行当面支付。而用户使用支付宝扫码支付的过程，图灵电商都是完全不知道的，也就没有办法对用户的支付动作进行控制。比如如果图灵电商本地的订单已经超时，就要阻止用户进行扫码支付。当前项目的处理方式是在支付宝的回调接口判断订单状态，如果订单式已关闭，则发起订单回退。这样显然效率是不高的。

在很多电商项目中，会采用聚合支付的方式，统一对接多个第三方支付方。用户的支付动作就不是直接与支付宝这样的第三方支付公司交互完成，而是要经过电商后台转发请求完成。这时，就可以通过添加一些分布式锁机制，保证整个支付业务是串行执行的，以防止在电商进行订单超时回退后，用户再次扫码支付。

**2、正向通知与反向通知：** 当前图灵电商项目中，是通过事务消息通知下游服务订单取消，这其实就是一种反向通知的方式。但是其实最直观的方式还是使用正向通知，即通过事务消息通知下游服务进行订单支付确认，这样这个下单的消息就容易扩展更多的下游消费者。结合图灵电商，订单下单确认是用户完成支付后，支付宝发起的通知来确认的。这时，如果订单确认的下游服务实现了幂等控制，就完全可以将事务消息机制改为正向通知。即在事务消息回查过程中，确认用户已经完成了支付，就发送消息通知下游服务订单支付成功。这样也可以防止支付宝通知丢失造成的订单状态缺失。

而用户订单超时判断，则可以在事务消息的checkLocalTransaction状态回查过程中，通过记录回查次数判断。如果已经超时，则返回Rollback。同时启动另外一个消息生产者，往下游服务发送一个订单取消的消息，这样也是可以的。

**3、兜底补偿机制：** 例如在当前图灵电商项目中，对于订单超时后的回退处理，不光通过RocketMQ的事务消息进行了通知，另外也部署了一个定时任务，批量回退超时的订单。

```java
/**
 * 订单超时取消并解锁库存的定时器
 */
@Component
public class OrderTimeOutCancelTask {
  private Logger LOGGER =LoggerFactory.getLogger(OrderTimeOutCancelTask.class);
    @Autowired
    private OmsPortalOrderService portalOrderService;

    /**
     * cron表达式：Seconds Minutes Hours DayofMonth Month DayofWeek [Year]
     * 每10分钟扫描一次，扫描设定超时时间之前下的订单，如果没支付则取消该订单
     */
    @Scheduled(cron = "0 0/10 * ? * ?")
    private void cancelTimeOutOrder(){
        CommonResult result = portalOrderService.cancelTimeOutOrder();
        LOGGER.info("取消订单，并根据sku编号释放锁定库存:{}",result);
    }
}
```

在这个任务中，会以十分钟为间隔，对超过超时时间未支付的订单进行统一的撤回操作。这其实就是一种事务消息的兜底补偿机制，以处理那些事务消息机制有可能漏处理的超时订单。在设计金融相关业务时，这种兜底策略会显得尤为重要。
