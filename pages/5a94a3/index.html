<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ElasticSearch 高级查询语法Query DSL实战 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="个人技术博客,技术文档,学习,面试,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.05e4719f.css" as="style"><link rel="preload" href="/assets/js/app.a2127b69.js" as="script"><link rel="preload" href="/assets/js/2.8795ec35.js" as="script"><link rel="preload" href="/assets/js/91.a3a69724.js" as="script"><link rel="prefetch" href="/assets/js/10.a044793b.js"><link rel="prefetch" href="/assets/js/100.395bca2c.js"><link rel="prefetch" href="/assets/js/101.a3e4de38.js"><link rel="prefetch" href="/assets/js/102.fa4ed05d.js"><link rel="prefetch" href="/assets/js/103.dc6c5d69.js"><link rel="prefetch" href="/assets/js/104.75586808.js"><link rel="prefetch" href="/assets/js/105.511d296d.js"><link rel="prefetch" href="/assets/js/106.afb96620.js"><link rel="prefetch" href="/assets/js/107.1ffa920f.js"><link rel="prefetch" href="/assets/js/108.259eff2f.js"><link rel="prefetch" href="/assets/js/109.72f70ea4.js"><link rel="prefetch" href="/assets/js/11.5e7d0c95.js"><link rel="prefetch" href="/assets/js/110.cf6cc100.js"><link rel="prefetch" href="/assets/js/111.b94b04c5.js"><link rel="prefetch" href="/assets/js/112.dce94b67.js"><link rel="prefetch" href="/assets/js/113.f1e769de.js"><link rel="prefetch" href="/assets/js/114.660b6b09.js"><link rel="prefetch" href="/assets/js/12.e841c0c3.js"><link rel="prefetch" href="/assets/js/13.41a2fb93.js"><link rel="prefetch" href="/assets/js/14.e2a3317c.js"><link rel="prefetch" href="/assets/js/15.a81a6ef1.js"><link rel="prefetch" href="/assets/js/16.7b69e07f.js"><link rel="prefetch" href="/assets/js/17.777b188a.js"><link rel="prefetch" href="/assets/js/18.c81cf408.js"><link rel="prefetch" href="/assets/js/19.a59301e0.js"><link rel="prefetch" href="/assets/js/20.18827160.js"><link rel="prefetch" href="/assets/js/21.8d5d511f.js"><link rel="prefetch" href="/assets/js/22.a8ac93a6.js"><link rel="prefetch" href="/assets/js/23.1bbe4807.js"><link rel="prefetch" href="/assets/js/24.00525e76.js"><link rel="prefetch" href="/assets/js/25.3c90e0a0.js"><link rel="prefetch" href="/assets/js/26.c93f745b.js"><link rel="prefetch" href="/assets/js/27.01181006.js"><link rel="prefetch" href="/assets/js/28.93af4585.js"><link rel="prefetch" href="/assets/js/29.a0806690.js"><link rel="prefetch" href="/assets/js/3.7b0b8907.js"><link rel="prefetch" href="/assets/js/30.3beac9a7.js"><link rel="prefetch" href="/assets/js/31.3ee788ac.js"><link rel="prefetch" href="/assets/js/32.6522140e.js"><link rel="prefetch" href="/assets/js/33.24b1949c.js"><link rel="prefetch" href="/assets/js/34.90e39367.js"><link rel="prefetch" href="/assets/js/35.a67486b8.js"><link rel="prefetch" href="/assets/js/36.d9ffefc3.js"><link rel="prefetch" href="/assets/js/37.e3a99db4.js"><link rel="prefetch" href="/assets/js/38.8e250355.js"><link rel="prefetch" href="/assets/js/39.fc7bdfc1.js"><link rel="prefetch" href="/assets/js/4.9805163b.js"><link rel="prefetch" href="/assets/js/40.454bd56a.js"><link rel="prefetch" href="/assets/js/41.a235b641.js"><link rel="prefetch" href="/assets/js/42.af91ee0f.js"><link rel="prefetch" href="/assets/js/43.ee9374e7.js"><link rel="prefetch" href="/assets/js/44.36c8feb3.js"><link rel="prefetch" href="/assets/js/45.d8301c73.js"><link rel="prefetch" href="/assets/js/46.9a5a32af.js"><link rel="prefetch" href="/assets/js/47.d58b6a64.js"><link rel="prefetch" href="/assets/js/48.f02903e0.js"><link rel="prefetch" href="/assets/js/49.19767842.js"><link rel="prefetch" href="/assets/js/5.c3d6e4f2.js"><link rel="prefetch" href="/assets/js/50.48750e81.js"><link rel="prefetch" href="/assets/js/51.c4254bbf.js"><link rel="prefetch" href="/assets/js/52.b343e884.js"><link rel="prefetch" href="/assets/js/53.98458ade.js"><link rel="prefetch" href="/assets/js/54.fde5639b.js"><link rel="prefetch" href="/assets/js/55.1d6eee4b.js"><link rel="prefetch" href="/assets/js/56.b00d9d45.js"><link rel="prefetch" href="/assets/js/57.eaec60f9.js"><link rel="prefetch" href="/assets/js/58.4b703868.js"><link rel="prefetch" href="/assets/js/59.26a30b6e.js"><link rel="prefetch" href="/assets/js/6.c77dab88.js"><link rel="prefetch" href="/assets/js/60.eb33df05.js"><link rel="prefetch" href="/assets/js/61.d173fa46.js"><link rel="prefetch" href="/assets/js/62.429026f8.js"><link rel="prefetch" href="/assets/js/63.b58a3d49.js"><link rel="prefetch" href="/assets/js/64.99d18334.js"><link rel="prefetch" href="/assets/js/65.cce9fdce.js"><link rel="prefetch" href="/assets/js/66.2fe5a7ce.js"><link rel="prefetch" href="/assets/js/67.fa40b952.js"><link rel="prefetch" href="/assets/js/68.83533afe.js"><link rel="prefetch" href="/assets/js/69.699a59ea.js"><link rel="prefetch" href="/assets/js/7.76f628a5.js"><link rel="prefetch" href="/assets/js/70.576468eb.js"><link rel="prefetch" href="/assets/js/71.d479c994.js"><link rel="prefetch" href="/assets/js/72.b6d86aab.js"><link rel="prefetch" href="/assets/js/73.d835d9fc.js"><link rel="prefetch" href="/assets/js/74.d0c0c961.js"><link rel="prefetch" href="/assets/js/75.c0fb32d8.js"><link rel="prefetch" href="/assets/js/76.b98fe8df.js"><link rel="prefetch" href="/assets/js/77.506c158d.js"><link rel="prefetch" href="/assets/js/78.4bd2d644.js"><link rel="prefetch" href="/assets/js/79.35030393.js"><link rel="prefetch" href="/assets/js/8.d2e1201f.js"><link rel="prefetch" href="/assets/js/80.93dec784.js"><link rel="prefetch" href="/assets/js/81.f5092f98.js"><link rel="prefetch" href="/assets/js/82.ca631d56.js"><link rel="prefetch" href="/assets/js/83.1da51aad.js"><link rel="prefetch" href="/assets/js/84.8a1de17c.js"><link rel="prefetch" href="/assets/js/85.b00ba373.js"><link rel="prefetch" href="/assets/js/86.f0ea7c85.js"><link rel="prefetch" href="/assets/js/87.afaa6182.js"><link rel="prefetch" href="/assets/js/88.5ea4d29d.js"><link rel="prefetch" href="/assets/js/89.5dc353d7.js"><link rel="prefetch" href="/assets/js/9.2821f128.js"><link rel="prefetch" href="/assets/js/90.fbfb0b00.js"><link rel="prefetch" href="/assets/js/92.b5de1c97.js"><link rel="prefetch" href="/assets/js/93.251d9171.js"><link rel="prefetch" href="/assets/js/94.f187e4e0.js"><link rel="prefetch" href="/assets/js/95.6fd0a296.js"><link rel="prefetch" href="/assets/js/96.66099a7e.js"><link rel="prefetch" href="/assets/js/97.15b4ddfe.js"><link rel="prefetch" href="/assets/js/98.3169dd1c.js"><link rel="prefetch" href="/assets/js/99.ac7be4e1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.05e4719f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="学习笔记" class="logo"> <span class="site-name can-hide">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://img.jssjqd.cn/202303140455599.jpg"> <div class="blogger-info"><h3>江</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/8c5c4e/" class="sidebar-link">ElasticSearch快速入门实战</a></li><li><a href="/pages/5a94a3/" aria-current="page" class="active sidebar-link">ElasticSearch 高级查询语法Query DSL实战</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=ElasticSearch" title="分类" data-v-06225672>ElasticSearch</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>江</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-12-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><!----> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">ElasticSearch 高级查询语法Query DSL实战<!----></h1>  <div class="theme-vdoing-content content__default"><p>ES的Query DSL查询语法很多，如何选择合适的语法，需要理解以下几点：</p> <ul><li>需求： 精确值还是全文？</li> <li>分词器会影响查询结果，不同的字段可以指定不同的分词器</li> <li>Elasticsearch 默认会以文档的相关度算分进行排序</li></ul> <p>ES版本: v7.17.3</p> <p><strong>ES倒排索引</strong></p> <p>当数据写入 ES 时，数据将会通过 分词 被切分为不同的 term，ES 将 term 与其对应的文档列表建立一种映射关系，这种结构就是 倒排索引。如下图所示：</p> <p><img src="https://img.jssjqd.cn/202212112140069.png" alt="image-20221211214032371"></p> <p>为了进一步提升索引的效率，ES 在 term 的基础上利用 term 的前缀或者后缀构建了 term index, 用于对 term 本身进行索引，ES 实际的索引结构如下图所示：</p> <p><img src="https://img.jssjqd.cn/202212112140018.png" alt="image-20221211214046019"></p> <p>这样当我们去搜索某个关键词时，ES 首先根据它的前缀或者后缀迅速缩小关键词的在 term dictionary 中的范围，大大减少了磁盘IO的次数。</p> <ul><li><p>单词词典（Term Dictionary) ：记录所有文档的单词，记录单词到倒排列表的关联关系</p></li> <li><ul><li>常用字典数据结构：https://www.cnblogs.com/LBSer/p/4119841.html</li></ul></li> <li><p>倒排列表(Posting List)-记录了单词对应的文档结合，由倒排索引项组成</p></li> <li><p>倒排索引项(Posting)：</p></li> <li><ul><li>文档ID</li> <li>词频TF–该单词在文档中出现的次数，用于相关性评分</li> <li>位置(Position)-单词在文档中分词的位置。用于短语搜索（match phrase query)</li> <li>偏移(Offset)-记录单词的开始结束位置，实现高亮显示</li></ul></li></ul> <p><img src="https://img.jssjqd.cn/202212112140992.png" alt="image-20221211214055984"></p> <p>Elasticsearch 的JSON文档中的每个字段，都有自己的倒排索引。</p> <p>可以指定对某些字段不做索引：</p> <ul><li>优点︰节省存储空间</li> <li>缺点: 字段无法被搜索</li></ul> <p><strong>文档映射Mapping</strong></p> <p>Mapping类似数据库中的schema的定义，作用如下：</p> <ul><li>定义索引中的字段的名称</li> <li>定义字段的数据类型，例如字符串，数字，布尔等</li> <li>字段，倒排索引的相关配置(Analyzer)</li></ul> <p>ES中Mapping映射可以分为动态映射和静态映射。</p> <p><strong>动态映射：</strong></p> <p>在关系数据库中，需要事先创建数据库，然后在该数据库下创建数据表，并创建表字段、类型、长度、主键等，最后才能基于表插入数据。而Elasticsearch中不需要定义Mapping映射（即关系型数据库的表、字段等），在文档写入Elasticsearch时，会根据文档字段自动识别类型，这种机制称之为动态映射。</p> <p><strong>静态映射：</strong></p> <p>静态映射是在Elasticsearch中也可以事先定义好映射，包含文档的各字段类型、分词器等，这种方式称之为静态映射。</p> <p>动态映射（Dynamic Mapping）的机制，使得我们无需手动定义Mappings，Elasticsearch会自动根据文档信息，推算出字段的类型。但是有时候会推算的不对，例如地理位置信息。当类型如果设置不对时，会导致一些功能无法正常运行，例如Range查询</p> <p><strong>Dynamic Mapping类型自动识别：</strong></p> <p><img src="https://img.jssjqd.cn/202212112145581.png" alt="image-20221211214542690"></p> <p>示例</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#删除原索引</span>
DELETE /user

<span class="token comment">#创建文档(ES根据数据类型, 会自动创建映射)</span>
PUT /user/_doc/1
<span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;fox&quot;</span>,
  <span class="token string">&quot;age&quot;</span>:32,
  <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;长沙麓谷&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">#获取文档映射</span>
GET /user/_mapping
</code></pre></div><p><img src="https://img.jssjqd.cn/202212112226924.png" alt="image-20221211222616582"></p> <p>思考：能否后期更改Mapping的字段类型？</p> <p>两种情况：</p> <ul><li><p><strong>新增加字段</strong></p></li> <li><ul><li>dynamic设为true时，一旦有新增字段的文档写入，Mapping 也同时被更新</li> <li>dynamic设为false，Mapping 不会被更新，新增字段的数据无法被索引，但是信息会出现在_source中</li> <li>dynamic设置成strict(严格控制策略)，文档写入失败，抛出异常</li></ul></li></ul> <table><thead><tr><th></th> <th>true</th> <th>false</th> <th>strict</th></tr></thead> <tbody><tr><td>文档可索引</td> <td>yes</td> <td>yes</td> <td>no</td></tr> <tr><td>字段可索引</td> <td>yes</td> <td>no</td> <td>no</td></tr> <tr><td>Mapping被更新</td> <td>yes</td> <td>no</td> <td>no</td></tr></tbody></table> <ul><li><p><strong>对已有字段，一旦已经有数据写入，就不再支持修改字段定义</strong></p></li> <li><ul><li>Lucene 实现的倒排索引，一旦生成后，就不允许修改</li> <li>如果希望改变字段类型，可以利用 reindex API，重建索引</li></ul></li></ul> <p>原因：</p> <ul><li>如果修改了字段的数据类型，会导致已被索引的数据无法被搜索</li> <li>但是如果是增加新的字段，就不会有这样的影响</li></ul> <p>测试</p> <div class="language-shell extra-class"><pre class="language-shell"><code>PUT /user
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;dynamic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;strict&quot;</span>,
    <span class="token string">&quot;properties&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;object&quot;</span>,
        <span class="token string">&quot;dynamic&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># 插入文档报错，原因为age为新增字段,会抛出异常</span>
PUT /user/_doc/1
<span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;fox&quot;</span>,
  <span class="token string">&quot;age&quot;</span>:32,
  <span class="token string">&quot;address&quot;</span>:<span class="token punctuation">{</span>
    <span class="token string">&quot;province&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;湖南&quot;</span>,
    <span class="token string">&quot;city&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;长沙&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre></div><p>dynamic设置成strict，新增age字段导致文档插入失败</p> <p><img src="https://img.jssjqd.cn/202212112227471.png" alt="image-20221211222659393"></p> <p>修改dynamic后再次插入文档成功</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#修改daynamic</span>
PUT /user/_mapping
<span class="token punctuation">{</span>
  <span class="token string">&quot;dynamic&quot;</span>:true
<span class="token punctuation">}</span>  
</code></pre></div><p><strong>对已有字段的mapping修改</strong></p> <p>具体方法：</p> <p>1）如果要推倒现有的映射, 你得重新建立一个静态索引</p> <p>2）然后把之前索引里的数据导入到新的索引里</p> <p>3）删除原创建的索引</p> <p>4）为新索引起个别名, 为原索引名</p> <div class="language-shell extra-class"><pre class="language-shell"><code>PUT /user2
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;properties&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>,
        <span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

POST _reindex
<span class="token punctuation">{</span>
<span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
<span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;user&quot;</span>
<span class="token punctuation">}</span>,
<span class="token string">&quot;dest&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
<span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;user2&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

DELETE /user

PUT /user2/_alias/user

GET /user
</code></pre></div><p>​</p> <p>注意: 通过这几个步骤就实现了索引的平滑过渡,并且是零停机</p> <p><strong>常用Mapping参数配置</strong></p> <ul><li>index: 控制当前字段是否被索引，默认为true。如果设置为false，该字段不可被搜索</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>DELETE /user
PUT /user
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;properties&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>,
          <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /user/_doc/1
<span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;fox&quot;</span>,
  <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;广州白云山公园&quot;</span>,
  <span class="token string">&quot;age&quot;</span>:30
<span class="token punctuation">}</span>

GET /user

GET /user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://img.jssjqd.cn/202212112246910.png" alt="image-20221211224601650"></p> <ul><li><p>有四种不同基本的index options配置，控制倒排索引记录的内容：</p></li> <li><ul><li>docs :  记录doc id</li> <li>freqs：记录doc id 和term frequencies（词频）</li> <li>positions: 记录doc id / term frequencies / term position</li> <li>offsets:  doc id / term frequencies / term posistion / character offsets</li></ul></li></ul> <p>text类型默认记录postions，其他默认为 docs。记录内容越多，占用存储空间越大</p> <div class="language-shell extra-class"><pre class="language-shell"><code>DELETE /user
PUT /user
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;properties&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>,
          <span class="token string">&quot;index_options&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;offsets&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><ul><li>null_value: 需要对Null值进行搜索，只有keyword类型支持设计Null_Value</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>DELETE /user
PUT /user
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;properties&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>,
          <span class="token string">&quot;null_value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;NULL&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /user/_doc/1
<span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;fox&quot;</span>,
  <span class="token string">&quot;age&quot;</span>:32,
  <span class="token string">&quot;address&quot;</span>:null
<span class="token punctuation">}</span>

GET /user/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;NULL&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
   
</code></pre></div><p><img src="https://img.jssjqd.cn/202212112254741.png" alt="image-20221211225411837"></p> <ul><li>copy_to设置：将字段的数值拷贝到目标字段，满足一些特定的搜索需求。copy_to的目标字段不出现在_source中。</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 设置copy_to</span>
DELETE /address
PUT /address
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;properties&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;province&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>,
          <span class="token string">&quot;copy_to&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;full_address&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;city&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>,
          <span class="token string">&quot;copy_to&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;full_address&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;settings&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;index&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;analysis.analyzer.default.type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /address/_bulk
<span class="token punctuation">{</span> <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;province&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;湖南&quot;</span>,<span class="token string">&quot;city&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;长沙&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;province&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;湖南&quot;</span>,<span class="token string">&quot;city&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;常德&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;province&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广东&quot;</span>,<span class="token string">&quot;city&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;province&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;湖南&quot;</span>,<span class="token string">&quot;city&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;邵阳&quot;</span><span class="token punctuation">}</span>

GET /address/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;full_address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;湖南常德&quot;</span>,
        <span class="token string">&quot;operator&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;and&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre></div><p><strong>Index Template</strong></p> <p>Index Templates可以帮助你设定Mappings和Settings，并按照一定的规则，自动匹配到新创建的索引之上</p> <ul><li>模版仅在一个索引被新创建时，才会产生作用。修改模版不会影响已创建的索引</li> <li>你可以设定多个索引模版，这些设置会被“merge”在一起</li> <li>你可以指定“order”的数值，控制“merging”的过程</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>PUT /_template/template_default
<span class="token punctuation">{</span>
  <span class="token string">&quot;index_patterns&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;order&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">&quot;version&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
  <span class="token string">&quot;settings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;number_of_shards&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">&quot;number_of_replicas&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


PUT /_template/template_test
<span class="token punctuation">{</span>
  <span class="token string">&quot;index_patterns&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;test*&quot;</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;order&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
  <span class="token string">&quot;settings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;number_of_shards&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
    <span class="token string">&quot;number_of_replicas&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;mappings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;date_detection&quot;</span><span class="token builtin class-name">:</span> false,
    <span class="token string">&quot;numeric_detection&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre></div><p><strong>lndex Template的工作方式</strong></p> <p>当一个索引被新创建时：</p> <ul><li>应用Elasticsearch 默认的settings 和mappings</li> <li>应用order数值低的lndex Template 中的设定</li> <li>应用order高的 Index Template 中的设定，之前的设定会被覆盖</li> <li>应用创建索引时，用户所指定的Settings和 Mappings，并覆盖之前模版中的设定</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#查看template信息</span>
GET /_template/template_default
GET /_template/temp*

PUT /testtemplate/_doc/1
<span class="token punctuation">{</span>
  <span class="token string">&quot;orderNo&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
  <span class="token string">&quot;createDate&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2022/01/01&quot;</span>
<span class="token punctuation">}</span>
GET /testtemplate/_mapping
GET /testtemplate/_settings

PUT /testmy
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;date_detection&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /testmy/_doc/1
<span class="token punctuation">{</span>
  <span class="token string">&quot;orderNo&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
  <span class="token string">&quot;createDate&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2022/01/01&quot;</span>
<span class="token punctuation">}</span>

GET /testmy/_mapping     
</code></pre></div><p><strong>Dynamic Template</strong></p> <p>Dynamic Tempate定义在某个索引的Mapping中。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#Dynaminc Mapping 根据类型和字段名</span>
DELETE my_index
PUT my_index/_doc/1
<span class="token punctuation">{</span>
  <span class="token string">&quot;firstName&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Ruan&quot;</span>,
  <span class="token string">&quot;isVIP&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span>
<span class="token punctuation">}</span>

GET my_index/_mapping
DELETE my_index
PUT my_index
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;dynamic_templates&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
        <span class="token string">&quot;strings_as_boolean&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;match_mapping_type&quot;</span><span class="token builtin class-name">:</span>   <span class="token string">&quot;string&quot;</span>,
          <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;is*&quot;</span>,
          <span class="token string">&quot;mapping&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;boolean&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>
        <span class="token string">&quot;strings_as_keywords&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;match_mapping_type&quot;</span><span class="token builtin class-name">:</span>   <span class="token string">&quot;string&quot;</span>,
          <span class="token string">&quot;mapping&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">#结合路径</span>
PUT /my_test_index
<span class="token punctuation">{</span>
  <span class="token string">&quot;mappings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;dynamic_templates&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string">&quot;full_name&quot;</span>:<span class="token punctuation">{</span>
          <span class="token string">&quot;path_match&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;name.*&quot;</span>,
          <span class="token string">&quot;path_unmatch&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*.middle&quot;</span>,
          <span class="token string">&quot;mapping&quot;</span>:<span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>,
            <span class="token string">&quot;copy_to&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;full_name&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /my_test_index/_doc/1
<span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span>:<span class="token punctuation">{</span>
    <span class="token string">&quot;first&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;John&quot;</span>,
    <span class="token string">&quot;middle&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Winston&quot;</span>,
    <span class="token string">&quot;last&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Lennon&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


GET /my_test_index/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;full_name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;John&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>     
</code></pre></div><p><strong>ES高级查询Query DSL</strong></p> <p>ES中提供了一种强大的检索数据方式,这种检索方式称之为Query DSL（Domain Specified Language） , Query DSL是利用Rest API传递JSON格式的请求体(RequestBody)数据与ES进行交互，这种方式的丰富查询语法让ES检索变得更强大，更简洁。</p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html" target="_blank" rel="noopener noreferrer"> https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>语法:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_doc/_search <span class="token punctuation">{</span>json请求体数据<span class="token punctuation">}</span>
可以简化为下面写法
GET /es_db/_search <span class="token punctuation">{</span>json请求体数据<span class="token punctuation">}</span>
</code></pre></div><p>示例</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#无条件查询，默认返回10条数据</span>
GET /es_db/_search
<span class="token punctuation">{</span>
<span class="token string">&quot;query&quot;</span>:<span class="token punctuation">{</span>
<span class="token string">&quot;match_all&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://img.jssjqd.cn/202212112306193.png" alt="image-20221211230646000"></p> <p>示例数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#指定ik分词器</span>
PUT /es_db
<span class="token punctuation">{</span>
  <span class="token string">&quot;settings&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;index&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;analysis.analyzer.default.type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 创建文档,指定id</span>
PUT /es_db/_doc/1
<span class="token punctuation">{</span>
<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>,
<span class="token string">&quot;sex&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">25</span>,
<span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州天河公园&quot;</span>,
<span class="token string">&quot;remark&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;java developer&quot;</span>
<span class="token punctuation">}</span>
PUT /es_db/_doc/2
<span class="token punctuation">{</span>
<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>,
<span class="token string">&quot;sex&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">28</span>,
<span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州荔湾大厦&quot;</span>,
<span class="token string">&quot;remark&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;java assistant&quot;</span>
<span class="token punctuation">}</span>

PUT /es_db/_doc/3
<span class="token punctuation">{</span>
<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;王五&quot;</span>,
<span class="token string">&quot;sex&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">26</span>,
<span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州白云山公园&quot;</span>,
<span class="token string">&quot;remark&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;php developer&quot;</span>
<span class="token punctuation">}</span>

PUT /es_db/_doc/4
<span class="token punctuation">{</span>
<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;赵六&quot;</span>,
<span class="token string">&quot;sex&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">22</span>,
<span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;长沙橘子洲&quot;</span>,
<span class="token string">&quot;remark&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;python assistant&quot;</span>
<span class="token punctuation">}</span>

PUT /es_db/_doc/5
<span class="token punctuation">{</span>
<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;张龙&quot;</span>,
<span class="token string">&quot;sex&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">19</span>,
<span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;长沙麓谷企业广场&quot;</span>,
<span class="token string">&quot;remark&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;java architect assistant&quot;</span>
<span class="token punctuation">}</span>	
	
PUT /es_db/_doc/6
<span class="token punctuation">{</span>
<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;赵虎&quot;</span>,
<span class="token string">&quot;sex&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
<span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">32</span>,
<span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;长沙麓谷兴工国际产业园&quot;</span>,
<span class="token string">&quot;remark&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;java architect&quot;</span>
<span class="token punctuation">}</span>			              
</code></pre></div><p><strong>查询所有match_all</strong></p> <p>使用match_all，默认只会返回10条数据。</p> <p>原因：_search查询默认采用的是分页查询，每页记录数size的默认值为10。如果想显示更多数据，指定size</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
等同于
GET /es_db/_search
<span class="token punctuation">{</span>
<span class="token string">&quot;query&quot;</span>:<span class="token punctuation">{</span>
<span class="token string">&quot;match_all&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>返回指定条数size</strong></p> <p>size 关键字: 指定查询结果中返回指定条数。 默认返回值10条</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">100</span>
<span class="token punctuation">}</span>

</code></pre></div><p>思考： size可以无限增加吗？</p> <p>测试</p> <div class="language- extra-class"><pre class="language-text"><code>GET /es_db/_search
{
  &quot;query&quot;: {
    &quot;match_all&quot;: {}
  },
  &quot;size&quot;: 20000
}
</code></pre></div><p>出现异常：</p> <p><img src="https://img.jssjqd.cn/202212112308646.png" alt="image-20221211230759437"></p> <p>异常原因：</p> <p>1、查询结果的窗口太大，from + size的结果必须小于或等于10000，而当前查询结果的窗口为20000。</p> <p>2、可以采用scroll api更高效的请求大量数据集。</p> <p>3、查询结果的窗口的限制可以通过参数index.max_result_window进行设置。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>PUT /es_db/_settings
<span class="token punctuation">{</span> 
  <span class="token string">&quot;index.max_result_window&quot;</span> <span class="token builtin class-name">:</span><span class="token string">&quot;20000&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">#修改现有所有的索引，但新增的索引，还是默认的10000</span>
PUT /_all/_settings
<span class="token punctuation">{</span> 
  <span class="token string">&quot;index.max_result_window&quot;</span> <span class="token builtin class-name">:</span><span class="token string">&quot;20000&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">#查看所有索引中的index.max_result_window值</span>
GET /_all/_settings/index.max_result_window
</code></pre></div><p>注意：参数index.max_result_window主要用来限制单次查询满足查询条件的结果窗口的大小，窗口大小由from + size共同决定。不能简单理解成查询返回给调用方的数据量。这样做主要是为了限制<a href="https://so.csdn.net/so/search?q=%E5%86%85%E5%AD%98&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">内存<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的消耗。</p> <p>比如：from为1000000，size为10，逻辑意义是从满足条件的数据中取1000000到（1000000 + 10）的记录。这时ES一定要先将（1000000 + 10）的记录（即result_window）加载到内存中，再进行分页取值的操作。尽管最后我们只取了10条数据返回给客户端，但ES进程执行查询操作的过程中确需要将（1000000 + 10）的记录都加载到内存中，可想而知对内存的消耗有多大。这也是ES中不推荐采用（from + size）方式进行深度分页的原因。</p> <p>同理，from为0，size为1000000时，ES进程执行查询操作的过程中确需要将1000000 条记录都加载到内存中再返回给调用方，也会对ES内存造成很大压力。</p> <p><strong>分页查询form</strong></p> <p>from 关键字: 用来指定起始返回位置，和size关键字连用可实现分页效果</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,
  <span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>深分页查询Scroll</strong></p> <p>改动index.max_result_window参数值的大小，只能解决一时的问题，当索引的数据量持续增长时，在查询全量数据时还是会出现问题。而且会增加ES服务器内存大结果集消耗完的风险。最佳实践还是根据异常提示中的采用scroll api更高效的请求大量数据集。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#查询命令中新增scroll=1m,说明采用游标查询，保持游标查询窗口一分钟。</span>
<span class="token comment">#这里由于测试数据量不够，所以size值设置为2。</span>
<span class="token comment">#实际使用中为了减少游标查询的次数，可以将值适当增大，比如设置为1000。</span>
GET /es_db/_search?scroll<span class="token operator">=</span>1m 
<span class="token punctuation">{</span>
    <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span>  <span class="token number">2</span>
<span class="token punctuation">}</span>       
</code></pre></div><p>查询结果：</p> <p>除了返回前2条记录，还返回了一个游标ID值_scroll_id。<img src="https://img.jssjqd.cn/202212112314755.png" alt="image-20221211231404843"></p> <p>采用游标id查询：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># scroll_id 的值就是上一个请求中返回的 _scroll_id 的值</span>
GET /_search/scroll
<span class="token punctuation">{</span>
    <span class="token string">&quot;scroll&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1m&quot;</span>, 
    <span class="token string">&quot;scroll_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFmNwcVdjblRxUzVhZXlicG9HeU02bWcAAAAAAABmzRY2YlV3Z0o5VVNTdWJobkE5Z3MtXzJB&quot;</span>
<span class="token punctuation">}</span>     
</code></pre></div><p><img src="https://img.jssjqd.cn/202212112314465.png" alt="image-20221211231431406"></p> <p>多次根据scroll_id游标查询，直到没有数据返回则结束查询。采用游标查询索引全量数据，更安全高效，限制了单次对内存的消耗。</p> <p><strong>指定字段排序sort</strong></p> <p>注意：会让得分失效</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;sort&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;desc&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">#排序，分页</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;sort&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;desc&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;from&quot;</span><span class="token builtin class-name">:</span> <span class="token number">10</span>,
  <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>返回指定字段_source</strong></p> <p>_source 关键字: 是一个数组,在数组中用来指定展示那些字段</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_all&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;_source&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span>,<span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>     
</code></pre></div><p><strong>match</strong></p> <p>match在匹配时会对所查找的关键词进行分词，然后按分词匹配查找</p> <p>match支持以下参数：</p> <ul><li><p>query : 指定匹配的值</p></li> <li><p>operator : 匹配条件类型</p></li> <li><ul><li>and : 条件分词后都要匹配</li> <li>or : 条件分词后有一个匹配即可(默认)</li></ul></li> <li><p>minmum_should_match : 最低匹配度，即条件在倒排索引中最低的匹配度</p></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#模糊匹配 match   分词后or的效果</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州白云山公园&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 分词后 and的效果</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州白云山公园&quot;</span>,
        <span class="token string">&quot;operator&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;AND&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>              
</code></pre></div><p>在match中的应用： 当operator参数设置为or时，minnum_should_match参数用来控制匹配的分词的最少数量。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 最少匹配广州，公园两个词</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州公园&quot;</span>,
        <span class="token string">&quot;minimum_should_match&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>短语查询match_phrase</strong></p> <p>match_phrase查询分析文本并根据分析的文本创建一个短语查询。match_phrase 会将检索关键词分词。match_phrase的分词结果必须在被检索字段的分词中都包含，而且顺序必须相同，而且默认必须都是连续的。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_phrase&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州白云山&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_phrase&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州白云&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>思考：为什么查询广州白云山有数据，广州白云没有数据？</p> <p><img src="https://img.jssjqd.cn/202212112324527.png" alt="image-20221211232410276"></p> <p>分析原因：</p> <p>先查看广州白云山公园分词结果，可以知道广州和白云不是相邻的词条，中间会隔一个白云山，而match_phrase匹配的是相邻的词条，所以查询广州白云山有结果，但查询广州白云没有结果。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>POST _analyze
<span class="token punctuation">{</span>
    <span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ik_max_word&quot;</span>,
    <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;广州白云山&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">#结果</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;tokens&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;token&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;广州&quot;</span>,
      <span class="token string">&quot;start_offset&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
      <span class="token string">&quot;end_offset&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;CN_WORD&quot;</span>,
      <span class="token string">&quot;position&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;token&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;白云山&quot;</span>,
      <span class="token string">&quot;start_offset&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">&quot;end_offset&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>,
      <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;CN_WORD&quot;</span>,
      <span class="token string">&quot;position&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;token&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;白云&quot;</span>,
      <span class="token string">&quot;start_offset&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">&quot;end_offset&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>,
      <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;CN_WORD&quot;</span>,
      <span class="token string">&quot;position&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;token&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;云山&quot;</span>,
      <span class="token string">&quot;start_offset&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
      <span class="token string">&quot;end_offset&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>,
      <span class="token string">&quot;type&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;CN_WORD&quot;</span>,
      <span class="token string">&quot;position&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>    
</code></pre></div><p>如何解决词条间隔的问题？可以借助slop参数，slop参数告诉match_phrase查询词条能够相隔多远时仍然将文档视为匹配。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#广州云山分词后相隔为2，可以匹配到结果</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match_phrase&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州云山&quot;</span>,
        <span class="token string">&quot;slop&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre></div><p><strong>多字段查询multi_match</strong></p> <p>可以根据字段类型，决定是否使用分词查询，得分最高的在前面</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;multi_match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;长沙张龙&quot;</span>,
      <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;address&quot;</span>,
        <span class="token string">&quot;name&quot;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意：字段类型分词,将查询条件分词之后进行查询，如果该字段不分词就会将查询条件作为整体进行查询。</p> <p><strong>query_string</strong></p> <p>允许我们在单个查询字符串中指定AND | OR | NOT条件，同时也和 multi_match query 一样，支持多字段搜索。和match类似，但是match需要指定字段名，query_string是在所有字段中搜索，范围更广泛。</p> <p>注意: 查询字段分词就将查询条件分词查询，查询字段不分词将查询条件不分词查询</p> <ul><li><strong>未指定字段查询</strong></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;query_string&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;张三 OR 橘子洲&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>指定单个字段查询</strong></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#Query String</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;query_string&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;default_field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;address&quot;</span>,
      <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;白云山 OR 橘子洲&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>指定多个字段查询</strong></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;query_string&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span>,<span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span>,
      <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;张三 OR (广州 AND 王五)&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>simple_query_string</strong></p> <p>类似Query String，但是会忽略错误的语法,同时只支持部分查询语法，不支持AND OR NOT，会当作字符串处理。支持部分逻辑：</p> <ul><li>+ 替代AND</li> <li>| 替代OR</li> <li>- 替代NOT</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#simple_query_string 默认的operator是OR</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;simple_query_string&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span>,<span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span>,
      <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州公园&quot;</span>,
      <span class="token string">&quot;default_operator&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;AND&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;simple_query_string&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span>,<span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span>,
      <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州 + 公园&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre></div><p><strong>关键词查询Term</strong></p> <p>Term用来使用关键词查询(精确匹配),还可以用来查询没有被进行分词的数据类型。Term是表达语意的最小单位，搜索和利用统计语言模型进行自然语言处理都需要处理Term。match在匹配时会对所查找的关键词进行分词，然后按分词匹配查找，而term会直接对关键词进行查找。一般模糊查找的时候，多用match，而精确查找时可以使用term。</p> <ul><li><p>ES中默认使用分词器为标准分词器(StandardAnalyzer),标准分词器对于英文单词分词,对于中文单字分词。</p></li> <li><p>在ES的Mapping Type 中 keyword , date ,integer, long , double , boolean or ip 这些类型不分词，只有text类型分词。</p></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#关键字查询 term</span>
<span class="token comment"># 思考： 查询广州白云是否有数据，为什么？</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span>:<span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州白云&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 采用term精确查询, 查询字段映射类型为keyword</span>
GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span>:<span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address.keyword&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州白云山公园&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>在ES中，Term查询，对输入不做分词。会将输入作为一个整体，在倒排索引中查找准确的词项，并且使用相关度算分公式为每个包含该词项的文档进行相关度算分。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>PUT /product/_bulk
<span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span>:1<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;productId&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;xxx123&quot;</span>,<span class="token string">&quot;productName&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;iPhone&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span>:2<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;productId&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;xxx111&quot;</span>,<span class="token string">&quot;productName&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;iPad&quot;</span><span class="token punctuation">}</span>

<span class="token comment"># 思考： 查询iPhone可以查到数据吗？  </span>
GET /product/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span>:<span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;productName&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;iPhone&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /product/_analyze
<span class="token punctuation">{</span>
  <span class="token string">&quot;analyzer&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;standard&quot;</span>,
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;iPhone&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment"># 对于英文，可以考虑建立索引时忽略大小写</span>
PUT /product
<span class="token punctuation">{</span>
  <span class="token string">&quot;settings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;analysis&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;normalizer&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;es_normalizer&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;filter&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;lowercase&quot;</span>,
            <span class="token string">&quot;asciifolding&quot;</span>
          <span class="token punctuation">]</span>,
          <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;custom&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;mappings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;properties&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;productId&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;productName&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;keyword&quot;</span>,
        <span class="token string">&quot;normalizer&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;es_normalizer&quot;</span>,
        <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre></div><p>可以通过 Constant Score 将查询转换成一个 Filtering，避免算分，并利用缓存，提高性能。</p> <ul><li>将Query 转成 Filter，忽略TF-IDF计算，避免相关性算分的开销</li> <li>Filter可以有效利用缓存</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;constant_score&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;filter&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;address.keyword&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州白云山公园&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>ES中的结构化搜索</strong></p> <p>结构化搜索(Structured search)是指对结构化数据的搜索。</p> <p><strong>结构化数据：</strong></p> <ul><li><p>日期，布尔类型和数字都是结构化的</p></li> <li><p>文本也可以是结构化的。</p></li> <li><ul><li>如彩色笔可以有离散的颜色集合：红(red) 、绿(green、蓝(blue)</li> <li>一个博客可能被标记了标签，例如，分布式(distributed)和搜索(search)</li> <li>电商网站上的商品都有UPC(通用产品码Universal Product Code)或其他的唯一</li></ul></li></ul> <p>标识，它们都需要遵从严格规定的、结构化的格式。</p> <p>应用场景：对bool，日期，数字，结构化的文本可以利用term做精确匹配</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">28</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>term处理多值字段，term查询是包含，不是等于</p> <div class="language-shell extra-class"><pre class="language-shell"><code>POST /employee/_bulk
<span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span>:1<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;小明&quot;</span>,<span class="token string">&quot;interest&quot;</span>:<span class="token punctuation">[</span><span class="token string">&quot;跑步&quot;</span>,<span class="token string">&quot;篮球&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span>:2<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;小红&quot;</span>,<span class="token string">&quot;interest&quot;</span>:<span class="token punctuation">[</span><span class="token string">&quot;跳舞&quot;</span>,<span class="token string">&quot;画画&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span>:3<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;小丽&quot;</span>,<span class="token string">&quot;interest&quot;</span>:<span class="token punctuation">[</span><span class="token string">&quot;跳舞&quot;</span>,<span class="token string">&quot;唱歌&quot;</span>,<span class="token string">&quot;跑步&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

POST /employee/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;interest.keyword&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;跑步&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>前缀查询prefix</strong></p> <p>它会对分词后的term进行前缀搜索。</p> <ul><li>它不会分析要搜索字符串，传入的前缀就是想要查找的前缀</li> <li>默认状态下，前缀查询不做相关度分数计算，它只是将所有匹配的文档返回，然后赋予所有相关分数值为1。它的行为更像是一个过滤器而不是查询。两者实际的区别就是过滤器是可以被缓存的，而前缀查询不行。</li></ul> <p>prefix的原理：需要遍历所有倒排索引，并比较每个term是否已所指定的前缀开头。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;prefix&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广州&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>通配符查询wildcard</strong></p> <p>通配符查询：工作原理和prefix相同，只不过它不是只比较开头，它能支持更为复杂的匹配模式。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;wildcard&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*白*&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>范围查询range</strong></p> <ul><li>range：范围关键字</li> <li>gte 大于等于</li> <li>lte  小于等于</li> <li>gt 大于</li> <li>lt 小于</li> <li>now 当前时间</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>POST /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;range&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;gte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">25</span>,
        <span class="token string">&quot;lte&quot;</span><span class="token builtin class-name">:</span> <span class="token number">28</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>日期range</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>DELETE /product
POST /product/_bulk
<span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span>:1<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;price&quot;</span>:100,<span class="token string">&quot;date&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2021-01-01&quot;</span>,<span class="token string">&quot;productId&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;XHDK-1293&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span>:2<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;price&quot;</span>:200,<span class="token string">&quot;date&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2022-01-01&quot;</span>,<span class="token string">&quot;productId&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;KDKE-5421&quot;</span><span class="token punctuation">}</span>

GET /product/_mapping

GET /product/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;range&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;date&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;gte&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;now-2y&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>多id查询ids</strong></p> <p>ids 关键字 : 值为数组类型,用来根据一组id获取多个对应的文档</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;ids&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;values&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">1,2</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>模糊查询fuzzy</strong></p> <p>在实际的搜索中，我们有时候会打错字，从而导致搜索不到。在Elasticsearch中，我们可以使用fuzziness属性来进行模糊查询，从而达到搜索有错别字的情形。</p> <p>fuzzy 查询会用到两个很重要的参数，fuzziness，prefix_length</p> <ul><li><p>fuzziness：表示输入的关键字通过几次操作可以转变成为ES库里面的对应field的字段</p></li> <li><ul><li>操作是指：新增一个字符，删除一个字符，修改一个字符，每次操作可以记做编辑距离为1，</li> <li>如中文集团到中威集团编辑距离就是1，只需要修改一个字符；</li> <li>该参数默认值为0，即不开启模糊查询。</li> <li>如果fuzziness值在这里设置成2，会把编辑距离为2的东东集团也查出来。</li></ul></li> <li><p>prefix_length：表示限制输入关键字和ES对应查询field的内容开头的第n个字符必须完全匹配，不允许错别字匹配</p></li> <li><ul><li>如这里等于1，则表示开头的字必须匹配，不匹配则不返回</li> <li>默认值也是0</li> <li>加大prefix_length的值可以提高效率和准确率。</li></ul></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;fuzzy&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;白运山&quot;</span>,
        <span class="token string">&quot;fuzziness&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>    
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /es_db/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;match&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;address&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;广洲&quot;</span>,
        <span class="token string">&quot;fuzziness&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>注意: fuzzy 模糊查询 最大模糊错误 必须在0-2之间</p> <ul><li>搜索关键词长度为 2，不允许存在模糊</li> <li>搜索关键词长度为3-5，允许1次模糊</li> <li>搜索关键词长度大于5，允许最大2次模糊</li></ul> <p><strong>高亮highlight</strong></p> <p>highlight 关键字: 可以让符合条件的文档中的关键词高亮。</p> <p>highlight相关属性：</p> <ul><li>pre_tags 前缀标签</li> <li>post_tags 后缀标签</li> <li>tags_schema 设置为styled可以使用内置高亮样式</li> <li>require_field_match 多字段高亮需要设置为false</li></ul> <p>示例数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#指定ik分词器</span>
PUT /products
<span class="token punctuation">{</span>
  <span class="token string">&quot;settings&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;index&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;analysis.analyzer.default.type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /products/_doc/1
<span class="token punctuation">{</span>
  <span class="token string">&quot;proId&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;2&quot;</span>,
  <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;牛仔男外套&quot;</span>,
  <span class="token string">&quot;desc&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;牛仔外套男装春季衣服男春装夹克修身休闲男生潮牌工装潮流头号青年春秋棒球服男 7705浅蓝常规 XL&quot;</span>,
  <span class="token string">&quot;timestamp&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1576313264451</span>,
  <span class="token string">&quot;createTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;2019-12-13 12:56:56&quot;</span>
<span class="token punctuation">}</span>

PUT /products/_doc/2
<span class="token punctuation">{</span>
  <span class="token string">&quot;proId&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;6&quot;</span>,
  <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;HLA海澜之家牛仔裤男&quot;</span>,
  <span class="token string">&quot;desc&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;HLA海澜之家牛仔裤男2019时尚有型舒适HKNAD3E109A 牛仔蓝(A9)175/82A(32)&quot;</span>,
  <span class="token string">&quot;timestamp&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1576314265571</span>,
  <span class="token string">&quot;createTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;2019-12-18 15:56:56&quot;</span>
<span class="token punctuation">}</span>        
</code></pre></div><p>测试</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /products/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;牛仔&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;highlight&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;*&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre></div><p><strong>自定义高亮html标签</strong></p> <p>可以在highlight中使用pre_tags和post_tags</p> <div class="language-shell extra-class"><pre class="language-shell"><code>GET /products/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;牛仔&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;highlight&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;post_tags&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;/span&gt;&quot;</span><span class="token punctuation">]</span>, 
    <span class="token string">&quot;pre_tags&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;span style='color:red'&gt;&quot;</span><span class="token punctuation">]</span>,
    <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;*&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>      
</code></pre></div><p><strong>多字段高亮</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>
GET /products/_search
<span class="token punctuation">{</span>
  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;term&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;牛仔&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;highlight&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;pre_tags&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;font color='red'&gt;&quot;</span><span class="token punctuation">]</span>,
    <span class="token string">&quot;post_tags&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;font/&gt;&quot;</span><span class="token punctuation">]</span>,
    <span class="token string">&quot;require_field_match&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;false&quot;</span>,
    <span class="token string">&quot;fields&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
      <span class="token string">&quot;desc&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/04/09, 18:38:18</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/8c5c4e/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">ElasticSearch快速入门实战</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/8c5c4e/" class="prev">ElasticSearch快速入门实战</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/ed68ae/"><div>
            负载均衡Ribbon&amp;LoadBalancer实战
            <!----></div></a> <span class="date">04-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/e79a05/"><div>
            SpringBoot自动配置底层源码解析
            <!----></div></a> <span class="date">04-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5655a2/"><div>
            idea加密连接服务器docker
            <!----></div></a> <span class="date">04-04</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xugaoyi" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>江</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.a2127b69.js" defer></script><script src="/assets/js/2.8795ec35.js" defer></script><script src="/assets/js/91.a3a69724.js" defer></script>
  </body>
</html>
