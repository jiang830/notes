<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kafka基本原理 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="个人技术博客,技术文档,学习,面试,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.05e4719f.css" as="style"><link rel="preload" href="/assets/js/app.a2127b69.js" as="script"><link rel="preload" href="/assets/js/2.8795ec35.js" as="script"><link rel="preload" href="/assets/js/70.576468eb.js" as="script"><link rel="prefetch" href="/assets/js/10.a044793b.js"><link rel="prefetch" href="/assets/js/100.395bca2c.js"><link rel="prefetch" href="/assets/js/101.a3e4de38.js"><link rel="prefetch" href="/assets/js/102.fa4ed05d.js"><link rel="prefetch" href="/assets/js/103.dc6c5d69.js"><link rel="prefetch" href="/assets/js/104.75586808.js"><link rel="prefetch" href="/assets/js/105.511d296d.js"><link rel="prefetch" href="/assets/js/106.afb96620.js"><link rel="prefetch" href="/assets/js/107.1ffa920f.js"><link rel="prefetch" href="/assets/js/108.259eff2f.js"><link rel="prefetch" href="/assets/js/109.72f70ea4.js"><link rel="prefetch" href="/assets/js/11.5e7d0c95.js"><link rel="prefetch" href="/assets/js/110.cf6cc100.js"><link rel="prefetch" href="/assets/js/111.b94b04c5.js"><link rel="prefetch" href="/assets/js/112.dce94b67.js"><link rel="prefetch" href="/assets/js/113.f1e769de.js"><link rel="prefetch" href="/assets/js/114.660b6b09.js"><link rel="prefetch" href="/assets/js/12.e841c0c3.js"><link rel="prefetch" href="/assets/js/13.41a2fb93.js"><link rel="prefetch" href="/assets/js/14.e2a3317c.js"><link rel="prefetch" href="/assets/js/15.a81a6ef1.js"><link rel="prefetch" href="/assets/js/16.7b69e07f.js"><link rel="prefetch" href="/assets/js/17.777b188a.js"><link rel="prefetch" href="/assets/js/18.c81cf408.js"><link rel="prefetch" href="/assets/js/19.a59301e0.js"><link rel="prefetch" href="/assets/js/20.18827160.js"><link rel="prefetch" href="/assets/js/21.8d5d511f.js"><link rel="prefetch" href="/assets/js/22.a8ac93a6.js"><link rel="prefetch" href="/assets/js/23.1bbe4807.js"><link rel="prefetch" href="/assets/js/24.00525e76.js"><link rel="prefetch" href="/assets/js/25.3c90e0a0.js"><link rel="prefetch" href="/assets/js/26.c93f745b.js"><link rel="prefetch" href="/assets/js/27.01181006.js"><link rel="prefetch" href="/assets/js/28.93af4585.js"><link rel="prefetch" href="/assets/js/29.a0806690.js"><link rel="prefetch" href="/assets/js/3.7b0b8907.js"><link rel="prefetch" href="/assets/js/30.3beac9a7.js"><link rel="prefetch" href="/assets/js/31.3ee788ac.js"><link rel="prefetch" href="/assets/js/32.6522140e.js"><link rel="prefetch" href="/assets/js/33.24b1949c.js"><link rel="prefetch" href="/assets/js/34.90e39367.js"><link rel="prefetch" href="/assets/js/35.a67486b8.js"><link rel="prefetch" href="/assets/js/36.d9ffefc3.js"><link rel="prefetch" href="/assets/js/37.e3a99db4.js"><link rel="prefetch" href="/assets/js/38.8e250355.js"><link rel="prefetch" href="/assets/js/39.fc7bdfc1.js"><link rel="prefetch" href="/assets/js/4.9805163b.js"><link rel="prefetch" href="/assets/js/40.454bd56a.js"><link rel="prefetch" href="/assets/js/41.a235b641.js"><link rel="prefetch" href="/assets/js/42.af91ee0f.js"><link rel="prefetch" href="/assets/js/43.ee9374e7.js"><link rel="prefetch" href="/assets/js/44.36c8feb3.js"><link rel="prefetch" href="/assets/js/45.d8301c73.js"><link rel="prefetch" href="/assets/js/46.9a5a32af.js"><link rel="prefetch" href="/assets/js/47.d58b6a64.js"><link rel="prefetch" href="/assets/js/48.f02903e0.js"><link rel="prefetch" href="/assets/js/49.19767842.js"><link rel="prefetch" href="/assets/js/5.c3d6e4f2.js"><link rel="prefetch" href="/assets/js/50.48750e81.js"><link rel="prefetch" href="/assets/js/51.c4254bbf.js"><link rel="prefetch" href="/assets/js/52.b343e884.js"><link rel="prefetch" href="/assets/js/53.98458ade.js"><link rel="prefetch" href="/assets/js/54.fde5639b.js"><link rel="prefetch" href="/assets/js/55.1d6eee4b.js"><link rel="prefetch" href="/assets/js/56.b00d9d45.js"><link rel="prefetch" href="/assets/js/57.eaec60f9.js"><link rel="prefetch" href="/assets/js/58.4b703868.js"><link rel="prefetch" href="/assets/js/59.26a30b6e.js"><link rel="prefetch" href="/assets/js/6.c77dab88.js"><link rel="prefetch" href="/assets/js/60.eb33df05.js"><link rel="prefetch" href="/assets/js/61.d173fa46.js"><link rel="prefetch" href="/assets/js/62.429026f8.js"><link rel="prefetch" href="/assets/js/63.b58a3d49.js"><link rel="prefetch" href="/assets/js/64.99d18334.js"><link rel="prefetch" href="/assets/js/65.cce9fdce.js"><link rel="prefetch" href="/assets/js/66.2fe5a7ce.js"><link rel="prefetch" href="/assets/js/67.fa40b952.js"><link rel="prefetch" href="/assets/js/68.83533afe.js"><link rel="prefetch" href="/assets/js/69.699a59ea.js"><link rel="prefetch" href="/assets/js/7.76f628a5.js"><link rel="prefetch" href="/assets/js/71.d479c994.js"><link rel="prefetch" href="/assets/js/72.b6d86aab.js"><link rel="prefetch" href="/assets/js/73.d835d9fc.js"><link rel="prefetch" href="/assets/js/74.d0c0c961.js"><link rel="prefetch" href="/assets/js/75.c0fb32d8.js"><link rel="prefetch" href="/assets/js/76.b98fe8df.js"><link rel="prefetch" href="/assets/js/77.506c158d.js"><link rel="prefetch" href="/assets/js/78.4bd2d644.js"><link rel="prefetch" href="/assets/js/79.35030393.js"><link rel="prefetch" href="/assets/js/8.d2e1201f.js"><link rel="prefetch" href="/assets/js/80.93dec784.js"><link rel="prefetch" href="/assets/js/81.f5092f98.js"><link rel="prefetch" href="/assets/js/82.ca631d56.js"><link rel="prefetch" href="/assets/js/83.1da51aad.js"><link rel="prefetch" href="/assets/js/84.8a1de17c.js"><link rel="prefetch" href="/assets/js/85.b00ba373.js"><link rel="prefetch" href="/assets/js/86.f0ea7c85.js"><link rel="prefetch" href="/assets/js/87.afaa6182.js"><link rel="prefetch" href="/assets/js/88.5ea4d29d.js"><link rel="prefetch" href="/assets/js/89.5dc353d7.js"><link rel="prefetch" href="/assets/js/9.2821f128.js"><link rel="prefetch" href="/assets/js/90.fbfb0b00.js"><link rel="prefetch" href="/assets/js/91.a3a69724.js"><link rel="prefetch" href="/assets/js/92.b5de1c97.js"><link rel="prefetch" href="/assets/js/93.251d9171.js"><link rel="prefetch" href="/assets/js/94.f187e4e0.js"><link rel="prefetch" href="/assets/js/95.6fd0a296.js"><link rel="prefetch" href="/assets/js/96.66099a7e.js"><link rel="prefetch" href="/assets/js/97.15b4ddfe.js"><link rel="prefetch" href="/assets/js/98.3169dd1c.js"><link rel="prefetch" href="/assets/js/99.ac7be4e1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.05e4719f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="学习笔记" class="logo"> <span class="site-name can-hide">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://img.jssjqd.cn/202303140455599.jpg"> <div class="blogger-info"><h3>江</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>RabbitMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kafka</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/1b65ca/" aria-current="page" class="active sidebar-link">Kafka基本原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/1b65ca/#kafka的使用场景" class="sidebar-link">Kafka的使用场景</a></li><li class="sidebar-sub-header level2"><a href="/pages/1b65ca/#kafka基本概念" class="sidebar-link">Kafka基本概念</a></li><li class="sidebar-sub-header level2"><a href="/pages/1b65ca/#kafka基本使用" class="sidebar-link">kafka基本使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/1b65ca/#普通版本kafka安装" class="sidebar-link">普通版本kafka安装</a></li><li class="sidebar-sub-header level3"><a href="/pages/1b65ca/#docker版本kafka安装" class="sidebar-link">docker版本kafka安装</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/1b65ca/#主题topic和消息日志log" class="sidebar-link">主题Topic和消息日志Log</a></li><li class="sidebar-sub-header level2"><a href="/pages/1b65ca/#kafka集群实战" class="sidebar-link">kafka集群实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/1b65ca/#集群消费" class="sidebar-link">集群消费</a></li><li class="sidebar-sub-header level3"><a href="/pages/1b65ca/#消费顺序" class="sidebar-link">消费顺序</a></li><li class="sidebar-sub-header level3"><a href="/pages/1b65ca/#java客户端访问kafka" class="sidebar-link">Java客户端访问Kafka</a></li></ul></li></ul></li><li><a href="/pages/aba13a/" class="sidebar-link">Kafka设计原理详解</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>RocketMQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" title="分类" data-v-06225672>消息队列</a></li><li data-v-06225672><a href="/categories/?category=Kafka" title="分类" data-v-06225672>Kafka</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>江</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-04-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Kafka基本原理<!----></h1>  <div class="theme-vdoing-content content__default"><p>Kafka是最初由Linkedin公司开发，是一个分布式、支持分区的（partition）、多副本的（replica），基于zookeeper协调的分布式消息系统，它的最大的特性就是可以实时的处理大量数据以满足各种需求场景：比如基于hadoop的批处理系统、低延迟的实时系统、Storm/Spark流式处理引擎，web/nginx日志、访问日志，消息服务等等，用scala语言编写，Linkedin于2010年贡献给了Apache基金会并成为顶级开源 项目。</p> <h2 id="kafka的使用场景"><a href="#kafka的使用场景" class="header-anchor">#</a> Kafka的使用场景</h2> <ul><li>日志收集：一个公司可以用Kafka收集各种服务的log，通过kafka以统一接口服务的方式开放给各种consumer，例如hadoop、Hbase、Solr等。</li> <li>消息系统：解耦和生产者和消费者、缓存消息等。</li> <li>用户活动跟踪：Kafka经常被用来记录web用户或者app用户的各种活动，如浏览网页、搜索、点击等活动，这些活动信息被各个服务器发布到kafka的topic中，然后订阅者通过订阅这些topic来做实时的监控分析，或者装载到hadoop、数据仓库中做离线分析和挖掘。</li> <li>运营指标：Kafka也经常用来记录运营监控数据。包括收集各种分布式应用的数据，生产各种操作的集中反馈，比如报警和报告。</li></ul> <p>​                       <img src="https://img.jssjqd.cn/202304021802345.png" alt=""></p> <h2 id="kafka基本概念"><a href="#kafka基本概念" class="header-anchor">#</a> Kafka基本概念</h2> <p>kafka是一个分布式的，分区的消息(官方称之为commit log)服务。它提供一个消息系统应该具备的功能，但是确有着独特的设计。可以这样来说，Kafka借鉴了JMS规范的思想，但是确并<strong>没有完全遵循JMS规范。</strong></p> <p>首先，让我们来看一下基础的消息(Message)相关术语：</p> <table><thead><tr><th><strong>名称</strong></th> <th><strong>解释</strong></th></tr></thead> <tbody><tr><td>Broker</td> <td>消息中间件处理节点，一个Kafka节点就是一个broker，一个或者多个Broker可以组成一个Kafka集群</td></tr> <tr><td>Topic</td> <td>Kafka根据topic对消息进行归类，发布到Kafka集群的每条消息都需要指定一个topic</td></tr> <tr><td>Producer</td> <td>消息生产者，向Broker发送消息的客户端</td></tr> <tr><td>Consumer</td> <td>消息消费者，从Broker读取消息的客户端</td></tr> <tr><td>ConsumerGroup</td> <td>每个Consumer属于一个特定的Consumer Group，一条消息可以被多个不同的Consumer Group消费，但是一个Consumer Group中只能有一个Consumer能够消费该消息</td></tr> <tr><td>Partition</td> <td>物理上的概念，一个topic可以分为多个partition，每个partition内部消息是有序的</td></tr></tbody></table> <p>因此，从一个较高的层面上来看，producer通过网络发送消息到Kafka集群，然后consumer来进行消费，如下图：</p> <p><img src="https://img.jssjqd.cn/202304021808510.png" alt="image-20230402180759274"></p> <p>服务端(brokers)和客户端(producer、consumer)之间通信通过<strong>TCP协议</strong>来完成。</p> <h2 id="kafka基本使用"><a href="#kafka基本使用" class="header-anchor">#</a> kafka基本使用</h2> <h3 id="普通版本kafka安装"><a href="#普通版本kafka安装" class="header-anchor">#</a> 普通版本kafka安装</h3> <p><strong>安装前的环境准备</strong></p> <p>由于Kafka是用Scala语言开发的，运行在JVM上，因此在安装Kafka之前需要先安装JDK。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> java-1.8.0-openjdk* <span class="token parameter variable">-y</span>
</code></pre></div><p>kafka依赖zookeeper，所以需要先安装zookeeper</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> https://archive.apache.org/dist/zookeeper/zookeeper-3.5.8/apache-zookeeper-3.5.8-bin.tar.gz
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> apache-zookeeper-3.5.8-bin.tar.gz
<span class="token builtin class-name">cd</span>  apache-zookeeper-3.5.8-bin
<span class="token function">cp</span> conf/zoo_sample.cfg conf/zoo.cfg

<span class="token comment"># 启动zookeeper</span>
bin/zkServer.sh start
bin/zkCli.sh 
<span class="token function">ls</span> /			<span class="token comment">#查看zk的根目录相关节点           </span>
</code></pre></div><p><strong>第一步：下载安装包</strong></p> <p>下载2.4.1 release版本，并解压：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> https://archive.apache.org/dist/kafka/2.4.1/kafka_2.11-2.4.1.tgz  <span class="token comment"># 2.11是scala的版本，2.4.1是kafka的版本</span>
<span class="token function">tar</span> <span class="token parameter variable">-xzf</span> kafka_2.11-2.4.1.tgz
<span class="token builtin class-name">cd</span> kafka_2.11-2.4.1          
</code></pre></div><p><strong>第二步：修改配置</strong></p> <p>修改配置文件config/server.properties:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#broker.id属性在kafka集群中必须要是唯一</span>
<span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token comment">#kafka部署的机器ip和提供服务的端口号</span>
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://192.168.65.60:9092   
<span class="token comment">#kafka的消息存储文件</span>
<span class="token assign-left variable">log.dir</span><span class="token operator">=</span>/usr/local/data/kafka-logs
<span class="token comment">#kafka连接zookeeper的地址</span>
<span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span><span class="token number">192.168</span>.65.60:2181     
</code></pre></div><p><strong>第三步：启动服务</strong></p> <p>现在来启动kafka服务：</p> <p>启动脚本语法：kafka-server-start.sh [-daemon] server.properties</p> <p>可以看到，server.properties的配置路径是一个强制的参数，-daemon表示以后台进程运行，否则ssh客户端退出后，就会停止服务。(注意，在启动kafka时会使用linux主机名关联的ip地址，所以需要把主机名和linux的ip映射配置到本地host里，用vim /etc/hosts)</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 启动kafka，运行日志在logs目录的server.log文件里</span>
bin/kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server.properties   <span class="token comment">#后台启动，不会打印日志到控制台</span>
或者用
bin/kafka-server-start.sh config/server.properties <span class="token operator">&amp;</span>

<span class="token comment"># 我们进入zookeeper目录通过zookeeper客户端查看下zookeeper的目录树</span>
bin/zkCli.sh 
<span class="token function">ls</span> /		<span class="token comment">#查看zk的根目录kafka相关节点</span>
<span class="token function">ls</span> /brokers/ids	<span class="token comment">#查看kafka节点</span>

<span class="token comment"># 停止kafka</span>
bin/kafka-server-stop.sh          
</code></pre></div><h3 id="docker版本kafka安装"><a href="#docker版本kafka安装" class="header-anchor">#</a> docker版本kafka安装</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">zookeeper</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> zookeeper<span class="token punctuation">:</span>3.5.8
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> zookeeper
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 2181<span class="token punctuation">:</span><span class="token number">2181</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /source/data/zookeeper/data<span class="token punctuation">:</span>/data
      <span class="token punctuation">-</span> /source/data/zookeeper/datalog<span class="token punctuation">:</span>/datalog
      <span class="token punctuation">-</span> /source/data/zookeeper/logs<span class="token punctuation">:</span>/logs
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> bitnami/kafka<span class="token punctuation">:</span>2.4.1
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> zookeeper
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kafka
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9092<span class="token punctuation">:</span><span class="token number">9092</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">KAFKA_BROKER_ID</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">KAFKA_ZOOKEEPER_CONNECT</span><span class="token punctuation">:</span> zookeeper<span class="token punctuation">:</span><span class="token number">2181</span>
      <span class="token key atrule">KAFKA_ADVERTISED_LISTENERS</span><span class="token punctuation">:</span> PLAINTEXT<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">9092</span>
      <span class="token key atrule">KAFKA_LISTENERS</span><span class="token punctuation">:</span> PLAINTEXT<span class="token punctuation">:</span>//0.0.0.0<span class="token punctuation">:</span><span class="token number">9092</span>
      <span class="token key atrule">KAFKA_LOG_RETENTION_HOURS</span><span class="token punctuation">:</span> <span class="token number">24</span>
      <span class="token key atrule">ALLOW_PLAINTEXT_LISTENER</span> <span class="token punctuation">:</span> yes
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /source/data/kafka/data<span class="token punctuation">:</span>/data/kafka<span class="token punctuation">-</span>data
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped  
</code></pre></div><p><strong>server.properties核心配置详解：</strong></p> <table><thead><tr><th><strong>Property</strong></th> <th><strong>Default</strong></th> <th><strong>Description</strong></th></tr></thead> <tbody><tr><td>broker.id</td> <td>0</td> <td>每个broker都可以用一个唯一的非负整数id进行标识；这个id可以作为broker的“名字”，你可以选择任意你喜欢的数字作为id，只要id是唯一的即可。</td></tr> <tr><td>log.dirs</td> <td>/tmp/kafka-logs</td> <td>kafka存放数据的路径。这个路径并不是唯一的，可以是多个，路径之间只需要使用逗号分隔即可；每当创建新partition时，都会选择在包含最少partitions的路径下进行。</td></tr> <tr><td>listeners</td> <td>PLAINTEXT://192.168.65.60:9092</td> <td>server接受客户端连接的端口，ip配置kafka本机ip即可</td></tr> <tr><td>zookeeper.connect</td> <td>localhost:2181</td> <td>zooKeeper连接字符串的格式为：hostname:port，此处hostname和port分别是ZooKeeper集群中某个节点的host和port；zookeeper如果是集群，连接方式为 hostname1:port1, hostname2:port2, hostname3:port3</td></tr> <tr><td>log.retention.hours</td> <td>168</td> <td>每个日志文件删除之前保存的时间。默认数据保存时间对所有topic都一样。</td></tr> <tr><td>num.partitions</td> <td>1</td> <td>创建topic的默认分区数</td></tr> <tr><td>default.replication.factor</td> <td>1</td> <td>自动创建topic的默认副本数量，建议设置为大于等于2</td></tr> <tr><td>min.insync.replicas</td> <td>1</td> <td>当producer设置acks为-1时，min.insync.replicas指定replicas的最小数目（必须确认每一个repica的写数据都是成功的），如果这个数目没有达到，producer发送消息会产生异常</td></tr> <tr><td>delete.topic.enable</td> <td>false</td> <td>是否允许删除主题</td></tr></tbody></table> <p><strong>第四步：创建主题</strong></p> <p>现在我们来创建一个名字为“test”的Topic，这个topic只有一个partition，并且备份因子也设置为1：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181 --replication-factor <span class="token number">1</span> <span class="token parameter variable">--partitions</span> <span class="token number">1</span> <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span>
现在我们可以通过以下命令来查看kafka中目前存在的topic
</code></pre></div><p>现在我们可以通过以下命令来查看kafka中目前存在的topic</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">--list</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181
</code></pre></div><p>除了我们通过手工的方式创建Topic，当producer发布一个消息到某个指定的Topic，这个Topic如果不存在，就自动创建。</p> <p><strong>删除主题</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181
</code></pre></div><p><strong>第五步：发送消息</strong></p> <p>kafka自带了一个producer命令客户端，可以从本地文件中读取内容，或者我们也可以以命令行中直接输入内容，并将这些内容以消息的形式发送到kafka集群中。在默认情况下，每一个行会被当做成一个独立的消息。</p> <p>首先我们要运行发布消息的脚本，然后在命令中输入要发送的消息的内容：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-console-producer.sh --broker-list <span class="token number">192.168</span>.65.60:9092 <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span> 
<span class="token operator">&gt;</span>this is a msg
<span class="token operator">&gt;</span>this is a another msg
</code></pre></div><p><strong>第六步：消费消息</strong></p> <p>对于consumer，kafka同样也携带了一个命令行客户端，会将获取到内容在命令中进行输出，<strong>默认是消费最新的消息</strong>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.65.60:9092 <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span>   
</code></pre></div><p>如果想要消费之前的消息可以通过--from-beginning参数指定，如下命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.65.60:9092 --from-beginning <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span> 
</code></pre></div><p>如果你是通过不同的终端窗口来运行以上的命令，你将会看到在producer终端输入的内容，很快就会在consumer的终端窗口上显示出来。</p> <p>以上所有的命令都有一些附加的选项；当我们不携带任何参数运行命令的时候，将会显示出这个命令的详细用法。</p> <p><strong>消费多主题</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.65.60:9092 <span class="token parameter variable">--whitelist</span> <span class="token string">&quot;test|test-2&quot;</span>
</code></pre></div><p><strong>单播消费</strong></p> <p>一条消息只能被某一个消费者消费的模式，类似queue模式，只需让所有消费者在同一个消费组里即可</p> <p>分别在两个客户端执行如下消费命令，然后往主题里发送消息，结果只有一个客户端能收到消息</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.65.60:9092  --consumer-property <span class="token assign-left variable">group.id</span><span class="token operator">=</span>testGroup <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span> 
</code></pre></div><p><strong>多播消费</strong></p> <p>一条消息能被多个消费者消费的模式，类似publish-subscribe模式费，针对Kafka同一条消息只能被同一个消费组下的某一个消费者消费的特性，要实现多播只要保证这些消费者属于不同的消费组即可。我们再增加一个消费者，该消费者属于testGroup-2消费组，结果两个客户端都能收到消息</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.65.60:9092 --consumer-property <span class="token assign-left variable">group.id</span><span class="token operator">=</span>testGroup-2 <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span> 
</code></pre></div><p><strong>查看消费组名</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.65.60:9092 <span class="token parameter variable">--list</span> 
</code></pre></div><p><strong>查看消费组的消费偏移量</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.65.60:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> testGroup
</code></pre></div><p><img src="https://img.jssjqd.cn/202304021900866.png" alt="image-20230402190025421"></p> <p>**current-offset：**当前消费组的已消费偏移量</p> <p>**log-end-offset：**主题对应分区消息的结束偏移量(HW)</p> <p>**lag：**当前消费组未消费的消息数</p> <h2 id="主题topic和消息日志log"><a href="#主题topic和消息日志log" class="header-anchor">#</a> 主题Topic和消息日志Log</h2> <p>可以理解Topic是一个类别的名称，同类消息发送到同一个Topic下面。对于每一个Topic，下面可以有多个分区(Partition)日志文件:</p> <p><img src="https://img.jssjqd.cn/202304021903362.png" alt="image-20230402190341347"></p> <p>Partition是一个<strong>有序的message序列</strong>，这些message按顺序添加到一个叫做<strong>commit log的文件</strong>中。每个partition中的消息都有一个唯一的编号，称之为offset，用来唯一标示某个分区中的message。</p> <p><strong>每个partition，都对应一个commit log文件</strong>。一个partition中的message的offset都是唯一的，但是不同的partition中的message的offset可能是相同的。</p> <p>kafka一般不会删除消息，不管这些消息有没有被消费。只会根据配置的日志保留时间(log.retention.hours)确认消息多久被删除，默认保留最近一周的日志消息。kafka的性能与保留的消息数据量大小没有关系，因此保存大量的数据消息日志信息不会有什么影响。</p> <p><strong>每个consumer是基于自己在commit log中的消费进度(offset)来进行工作的</strong>。在kafka中，<strong>消费offset由consumer自己来维护</strong>；一般情况下我们按照顺序逐条消费commit log中的消息，当然我可以通过指定offset来重复消费某些消息，或者跳过某些消息。</p> <p>这意味kafka中的consumer对集群的影响是非常小的，添加一个或者减少一个consumer，对于集群或者其他consumer来说，都是没有影响的，因为每个consumer维护各自的消费offset。</p> <p><strong>创建多个分区的主题：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181 --replication-factor <span class="token number">1</span> <span class="token parameter variable">--partitions</span> <span class="token number">2</span> <span class="token parameter variable">--topic</span> test1
</code></pre></div><p><strong>查看下topic的情况</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code> bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181 <span class="token parameter variable">--topic</span> test1
</code></pre></div><p><img src="https://img.jssjqd.cn/202304021945620.png" alt="image-20230402194515491"></p> <p>以下是输出内容的解释，第一行是所有分区的概要信息，之后的每一行表示每一个partition的信息。</p> <ul><li>leader节点负责给定partition的所有读写请求。</li> <li>replicas 表示某个partition在哪几个broker上存在备份。不管这个几点是不是”leader“，甚至这个节点挂了，也会列出。</li> <li>isr 是replicas的一个子集，它只列出当前还存活着的，并且<strong>已同步备份</strong>了该partition的节点。</li></ul> <p>我们可以运行相同的命令查看之前创建的名称为”test“的topic</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181 <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span> 
</code></pre></div><p><img src="https://img.jssjqd.cn/202304021945243.png" alt="image-20230402194534995"></p> <p>之前设置了topic的partition数量为1，备份因子为1，因此显示就如上所示了。</p> <p>可以进入kafka的数据文件存储目录查看test和test1主题的消息日志文件：</p> <p><img src="https://img.jssjqd.cn/202304021945919.png" alt="image-20230402194546929"></p> <p>消息日志文件主要存放在分区文件夹里的以log结尾的日志文件里，如下是test1主题对应的分区0的消息日志：</p> <p><img src="https://img.jssjqd.cn/202304021945642.png" alt="image-20230402194553615"></p> <p>当然我们也可以通过如下命令<strong>增加topic的分区数量(目前kafka不支持减少分区)</strong>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">-alter</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181 <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span>
</code></pre></div><p><strong>可以这么来理解Topic，Partition和Broker</strong></p> <p>一个topic，代表逻辑上的一个业务数据集，比如按数据库里不同表的数据操作消息区分放入不同topic，订单相关操作消息放入订单topic，用户相关操作消息放入用户topic，对于大型网站来说，后端数据都是海量的，订单消息很可能是非常巨量的，比如有几百个G甚至达到TB级别，如果把这么多数据都放在一台机器上可定会有容量限制问题，那么就可以在topic内部划分多个partition来分片存储数据，不同的partition可以位于不同的机器上，每台机器上都运行一个Kafka的进程Broker。</p> <p><strong>为什么要对Topic下数据进行分区存储？</strong></p> <p>1、commit log文件会受到所在机器的文件系统大小的限制，分区之后可以将不同的分区放在不同的机器上，相当于对数据做了<strong>分布式存储</strong>，理论上一个topic可以处理任意数量的数据。</p> <p>2、为了<strong>提高并行度</strong>。</p> <h2 id="kafka集群实战"><a href="#kafka集群实战" class="header-anchor">#</a> kafka集群实战</h2> <p>对于kafka来说，一个单独的broker意味着kafka集群中只有一个节点。要想增加kafka集群中的节点数量，只需要多启动几个broker实例即可。为了有更好的理解，现在我们在一台机器上同时启动三个broker实例。</p> <p>首先，我们需要建立好其他2个broker的配置文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cp</span> config/server.properties config/server-1.properties
<span class="token function">cp</span> config/server.properties config/server-2.properties
</code></pre></div><p>配置文件的需要修改的内容分别如下：</p> <p><strong>config/server-1.properties:</strong></p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment">#broker.id属性在kafka集群中必须要是唯一</span>
<span class="token key attr-name">broker.id</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token comment">#kafka部署的机器ip和提供服务的端口号</span>
<span class="token key attr-name">listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://192.168.65.60:9093   </span>
<span class="token key attr-name">log.dir</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/local/data/kafka-logs-1</span>
<span class="token comment">#kafka连接zookeeper的地址，要把多个kafka实例组成集群，对应连接的zookeeper必须相同</span>
<span class="token key attr-name">zookeeper.connect</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.65.60:2181</span>
</code></pre></div><p><strong>config/server-2.properties:</strong></p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">broker.id</span><span class="token punctuation">=</span><span class="token value attr-value">2</span>
<span class="token key attr-name">listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://192.168.65.60:9094</span>
<span class="token key attr-name">log.dir</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/local/data/kafka-logs-2</span>
<span class="token key attr-name">zookeeper.connect</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.65.60:2181  </span>
</code></pre></div><p>目前我们已经有一个zookeeper实例和一个broker实例在运行了，现在我们只需要在启动2个broker实例即可：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server-1.properties
bin/kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server-2.properties
</code></pre></div><p><strong>查看zookeeper确认集群节点是否都注册成功：</strong></p> <p><img src="https://img.jssjqd.cn/202304021948485.png" alt="0"></p> <p>现在我们创建一个新的topic，副本数设置为3，分区数设置为2：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181 --replication-factor <span class="token number">3</span> <span class="token parameter variable">--partitions</span> <span class="token number">2</span> <span class="token parameter variable">--topic</span> my-replicated-topic
</code></pre></div><p><strong>查看下topic的情况</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code> bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181 <span class="token parameter variable">--topic</span> my-replicated-topic
</code></pre></div><p><img src="https://img.jssjqd.cn/202304021948519.png" alt="image-20230402194846568"></p> <p>以下是输出内容的解释，第一行是所有分区的概要信息，之后的每一行表示每一个partition的信息。</p> <ul><li>leader节点负责给定partition的所有读写请求，同一个主题不同分区leader副本一般不一样(为了容灾)</li> <li>replicas 表示某个partition在哪几个broker上存在备份。不管这个几点是不是”leader“，甚至这个节点挂了，也会列出。</li> <li>isr 是replicas的一个子集，它只列出当前还存活着的，并且<strong>已同步备份</strong>了该partition的节点。</li></ul> <p>现在我们向新建的 my-replicated-topic 中发送一些message，kafka集群可以加上所有kafka节点：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-console-producer.sh --broker-list <span class="token number">192.168</span>.65.60:9092,192.168.65.60:9093,192.168.65.60:9094 <span class="token parameter variable">--topic</span> my-replicated-topic
<span class="token operator">&gt;</span>my <span class="token builtin class-name">test</span> msg <span class="token number">1</span>
<span class="token operator">&gt;</span>my <span class="token builtin class-name">test</span> msg <span class="token number">2</span>            
</code></pre></div><p>现在开始消费：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.65.60:9092,192.168.65.60:9093,192.168.65.60:9094 --from-beginning <span class="token parameter variable">--topic</span> my-replicated-topic
my <span class="token builtin class-name">test</span> msg <span class="token number">1</span>
my <span class="token builtin class-name">test</span> msg <span class="token number">2</span>        
</code></pre></div><p>现在我们来测试我们容错性，因为broker1目前是my-replicated-topic的分区0的leader，所以我们要将其kill</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> server.properties
<span class="token function">kill</span> <span class="token number">14776</span>
</code></pre></div><p>现在再执行命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">192.168</span>.65.60:2181 <span class="token parameter variable">--topic</span> my-replicated-topic              
</code></pre></div><p><img src="https://img.jssjqd.cn/202304021949832.png" alt="image-20230402194955660"></p> <p>我们可以看到，分区0的leader节点已经变成了broker 0。要注意的是，在Isr中，已经没有了1号节点。leader的选举也是从ISR(in-sync replica)中进行的。</p> <p>此时，我们依然可以 消费新消息：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bin/kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.65.60:9092,192.168.65.60:9093,192.168.65.60:9094 --from-beginning <span class="token parameter variable">--topic</span> my-replicated-topic
my <span class="token builtin class-name">test</span> msg <span class="token number">1</span>
my <span class="token builtin class-name">test</span> msg <span class="token number">2</span>     
</code></pre></div><p>查看主题分区对应的leader信息：</p> <p><img src="https://img.jssjqd.cn/202304021950615.png" alt="image-20230402195036471"></p> <p><strong>kafka将很多集群关键信息记录在zookeeper里，保证自己的无状态，从而在水平扩容时非常方便。</strong></p> <h3 id="集群消费"><a href="#集群消费" class="header-anchor">#</a> 集群消费</h3> <p>log的partitions分布在kafka集群中不同的broker上，每个broker可以请求备份其他broker上partition上的数据。kafka集群支持配置一个partition备份的数量。</p> <p>针对每个partition，都有一个broker起到“leader”的作用，0个或多个其他的broker作为“follwers”的作用。<strong>leader处理所有的针对这个partition的读写请求，而followers被动复制leader的结果，不提供读写(主要是为了保证多副本数据与消费的一致性)</strong>。如果这个leader失效了，其中的一个follower将会自动的变成新的leader。</p> <p><strong>Producers</strong></p> <p>生产者将消息发送到topic中去，同时负责选择将message发送到topic的哪一个partition中。通过round-robin做简单的负载均衡。也可以根据消息中的某一个关键字来进行区分。通常第二种方式使用的更多。</p> <p><strong>Consumers</strong></p> <p>传统的消息传递模式有2种：队列( queue) 和（publish-subscribe）</p> <ul><li>queue模式：多个consumer从服务器中读取数据，消息只会到达一个consumer。</li> <li>publish-subscribe模式：消息会被广播给所有的consumer。</li></ul> <p>Kafka基于这2种模式提供了一种consumer的抽象概念：consumer group。</p> <ul><li><p>queue模式：所有的consumer都位于同一个consumer group 下。</p></li> <li><p>publish-subscribe模式：所有的consumer都有着自己唯一的consumer group。</p> <p><img src="https://img.jssjqd.cn/202304021951883.png" alt="image-20230402195122775"></p></li></ul> <p>上图说明：由2个broker组成的kafka集群，某个主题总共有4个partition(P0-P3)，分别位于不同的broker上。这个集群由2个Consumer Group消费， A有2个consumer instances ，B有4个。</p> <p>通常一个topic会有几个consumer group，每个consumer group都是一个逻辑上的订阅者（ logical subscriber ）。每个consumer group由多个consumer instance组成，从而达到可扩展和容灾的功能。</p> <h3 id="消费顺序"><a href="#消费顺序" class="header-anchor">#</a> 消费顺序</h3> <p>一个partition同一个时刻在一个consumer group中只能有一个consumer instance在消费，从而保证消费顺序。</p> <p><strong>consumer group中的consumer instance的数量不能比一个Topic中的partition的数量多，否则，多出来的consumer消费不到消息。</strong></p> <p>Kafka只在partition的范围内保证消息消费的局部顺序性，不能在同一个topic中的多个partition中保证总的消费顺序性。</p> <p>如果有在总体上保证消费顺序的需求，那么我们可以通过将topic的partition数量设置为1，将consumer group中的consumer instance数量也设置为1，但是这样会影响性能，所以kafka的顺序消费很少用。</p> <h3 id="java客户端访问kafka"><a href="#java客户端访问kafka" class="header-anchor">#</a> Java客户端访问Kafka</h3> <p><strong>引入maven依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>消息发送端代码</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tuling<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>kafkaDemo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutionException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MsgProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;my-replicated-topic&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.65.60:9092,192.168.65.60:9093,192.168.65.60:9094&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">/*
         发出消息持久化机制参数
        （1）acks=0： 表示producer不需要等待任何broker确认收到消息的回复，就可以继续发送下一条消息。性能最高，但是最容易丢消息。
        （2）acks=1： 至少要等待leader已经成功将数据写入本地log，但是不需要等待所有follower是否成功写入。就可以继续发送下一
             条消息。这种情况下，如果follower没有成功备份数据，而此时leader又挂掉，则消息会丢失。
        （3）acks=-1或all： 需要等待 min.insync.replicas(默认为1，推荐配置大于等于2) 这个参数配置的副本个数都成功写入日志，这种策略会保证
            只要有一个备份存活就不会丢失数据。这是最强的数据保证。一般除非是金融级别，或跟钱打交道的场景才会使用这种配置。
         */</span>
        <span class="token comment">/*props.put(ProducerConfig.ACKS_CONFIG, &quot;1&quot;);
         */</span><span class="token operator">/</span><span class="token operator">*</span>
        发送失败会重试，默认重试间隔<span class="token number">100</span>ms，重试能保证消息发送的可靠性，但是也可能造成消息重复发送，比如网络抖动，所以需要在
        接收者那边做好消息接收的幂等性处理
        <span class="token operator">*</span><span class="token comment">//*</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">RETRIES_CONFIG</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//重试间隔设置</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">RETRY_BACKOFF_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置发送消息的本地缓冲区，如果设置了该缓冲区，消息会先发送到本地缓冲区，可以提高消息发送性能，默认值是33554432，即32MB</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BUFFER_MEMORY_CONFIG</span><span class="token punctuation">,</span> <span class="token number">33554432</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token comment">//*</span>
        kafka本地线程会从缓冲区取数据，批量发送到broker，
        设置批量发送消息的大小，默认值是<span class="token number">16384</span>，即<span class="token number">16</span>kb，就是说一个batch满了<span class="token number">16</span>kb就发送出去
        <span class="token operator">*</span><span class="token comment">//*</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BATCH_SIZE_CONFIG</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token comment">//*</span>
        默认值是<span class="token number">0</span>，意思就是消息必须立即被发送，但这样会影响性能
        一般设置<span class="token number">10</span>毫秒左右，就是说这个消息发送完后会进入本地的一个batch，如果<span class="token number">10</span>毫秒内，这个batch满了<span class="token number">16</span>kb就会随batch一起被发送出去
        如果<span class="token number">10</span>毫秒内，batch没满，那么也必须把消息发送出去，不能让消息的发送延迟时间太长
        <span class="token operator">*</span><span class="token comment">//*</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">LINGER_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">/</span>
        <span class="token comment">//把发送的key从字符串序列化为字节数组</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//把发送消息value从字符串序列化为字节数组</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> msgNum <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>msgNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> msgNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000.00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//指定发送分区</span>
            <span class="token comment">/*ProducerRecord&lt;String, String&gt; producerRecord = new ProducerRecord&lt;String, String&gt;(TOPIC_NAME
                    , 0, order.getOrderId().toString(), JSON.toJSONString(order));*/</span>
            <span class="token comment">//未指定发送分区，具体发送的分区计算公式：hash(key)%partitionNum</span>
            <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span>
                    <span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//等待消息发送成功的同步阻塞方法</span>
            <span class="token comment">/*RecordMetadata metadata = producer.send(producerRecord).get();
            System.out.println(&quot;同步方式发送消息结果：&quot; + &quot;topic-&quot; + metadata.topic() + &quot;|partition-&quot;
                    + metadata.partition() + &quot;|offset-&quot; + metadata.offset());*/</span>

            <span class="token comment">//异步回调方式发送消息</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>producerRecord<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息失败：&quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;异步方式发送消息结果：&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;topic-&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;|partition-&quot;</span>
                                <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;|offset-&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//送积分 TODO</span>

        <span class="token punctuation">}</span>

        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>消息接收端代码</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tuling<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>kafkaDemo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringDeserializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MsgConsumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;my-replicated-topic&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">CONSUMER_GROUP_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;testGroup&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.65.60:9092,192.168.65.60:9093,192.168.65.60:9094&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消费分组名</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">GROUP_ID_CONFIG</span><span class="token punctuation">,</span> <span class="token constant">CONSUMER_GROUP_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 是否自动提交offset，默认就是true</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">ENABLE_AUTO_COMMIT_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自动提交offset的间隔时间</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">AUTO_COMMIT_INTERVAL_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, &quot;false&quot;);</span>
        <span class="token comment">/*
        当消费主题的是一个新的消费组，或者指定offset的消费方式，offset不存在，那么应该如何消费
        latest(默认) ：只消费自己启动之后发送到主题的消息
        earliest：第一次从头开始消费，以后按照消费offset记录继续消费，这个需要区别于consumer.seekToBeginning(每次都从头开始消费)
        */</span>
        <span class="token comment">//props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &quot;earliest&quot;);</span>
      <span class="token comment">/*
      consumer给broker发送心跳的间隔时间，broker接收到心跳如果此时有rebalance发生会通过心跳响应将
      rebalance方案下发给consumer，这个时间可以稍微短一点
      */</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">HEARTBEAT_INTERVAL_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        服务端broker多久感知不到一个consumer心跳就认为他故障了，会将其踢出消费组，
        对应的Partition也会被重新分配给其他consumer，默认是10秒
        */</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">SESSION_TIMEOUT_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//一次poll最大拉取消息的条数，如果消费者处理速度很快，可以设置大点，如果处理速度一般，可以设置小点</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">MAX_POLL_RECORDS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        如果两次poll操作间隔超过了这个时间，broker就会认为这个consumer处理能力太弱，
        会将其踢出消费组，将分区分配给别的consumer消费
        */</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">MAX_POLL_INTERVAL_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_DESERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_DESERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消费指定分区</span>
        <span class="token comment">//consumer.assign(Arrays.asList(new TopicPartition(TOPIC_NAME, 0)));</span>

        <span class="token comment">//消息回溯消费</span>
        <span class="token comment">/*consumer.assign(Arrays.asList(new TopicPartition(TOPIC_NAME, 0)));
        consumer.seekToBeginning(Arrays.asList(new TopicPartition(TOPIC_NAME, 0)));*/</span>

        <span class="token comment">//指定offset消费</span>
        <span class="token comment">/*consumer.assign(Arrays.asList(new TopicPartition(TOPIC_NAME, 0)));
        consumer.seek(new TopicPartition(TOPIC_NAME, 0), 10);*/</span>

        <span class="token comment">//从指定时间点开始消费</span>
        <span class="token comment">/*List&lt;PartitionInfo&gt; topicPartitions = consumer.partitionsFor(TOPIC_NAME);
        //从1小时前开始消费
        long fetchDataTime = new Date().getTime() - 1000 * 60 * 60;
        Map&lt;TopicPartition, Long&gt; map = new HashMap&lt;&gt;();
        for (PartitionInfo par : topicPartitions) {
            map.put(new TopicPartition(topicName, par.partition()), fetchDataTime);
        }
        Map&lt;TopicPartition, OffsetAndTimestamp&gt; parMap = consumer.offsetsForTimes(map);
        for (Map.Entry&lt;TopicPartition, OffsetAndTimestamp&gt; entry : parMap.entrySet()) {
            TopicPartition key = entry.getKey();
            OffsetAndTimestamp value = entry.getValue();
            if (key == null || value == null) continue;
            Long offset = value.offset();
            System.out.println(&quot;partition-&quot; + key.partition() + &quot;|offset-&quot; + offset);
            System.out.println();
            //根据消费里的timestamp确定offset
            if (value != null) {
                consumer.assign(Arrays.asList(key));
                consumer.seek(key, offset);
            }
        }*/</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
             * poll() API 是拉取消息的长轮询
             */</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;收到消息：partition = %d,offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/*if (records.count() &gt; 0) {
                // 手动同步提交offset，当前线程会阻塞直到offset提交成功
                // 一般使用同步提交，因为提交之后一般也没有什么逻辑代码了
                consumer.commitSync();

                // 手动异步提交offset，当前线程提交offset不会阻塞，可以继续处理后面的程序逻辑
                consumer.commitAsync(new OffsetCommitCallback() {
                    @Override
                    public void onComplete(Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets, Exception exception) {
                        if (exception != null) {
                            System.err.println(&quot;Commit failed for &quot; + offsets);
                            System.err.println(&quot;Commit failed exception: &quot; + exception.getStackTrace());
                        }
                    }
                });

            }*/</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Spring Boot整合Kafka</strong></p> <p>引入spring boot kafka依赖，详见项目实例：spring-boot-kafka</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>       
</code></pre></div><p><strong>application.yml配置如下：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.65.60<span class="token punctuation">:</span><span class="token number">9092</span><span class="token punctuation">,</span>192.168.65.60<span class="token punctuation">:</span><span class="token number">9093</span><span class="token punctuation">,</span>192.168.65.60<span class="token punctuation">:</span><span class="token number">9094</span>
    <span class="token key atrule">producer</span><span class="token punctuation">:</span> <span class="token comment"># 生产者</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置大于0的值，则客户端会将发送失败的记录重新发送</span>
      <span class="token key atrule">batch-size</span><span class="token punctuation">:</span> <span class="token number">16384</span>
      <span class="token key atrule">buffer-memory</span><span class="token punctuation">:</span> <span class="token number">33554432</span>
      <span class="token key atrule">acks</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token comment"># 指定消息key和消息体的编解码方式</span>
      <span class="token key atrule">key-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer
      <span class="token key atrule">value-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer
    <span class="token key atrule">consumer</span><span class="token punctuation">:</span>
      <span class="token key atrule">group-id</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>group
      <span class="token key atrule">enable-auto-commit</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">auto-offset-reset</span><span class="token punctuation">:</span> earliest
      <span class="token key atrule">key-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
      <span class="token key atrule">value-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token comment"># 当每一条记录被消费者监听器（ListenerConsumer）处理之后提交</span>
      <span class="token comment"># RECORD</span>
      <span class="token comment"># 当每一批poll()的数据被消费者监听器（ListenerConsumer）处理之后提交</span>
      <span class="token comment"># BATCH</span>
      <span class="token comment"># 当每一批poll()的数据被消费者监听器（ListenerConsumer）处理之后，距离上次提交时间大于TIME时提交</span>
      <span class="token comment"># TIME</span>
      <span class="token comment"># 当每一批poll()的数据被消费者监听器（ListenerConsumer）处理之后，被处理record数量大于等于COUNT时提交</span>
      <span class="token comment"># COUNT</span>
      <span class="token comment"># TIME |　COUNT　有一个条件满足时提交</span>
      <span class="token comment"># COUNT_TIME</span>
      <span class="token comment"># 当每一批poll()的数据被消费者监听器（ListenerConsumer）处理之后, 手动调用Acknowledgment.acknowledge()后提交</span>
      <span class="token comment"># MANUAL</span>
      <span class="token comment"># 手动调用Acknowledgment.acknowledge()后立即提交，一般使用这种</span>
      <span class="token comment"># MANUAL_IMMEDIATE</span>
      <span class="token key atrule">ack-mode</span><span class="token punctuation">:</span> manual_immediate          
</code></pre></div><p><strong>发送者代码：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">KafkaTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;my-replicated-topic&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/send&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;this is a msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>       
</code></pre></div><p><strong>消费者代码：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">KafkaListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">Acknowledgment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConsumer</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * @KafkaListener(groupId = &quot;testGroup&quot;, topicPartitions = {
     *             @TopicPartition(topic = &quot;topic1&quot;, partitions = {&quot;0&quot;, &quot;1&quot;}),
     *             @TopicPartition(topic = &quot;topic2&quot;, partitions = &quot;0&quot;,
     *                     partitionOffsets = @PartitionOffset(partition = &quot;1&quot;, initialOffset = &quot;100&quot;))
     *     },concurrency = &quot;6&quot;)
     *  //concurrency就是同组下的消费者个数，就是并发消费数，必须小于等于分区总数
     * @param record
     */</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">&quot;my-replicated-topic&quot;</span><span class="token punctuation">,</span>groupId <span class="token operator">=</span> <span class="token string">&quot;zhugeGroup&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenZhugeGroup</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//手动提交offset</span>
        ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*//配置多个消费组
    @KafkaListener(topics = &quot;my-replicated-topic&quot;,groupId = &quot;tulingGroup&quot;)
    public void listenTulingGroup(ConsumerRecord&lt;String, String&gt; record, Acknowledgment ack) {
        String value = record.value();
        System.out.println(value);
        System.out.println(record);
        ack.acknowledge();
    }*/</span>
<span class="token punctuation">}</span>
</code></pre></div><p>​</p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/04/09, 18:38:18</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/def779/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">RabbitMQ使用中的常见问题</div></a> <a href="/pages/aba13a/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Kafka设计原理详解</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/def779/" class="prev">RabbitMQ使用中的常见问题</a></span> <span class="next"><a href="/pages/aba13a/">Kafka设计原理详解</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/ed68ae/"><div>
            负载均衡Ribbon&amp;LoadBalancer实战
            <!----></div></a> <span class="date">04-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/e79a05/"><div>
            SpringBoot自动配置底层源码解析
            <!----></div></a> <span class="date">04-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5655a2/"><div>
            idea加密连接服务器docker
            <!----></div></a> <span class="date">04-04</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xugaoyi" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>江</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.a2127b69.js" defer></script><script src="/assets/js/2.8795ec35.js" defer></script><script src="/assets/js/70.576468eb.js" defer></script>
  </body>
</html>
