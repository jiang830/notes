<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.66" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://mister-hope.github.io/pages/202308300129/"><meta property="og:site_name" content="学习笔记"><meta property="og:title" content="微服务架构拆分实战"><meta property="og:description" content="微服务拆分时机和策略 微服务技术栈选型以及常用组件的接入 扩展知识：微服务全链路灰度解决方案实战 微服务架构拆分 微服务介绍 英文:https://martinfowler.com/articles/microservices.html 中文:http://blog.cuicc.com/blog/2015/07/22/microservices"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-08-30T15:10:48.000Z"><meta property="article:author" content="江"><meta property="article:published_time" content="2023-08-30T01:29:32.000Z"><meta property="article:modified_time" content="2023-08-30T15:10:48.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"微服务架构拆分实战","image":[""],"datePublished":"2023-08-30T01:29:32.000Z","dateModified":"2023-08-30T15:10:48.000Z","author":[{"@type":"Person","name":"江"}]}</script><title>微服务架构拆分实战 | 学习笔记</title><meta name="description" content="微服务拆分时机和策略 微服务技术栈选型以及常用组件的接入 扩展知识：微服务全链路灰度解决方案实战 微服务架构拆分 微服务介绍 英文:https://martinfowler.com/articles/microservices.html 中文:http://blog.cuicc.com/blog/2015/07/22/microservices">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-a9e6fc7e.css" as="style"><link rel="stylesheet" href="/assets/style-a9e6fc7e.css">
    <link rel="modulepreload" href="/assets/app-8ca06c83.js"><link rel="modulepreload" href="/assets/index.html-a4f32c81.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/index.html-4dca8fd8.js"><link rel="prefetch" href="/assets/index.html-0bf89700.js" as="script"><link rel="prefetch" href="/assets/index.html-7b16baa0.js" as="script"><link rel="prefetch" href="/assets/index.html-b61e5d0c.js" as="script"><link rel="prefetch" href="/assets/index.html-3584cb05.js" as="script"><link rel="prefetch" href="/assets/04-Spring之Bean生命周期源码解析上.html-de371ab2.js" as="script"><link rel="prefetch" href="/assets/index.html-58a055c6.js" as="script"><link rel="prefetch" href="/assets/index.html-efb35791.js" as="script"><link rel="prefetch" href="/assets/index.html-436e0857.js" as="script"><link rel="prefetch" href="/assets/index.html-0730a418.js" as="script"><link rel="prefetch" href="/assets/index.html-16e7ff6d.js" as="script"><link rel="prefetch" href="/assets/index.html-ad5dab54.js" as="script"><link rel="prefetch" href="/assets/index.html-2327f967.js" as="script"><link rel="prefetch" href="/assets/index.html-3de5c698.js" as="script"><link rel="prefetch" href="/assets/index.html-03ced220.js" as="script"><link rel="prefetch" href="/assets/index.html-79dfef05.js" as="script"><link rel="prefetch" href="/assets/index.html-b8e9a3ef.js" as="script"><link rel="prefetch" href="/assets/index.html-f243f675.js" as="script"><link rel="prefetch" href="/assets/index.html-d81f543c.js" as="script"><link rel="prefetch" href="/assets/index.html-6db16616.js" as="script"><link rel="prefetch" href="/assets/index.html-5f6144b8.js" as="script"><link rel="prefetch" href="/assets/index.html-d34990a5.js" as="script"><link rel="prefetch" href="/assets/index.html-3e1e9945.js" as="script"><link rel="prefetch" href="/assets/index.html-c91cdb3b.js" as="script"><link rel="prefetch" href="/assets/index.html-da241504.js" as="script"><link rel="prefetch" href="/assets/index.html-a4735aaf.js" as="script"><link rel="prefetch" href="/assets/index.html-52e50faf.js" as="script"><link rel="prefetch" href="/assets/index.html-ac27cb9c.js" as="script"><link rel="prefetch" href="/assets/index.html-8378dae8.js" as="script"><link rel="prefetch" href="/assets/index.html-0fcaf69d.js" as="script"><link rel="prefetch" href="/assets/index.html-d7473555.js" as="script"><link rel="prefetch" href="/assets/index.html-2fa8a457.js" as="script"><link rel="prefetch" href="/assets/index.html-b4667f67.js" as="script"><link rel="prefetch" href="/assets/index.html-b43cd654.js" as="script"><link rel="prefetch" href="/assets/index.html-1a8226fd.js" as="script"><link rel="prefetch" href="/assets/index.html-15837702.js" as="script"><link rel="prefetch" href="/assets/阿里云面试题.html-20bedbbe.js" as="script"><link rel="prefetch" href="/assets/index.html-d6383a9b.js" as="script"><link rel="prefetch" href="/assets/index.html-cfc6fa91.js" as="script"><link rel="prefetch" href="/assets/index.html-4677c093.js" as="script"><link rel="prefetch" href="/assets/index.html-ed8ad60e.js" as="script"><link rel="prefetch" href="/assets/index.html-193458d5.js" as="script"><link rel="prefetch" href="/assets/index.html-44a9250e.js" as="script"><link rel="prefetch" href="/assets/index.html-165ed6ab.js" as="script"><link rel="prefetch" href="/assets/index.html-b9bcbd4c.js" as="script"><link rel="prefetch" href="/assets/index.html-b4715edf.js" as="script"><link rel="prefetch" href="/assets/index.html-a6a473ed.js" as="script"><link rel="prefetch" href="/assets/index.html-40a6fbe0.js" as="script"><link rel="prefetch" href="/assets/index.html-92b73179.js" as="script"><link rel="prefetch" href="/assets/06.MySQL事务原理与优化最佳实践.html-0bae9296.js" as="script"><link rel="prefetch" href="/assets/index.html-f01b9922.js" as="script"><link rel="prefetch" href="/assets/index.html-c78cf196.js" as="script"><link rel="prefetch" href="/assets/index.html-b39d5362.js" as="script"><link rel="prefetch" href="/assets/index.html-e3e6c5de.js" as="script"><link rel="prefetch" href="/assets/index.html-ef4414b0.js" as="script"><link rel="prefetch" href="/assets/index.html-47ee4b2d.js" as="script"><link rel="prefetch" href="/assets/index.html-79111d9d.js" as="script"><link rel="prefetch" href="/assets/index.html-752637f3.js" as="script"><link rel="prefetch" href="/assets/20.ShardingJDBC源码与内核解析.html-d7261d77.js" as="script"><link rel="prefetch" href="/assets/index.html-0461e8a2.js" as="script"><link rel="prefetch" href="/assets/index.html-d25d0f36.js" as="script"><link rel="prefetch" href="/assets/index.html-1eeb9405.js" as="script"><link rel="prefetch" href="/assets/index.html-0640f671.js" as="script"><link rel="prefetch" href="/assets/index.html-4e3302a3.js" as="script"><link rel="prefetch" href="/assets/index.html-195dd9f3.js" as="script"><link rel="prefetch" href="/assets/index.html-c02efbd6.js" as="script"><link rel="prefetch" href="/assets/index.html-11d97748.js" as="script"><link rel="prefetch" href="/assets/index.html-55596fc3.js" as="script"><link rel="prefetch" href="/assets/index.html-aeb5e4f3.js" as="script"><link rel="prefetch" href="/assets/index.html-49864262.js" as="script"><link rel="prefetch" href="/assets/index.html-8aa8a505.js" as="script"><link rel="prefetch" href="/assets/index.html-5468d6c3.js" as="script"><link rel="prefetch" href="/assets/index.html-a6c6a9b6.js" as="script"><link rel="prefetch" href="/assets/index.html-28023807.js" as="script"><link rel="prefetch" href="/assets/index.html-4e1c6831.js" as="script"><link rel="prefetch" href="/assets/index.html-e08af584.js" as="script"><link rel="prefetch" href="/assets/index.html-7bc4b2f4.js" as="script"><link rel="prefetch" href="/assets/index.html-b467a161.js" as="script"><link rel="prefetch" href="/assets/index.html-cdb084e9.js" as="script"><link rel="prefetch" href="/assets/index.html-2c5daf13.js" as="script"><link rel="prefetch" href="/assets/index.html-c875b852.js" as="script"><link rel="prefetch" href="/assets/index.html-9bf13109.js" as="script"><link rel="prefetch" href="/assets/index.html-5a296cf8.js" as="script"><link rel="prefetch" href="/assets/index.html-ea4e2f90.js" as="script"><link rel="prefetch" href="/assets/index.html-6dec9f93.js" as="script"><link rel="prefetch" href="/assets/index.html-fb1e5a70.js" as="script"><link rel="prefetch" href="/assets/index.html-d06b25ea.js" as="script"><link rel="prefetch" href="/assets/index.html-a329cb6c.js" as="script"><link rel="prefetch" href="/assets/index.html-82baa30c.js" as="script"><link rel="prefetch" href="/assets/index.html-f73ec147.js" as="script"><link rel="prefetch" href="/assets/index.html-834817e2.js" as="script"><link rel="prefetch" href="/assets/index.html-8b37f426.js" as="script"><link rel="prefetch" href="/assets/index.html-3fede958.js" as="script"><link rel="prefetch" href="/assets/index.html-f6b87282.js" as="script"><link rel="prefetch" href="/assets/index.html-c4badb7b.js" as="script"><link rel="prefetch" href="/assets/index.html-594075dc.js" as="script"><link rel="prefetch" href="/assets/index.html-d681ae59.js" as="script"><link rel="prefetch" href="/assets/index.html-0ef3cbc4.js" as="script"><link rel="prefetch" href="/assets/index.html-998f8509.js" as="script"><link rel="prefetch" href="/assets/index.html-839e2f2f.js" as="script"><link rel="prefetch" href="/assets/index.html-67bde224.js" as="script"><link rel="prefetch" href="/assets/index.html-82c39f9b.js" as="script"><link rel="prefetch" href="/assets/index.html-15195781.js" as="script"><link rel="prefetch" href="/assets/index.html-4ada790a.js" as="script"><link rel="prefetch" href="/assets/index.html-78bd9b9f.js" as="script"><link rel="prefetch" href="/assets/index.html-dc5edeb4.js" as="script"><link rel="prefetch" href="/assets/index.html-36b4e5af.js" as="script"><link rel="prefetch" href="/assets/index.html-44dfa5da.js" as="script"><link rel="prefetch" href="/assets/index.html-7d77b3a0.js" as="script"><link rel="prefetch" href="/assets/index.html-1b1fc139.js" as="script"><link rel="prefetch" href="/assets/分布式事务组件Seata.html-43e5ab0a.js" as="script"><link rel="prefetch" href="/assets/index.html-38a3358d.js" as="script"><link rel="prefetch" href="/assets/index.html-661f59c3.js" as="script"><link rel="prefetch" href="/assets/index.html-262f1ffe.js" as="script"><link rel="prefetch" href="/assets/index.html-637e4041.js" as="script"><link rel="prefetch" href="/assets/index.html-abe0f282.js" as="script"><link rel="prefetch" href="/assets/index.html-17216a45.js" as="script"><link rel="prefetch" href="/assets/index.html-674f4c11.js" as="script"><link rel="prefetch" href="/assets/index.html-156efe7b.js" as="script"><link rel="prefetch" href="/assets/index.html-d8d8136d.js" as="script"><link rel="prefetch" href="/assets/index.html-7ab6bfee.js" as="script"><link rel="prefetch" href="/assets/404.html-f4f9fdbe.js" as="script"><link rel="prefetch" href="/assets/index.html-ccedd87a.js" as="script"><link rel="prefetch" href="/assets/index.html-6b635626.js" as="script"><link rel="prefetch" href="/assets/index.html-850a48a3.js" as="script"><link rel="prefetch" href="/assets/index.html-39a19522.js" as="script"><link rel="prefetch" href="/assets/index.html-4e6ecfce.js" as="script"><link rel="prefetch" href="/assets/index.html-c37db087.js" as="script"><link rel="prefetch" href="/assets/index.html-7f2f880b.js" as="script"><link rel="prefetch" href="/assets/index.html-f8546af5.js" as="script"><link rel="prefetch" href="/assets/index.html-1ef6ee85.js" as="script"><link rel="prefetch" href="/assets/index.html-b4d64b14.js" as="script"><link rel="prefetch" href="/assets/index.html-a35083c7.js" as="script"><link rel="prefetch" href="/assets/index.html-00747a1a.js" as="script"><link rel="prefetch" href="/assets/index.html-a38369a4.js" as="script"><link rel="prefetch" href="/assets/index.html-e50e9467.js" as="script"><link rel="prefetch" href="/assets/index.html-491b3d1a.js" as="script"><link rel="prefetch" href="/assets/index.html-35ef418a.js" as="script"><link rel="prefetch" href="/assets/index.html-7faf3012.js" as="script"><link rel="prefetch" href="/assets/index.html-8d3db768.js" as="script"><link rel="prefetch" href="/assets/index.html-74ab4abc.js" as="script"><link rel="prefetch" href="/assets/index.html-0f313431.js" as="script"><link rel="prefetch" href="/assets/index.html-e7759861.js" as="script"><link rel="prefetch" href="/assets/index.html-7997aa47.js" as="script"><link rel="prefetch" href="/assets/index.html-942c3b22.js" as="script"><link rel="prefetch" href="/assets/index.html-62e867a2.js" as="script"><link rel="prefetch" href="/assets/index.html-2e69c0da.js" as="script"><link rel="prefetch" href="/assets/index.html-947f51fd.js" as="script"><link rel="prefetch" href="/assets/index.html-ebf056c2.js" as="script"><link rel="prefetch" href="/assets/index.html-838edd2c.js" as="script"><link rel="prefetch" href="/assets/index.html-554790c0.js" as="script"><link rel="prefetch" href="/assets/index.html-82c9b8b3.js" as="script"><link rel="prefetch" href="/assets/index.html-d1866631.js" as="script"><link rel="prefetch" href="/assets/index.html-a8a19c65.js" as="script"><link rel="prefetch" href="/assets/index.html-2d227df8.js" as="script"><link rel="prefetch" href="/assets/index.html-62ed601f.js" as="script"><link rel="prefetch" href="/assets/index.html-46e5d524.js" as="script"><link rel="prefetch" href="/assets/index.html-8ecb9bde.js" as="script"><link rel="prefetch" href="/assets/index.html-c07de721.js" as="script"><link rel="prefetch" href="/assets/index.html-a754f0d1.js" as="script"><link rel="prefetch" href="/assets/index.html-2ef196ec.js" as="script"><link rel="prefetch" href="/assets/index.html-9c0a792e.js" as="script"><link rel="prefetch" href="/assets/index.html-6292db61.js" as="script"><link rel="prefetch" href="/assets/04-Spring之Bean生命周期源码解析上.html-9284d593.js" as="script"><link rel="prefetch" href="/assets/index.html-bf5ef1b3.js" as="script"><link rel="prefetch" href="/assets/index.html-cf8ae71b.js" as="script"><link rel="prefetch" href="/assets/index.html-dd9f2256.js" as="script"><link rel="prefetch" href="/assets/index.html-3dd0be22.js" as="script"><link rel="prefetch" href="/assets/index.html-19f274b4.js" as="script"><link rel="prefetch" href="/assets/index.html-cece923c.js" as="script"><link rel="prefetch" href="/assets/index.html-b5fa8b21.js" as="script"><link rel="prefetch" href="/assets/index.html-3b6eb113.js" as="script"><link rel="prefetch" href="/assets/index.html-ee5c7b80.js" as="script"><link rel="prefetch" href="/assets/index.html-041b94b4.js" as="script"><link rel="prefetch" href="/assets/index.html-fd5978c9.js" as="script"><link rel="prefetch" href="/assets/index.html-9fa64d41.js" as="script"><link rel="prefetch" href="/assets/index.html-3d8d35a4.js" as="script"><link rel="prefetch" href="/assets/index.html-0b7dd7a6.js" as="script"><link rel="prefetch" href="/assets/index.html-9ac332f9.js" as="script"><link rel="prefetch" href="/assets/index.html-24a33a33.js" as="script"><link rel="prefetch" href="/assets/index.html-ce22e8c0.js" as="script"><link rel="prefetch" href="/assets/index.html-826c2320.js" as="script"><link rel="prefetch" href="/assets/index.html-9912ed01.js" as="script"><link rel="prefetch" href="/assets/index.html-4d62077e.js" as="script"><link rel="prefetch" href="/assets/index.html-c26c1721.js" as="script"><link rel="prefetch" href="/assets/index.html-6c0340ec.js" as="script"><link rel="prefetch" href="/assets/index.html-b8b631a9.js" as="script"><link rel="prefetch" href="/assets/index.html-ea726a28.js" as="script"><link rel="prefetch" href="/assets/index.html-74b1db29.js" as="script"><link rel="prefetch" href="/assets/index.html-e24b97ae.js" as="script"><link rel="prefetch" href="/assets/index.html-15b67688.js" as="script"><link rel="prefetch" href="/assets/index.html-5eb0415d.js" as="script"><link rel="prefetch" href="/assets/index.html-26addf25.js" as="script"><link rel="prefetch" href="/assets/index.html-18ffcd6f.js" as="script"><link rel="prefetch" href="/assets/阿里云面试题.html-d05400c1.js" as="script"><link rel="prefetch" href="/assets/index.html-e5b78147.js" as="script"><link rel="prefetch" href="/assets/index.html-d5bbcb58.js" as="script"><link rel="prefetch" href="/assets/index.html-85337547.js" as="script"><link rel="prefetch" href="/assets/index.html-a38b3e42.js" as="script"><link rel="prefetch" href="/assets/index.html-5f43e870.js" as="script"><link rel="prefetch" href="/assets/index.html-2d1d1a78.js" as="script"><link rel="prefetch" href="/assets/index.html-fd3f109c.js" as="script"><link rel="prefetch" href="/assets/index.html-cd3ed7a3.js" as="script"><link rel="prefetch" href="/assets/index.html-dff647d0.js" as="script"><link rel="prefetch" href="/assets/index.html-7cd15cbd.js" as="script"><link rel="prefetch" href="/assets/index.html-05f14232.js" as="script"><link rel="prefetch" href="/assets/index.html-c618c4ed.js" as="script"><link rel="prefetch" href="/assets/06.MySQL事务原理与优化最佳实践.html-938a2379.js" as="script"><link rel="prefetch" href="/assets/index.html-3210da94.js" as="script"><link rel="prefetch" href="/assets/index.html-df19dec5.js" as="script"><link rel="prefetch" href="/assets/index.html-a927f915.js" as="script"><link rel="prefetch" href="/assets/index.html-7619b1b3.js" as="script"><link rel="prefetch" href="/assets/index.html-c4366727.js" as="script"><link rel="prefetch" href="/assets/index.html-3c893e2f.js" as="script"><link rel="prefetch" href="/assets/index.html-97043d12.js" as="script"><link rel="prefetch" href="/assets/index.html-9c29008c.js" as="script"><link rel="prefetch" href="/assets/20.ShardingJDBC源码与内核解析.html-b4be4a92.js" as="script"><link rel="prefetch" href="/assets/index.html-8b45dd5d.js" as="script"><link rel="prefetch" href="/assets/index.html-5c22c3e7.js" as="script"><link rel="prefetch" href="/assets/index.html-5aa6258e.js" as="script"><link rel="prefetch" href="/assets/index.html-4a1c6ba8.js" as="script"><link rel="prefetch" href="/assets/index.html-35806095.js" as="script"><link rel="prefetch" href="/assets/index.html-cd53abf7.js" as="script"><link rel="prefetch" href="/assets/index.html-d93d034e.js" as="script"><link rel="prefetch" href="/assets/index.html-63835d0a.js" as="script"><link rel="prefetch" href="/assets/index.html-1668ecaf.js" as="script"><link rel="prefetch" href="/assets/index.html-2519641f.js" as="script"><link rel="prefetch" href="/assets/index.html-f66d8dfa.js" as="script"><link rel="prefetch" href="/assets/index.html-a2ef5047.js" as="script"><link rel="prefetch" href="/assets/index.html-a9f43cc1.js" as="script"><link rel="prefetch" href="/assets/index.html-bfb2cdd0.js" as="script"><link rel="prefetch" href="/assets/index.html-f4d71ef9.js" as="script"><link rel="prefetch" href="/assets/index.html-c61f4b88.js" as="script"><link rel="prefetch" href="/assets/index.html-8c9646ec.js" as="script"><link rel="prefetch" href="/assets/index.html-77690024.js" as="script"><link rel="prefetch" href="/assets/index.html-694eb3de.js" as="script"><link rel="prefetch" href="/assets/index.html-d8938a4a.js" as="script"><link rel="prefetch" href="/assets/index.html-12a2fbd7.js" as="script"><link rel="prefetch" href="/assets/index.html-19767cad.js" as="script"><link rel="prefetch" href="/assets/index.html-58095d54.js" as="script"><link rel="prefetch" href="/assets/index.html-bf7177f8.js" as="script"><link rel="prefetch" href="/assets/index.html-4398bc36.js" as="script"><link rel="prefetch" href="/assets/index.html-3526346d.js" as="script"><link rel="prefetch" href="/assets/index.html-155551d4.js" as="script"><link rel="prefetch" href="/assets/index.html-a984a2a6.js" as="script"><link rel="prefetch" href="/assets/index.html-509b9fe5.js" as="script"><link rel="prefetch" href="/assets/index.html-8d79b111.js" as="script"><link rel="prefetch" href="/assets/index.html-2b1de71f.js" as="script"><link rel="prefetch" href="/assets/index.html-96b4e1f5.js" as="script"><link rel="prefetch" href="/assets/index.html-716c6cf2.js" as="script"><link rel="prefetch" href="/assets/index.html-5dfc3fe6.js" as="script"><link rel="prefetch" href="/assets/index.html-b47426ef.js" as="script"><link rel="prefetch" href="/assets/index.html-4c3ecd9b.js" as="script"><link rel="prefetch" href="/assets/index.html-5ebc63d1.js" as="script"><link rel="prefetch" href="/assets/index.html-8854779c.js" as="script"><link rel="prefetch" href="/assets/index.html-51054e76.js" as="script"><link rel="prefetch" href="/assets/index.html-48c5df47.js" as="script"><link rel="prefetch" href="/assets/index.html-ab4a5e48.js" as="script"><link rel="prefetch" href="/assets/index.html-f4ff1625.js" as="script"><link rel="prefetch" href="/assets/index.html-a8515bf7.js" as="script"><link rel="prefetch" href="/assets/index.html-7623119a.js" as="script"><link rel="prefetch" href="/assets/index.html-3c8ee1ff.js" as="script"><link rel="prefetch" href="/assets/index.html-a7ceca58.js" as="script"><link rel="prefetch" href="/assets/index.html-fa8cbc55.js" as="script"><link rel="prefetch" href="/assets/index.html-240a4650.js" as="script"><link rel="prefetch" href="/assets/index.html-40b39b3e.js" as="script"><link rel="prefetch" href="/assets/index.html-39345f9e.js" as="script"><link rel="prefetch" href="/assets/index.html-ff324c56.js" as="script"><link rel="prefetch" href="/assets/分布式事务组件Seata.html-0131fd79.js" as="script"><link rel="prefetch" href="/assets/index.html-b9bf36a0.js" as="script"><link rel="prefetch" href="/assets/index.html-55ee6e39.js" as="script"><link rel="prefetch" href="/assets/index.html-1b0a2887.js" as="script"><link rel="prefetch" href="/assets/index.html-486a4fa7.js" as="script"><link rel="prefetch" href="/assets/index.html-02119d7b.js" as="script"><link rel="prefetch" href="/assets/index.html-861e12cc.js" as="script"><link rel="prefetch" href="/assets/index.html-d327d4ff.js" as="script"><link rel="prefetch" href="/assets/index.html-794f5020.js" as="script"><link rel="prefetch" href="/assets/index.html-32c3aca9.js" as="script"><link rel="prefetch" href="/assets/index.html-b4381460.js" as="script"><link rel="prefetch" href="/assets/404.html-71a139bd.js" as="script"><link rel="prefetch" href="/assets/index.html-4abd177e.js" as="script"><link rel="prefetch" href="/assets/index.html-b2d068d3.js" as="script"><link rel="prefetch" href="/assets/index.html-7d1650ce.js" as="script"><link rel="prefetch" href="/assets/index.html-f985e9d6.js" as="script"><link rel="prefetch" href="/assets/index.html-cca33f1c.js" as="script"><link rel="prefetch" href="/assets/index.html-d0ee09e8.js" as="script"><link rel="prefetch" href="/assets/index.html-77f96051.js" as="script"><link rel="prefetch" href="/assets/index.html-fdea51fa.js" as="script"><link rel="prefetch" href="/assets/index.html-a1b8fe06.js" as="script"><link rel="prefetch" href="/assets/index.html-750eeb23.js" as="script"><link rel="prefetch" href="/assets/index.html-fc2ca047.js" as="script"><link rel="prefetch" href="/assets/index.html-190c97b5.js" as="script"><link rel="prefetch" href="/assets/index.html-d0f67543.js" as="script"><link rel="prefetch" href="/assets/index.html-4111a4a6.js" as="script"><link rel="prefetch" href="/assets/index.html-4da107bc.js" as="script"><link rel="prefetch" href="/assets/index.html-dc08afe6.js" as="script"><link rel="prefetch" href="/assets/index.html-e3e83a3a.js" as="script"><link rel="prefetch" href="/assets/index.html-9dd359c6.js" as="script"><link rel="prefetch" href="/assets/index.html-467d9198.js" as="script"><link rel="prefetch" href="/assets/index.html-4736df55.js" as="script"><link rel="prefetch" href="/assets/index.html-fe82f62b.js" as="script"><link rel="prefetch" href="/assets/index.html-730300d8.js" as="script"><link rel="prefetch" href="/assets/index.html-41e1aed8.js" as="script"><link rel="prefetch" href="/assets/index.html-36fa341c.js" as="script"><link rel="prefetch" href="/assets/index.html-37baa2c2.js" as="script"><link rel="prefetch" href="/assets/index.html-cb928e33.js" as="script"><link rel="prefetch" href="/assets/index.html-24b3ba24.js" as="script"><link rel="prefetch" href="/assets/index.html-cb31fddb.js" as="script"><link rel="prefetch" href="/assets/index.html-8b51679b.js" as="script"><link rel="prefetch" href="/assets/index.html-8346c86e.js" as="script"><link rel="prefetch" href="/assets/index.html-b467ec74.js" as="script"><link rel="prefetch" href="/assets/index.html-692696b5.js" as="script"><link rel="prefetch" href="/assets/index.html-f7c9a459.js" as="script"><link rel="prefetch" href="/assets/index.html-2dee1a20.js" as="script"><link rel="prefetch" href="/assets/index.html-1748bbba.js" as="script"><link rel="prefetch" href="/assets/index.html-81ef16f2.js" as="script"><link rel="prefetch" href="/assets/index.html-a3aab6f0.js" as="script"><link rel="prefetch" href="/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/assets/auto-fe80bb03.js" as="script"><link rel="prefetch" href="/assets/index-2bf332f6.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-8a25b1ff.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-67784581.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt="学习笔记"><!----><span class="vp-site-name hide-in-pad">学习笔记</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->微服务架构拆分实战</h1><div class="page-info"><span class="page-author-info" aria-label="作者"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">江</span></span><span property="author" content="江"></span></span><!----><span class="page-date-info" aria-label="写作日期"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-08-30T01:29:32.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 30 分钟</span><meta property="timeRequired" content="PT30M"></span><span class="page-category-info" aria-label="分类"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item clickable" role="navigation">微服务电商平台</span><!--]--><meta property="articleSection" content="微服务电商平台"></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#微服务架构拆分">微服务架构拆分</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#微服务介绍">微服务介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#微服务拆分时机">微服务拆分时机</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#微服务拆分的一些通用原则">微服务拆分的一些通用原则</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#微服务拆分策略">微服务拆分策略</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#拆分注意的风险">拆分注意的风险</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#电商项目微服务拆分">电商项目微服务拆分</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#电商项目微服务架构图">电商项目微服务架构图</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#spring-cloud-spring-cloud-alibaba技术栈选型">Spring Cloud&amp;Spring Cloud Alibaba技术栈选型</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#服务模块的拆分">服务模块的拆分</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#数据库的拆分">数据库的拆分</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#接入nacos注册中心">接入Nacos注册中心</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#接入nacos配置中心">接入Nacos配置中心</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#网关服务搭建">网关服务搭建</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#接入skywalking">接入Skywalking</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#整合elk收集微服务链路日志">整合ELK收集微服务链路日志</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#微服务全链路灰度解决方案">微服务全链路灰度解决方案</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#灰度发布">灰度发布</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#微服务全链路灰度">微服务全链路灰度</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#全链路灰度设计思路">全链路灰度设计思路</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#基于discovery实现全链路灰度">基于Discovery实现全链路灰度</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><ol><li>微服务拆分时机和策略</li><li>微服务技术栈选型以及常用组件的接入</li><li>扩展知识：微服务全链路灰度解决方案实战</li></ol><h2 id="微服务架构拆分" tabindex="-1"><a class="header-anchor" href="#微服务架构拆分" aria-hidden="true">#</a> 微服务架构拆分</h2><h3 id="微服务介绍" tabindex="-1"><a class="header-anchor" href="#微服务介绍" aria-hidden="true">#</a> 微服务介绍</h3><p>英文:<a href="https://martinfowler.com/articles/microservices.html" target="_blank" rel="noopener noreferrer">https://martinfowler.com/articles/microservices.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>中文:<a href="http://blog.cuicc.com/blog/2015/07/22/microservices" target="_blank" rel="noopener noreferrer">http://blog.cuicc.com/blog/2015/07/22/microservices<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://img.jssjqd.cn/202308300129341.png" alt="image-20230830012905464" tabindex="0" loading="lazy"><figcaption>image-20230830012905464</figcaption></figure><p>​ <img src="https://img.jssjqd.cn/202308300129518.png" alt="image-20230830012913502" loading="lazy"></p><p>思考：</p><p><strong>微服务拆分的时机是什么？ 如何决定微服务的拆分粒度？</strong></p><h3 id="微服务拆分时机" tabindex="-1"><a class="header-anchor" href="#微服务拆分时机" aria-hidden="true">#</a> 微服务拆分时机</h3><p>如下场景是否需要进行微服务拆分？</p><ul><li>代码维护困难，几百人同时开发一个模块，提交代码频繁出现大量冲突；</li><li>模块耦合严重，互相依赖，小功能修改也必须累计到大版本才能上线，上线还需要总监协调各个团队开会确定；</li><li>横向扩展流程复杂，主要业务和次要业务耦合。 例如下单和支付业务需要扩容，而注册业务不需要扩容</li></ul><p>​ <img src="https://img.jssjqd.cn/202308292352088.png" alt="image-20230829235211626" loading="lazy"></p><p><strong>微服务不仅仅是技术的升级，更是开发方式、组织架构、开发观念的转变。</strong></p><p>何时进行微服务的拆分：</p><ul><li><strong>业务规模</strong>：业务模式得到市场的验证，需要进一步加快脚步快速占领市场，这时业务的规模变得越来越大，按产品生命周期来划分（导入期、成长期、成熟期、衰退期）这时一般在成长期阶段。如果是导入期，尽量采用单体架构。</li><li><strong>团队规模</strong>：一般是团队达到百人的时候，主要还是要结合业务复杂度</li><li><strong>技术储备</strong>：领域驱动设计、注册中心、配置中心、日志系统、持续交付、监控系统、分布式定时任务、CAP 理论、分布式调用链、API 网关等等。</li><li><strong>人才储备</strong>：精通微服务落地经验的架构师及相应开发人员。</li><li><strong>研发效率</strong>：研发效率大幅下降。</li></ul><h3 id="微服务拆分的一些通用原则" tabindex="-1"><a class="header-anchor" href="#微服务拆分的一些通用原则" aria-hidden="true">#</a> 微服务拆分的一些通用原则</h3><p><strong>单一服务内部功能高内聚低耦合</strong>：每个服务只完成自己职责内的任务，对于不是自己职责的功能交给其它服务来完成</p><p><strong>闭包原则（CCP）</strong>：微服务的闭包原则就是当我们需要改变一个微服务的时候，所有依赖都在这个微服务的组件内，不需要修改其他微服务</p><p><strong>服务自治、接口隔离原则</strong>：尽量消除对其他服务的强依赖，这样可以降低沟通成本，提升服务稳定性。服务通过标准的接口隔离，隐藏内部实现细节。这使得服务可以独立开发、测试、部署、运行，以服务为单位持续交付。</p><p><strong>持续演进原则</strong>：在服务拆分的初期，你其实很难确定服务究竟要拆成什么样。应逐步划分，持续演进，避免服务数量的爆炸性增长。</p><p><strong>拆分的过程尽量避免影响产品的日常功能迭代</strong>：也就是说要一边做产品功能迭代，一边完成服务化拆分。比如优先剥离比较独立的边界服务（如短信服务等），从非核心的服务出发减少拆分对现有业务的影响，也给团队一个练习、试错的机会。同时当两个服务存在依赖关系时优先拆分被依赖的服务。</p><p><strong>服务接口的定义要具备可扩展性</strong>比如微服务的接口因为升级把之前的三个参数改成了四个，上线后导致调用方大量报错，推荐做法服务接口的参数类型最好是封装类，这样如果增加参数就不必变更接口的签名</p><p><strong>避免环形依赖与双向依赖</strong>：尽量不要有服务之间的环形依赖或双向依赖，原因是存在这种情况说明我们的功能边界没有化分清楚或者有通用的功能没有下沉下来。</p><p>​ <img src="https://img.jssjqd.cn/202308292353121.png" alt="image-20230829235340265" loading="lazy"></p><p><strong>阶段性合并</strong>：随着你对业务领域理解的逐渐深入或者业务本身逻辑发生了比较大的变化，亦或者之前的拆分没有考虑的很清楚，导致拆分后的服务边界变得越来越混乱，这时就要重新梳理领域边界，不断纠正拆分的合理性。</p><p><strong>自动化驱动</strong>：部署和运维的成本会随着服务的增多呈指数级增长，每个服务都需要部署、监控、日志分析等运维工作，成本会显著提升。因此，在服务划分之前，应该首先构建自动化的工具及环境。开发人员应该以自动化为驱动力，简化服务在创建、开发、测试、部署、运维上的重复性工作，通过工具实现更可靠的操作，避免微服务数量增多带来的开发、管理复杂度问题。</p><h3 id="微服务拆分策略" tabindex="-1"><a class="header-anchor" href="#微服务拆分策略" aria-hidden="true">#</a> 微服务拆分策略</h3><p><strong>功能维度拆分策略</strong></p><p>大的原则是基于业务复杂度拆分服务： 业务复杂度足够高，应该基于领域驱动拆分服务。业务复杂度较低，选择基于数据驱动拆分服务</p><ul><li>基于数据驱动拆分服务： 自下而上的架构设计方法，通过分析需求，确定整体数据结构，根据表之间的关系拆分服务。</li></ul><p>拆分步骤： 需求分析，抽象数据结构，划分服务，确定调用关系和业务流程验证。</p><ul><li>基于领域驱动拆分服务： 自上而下的架构设计方法，通过和领域专家建立统一的语言，不断交流，确定关键业务场景，逐步确定边界上下文。领域驱动更强调业务实现效果，认为自下而上的设计可能会导致技术人员不能更好地理解业务方向，进而偏离业务目标。</li></ul><p>拆分步骤：通过模型和领域专家建立统一语言，业务分析，寻找聚合，确定服务调用关系，业务流程验证和持续优化。</p><p>以电商的场景为例，交易链路划分的限界上下文如下图左半部分，根据一个限界上下文可以设计一个微服务，拆解出来的微服务如下图右侧部分。</p><p>​ <img src="https://img.jssjqd.cn/202308292354709.png" alt="image-20230829235416900" loading="lazy"></p><p><a href="https://vip.tulingxueyuan.cn/detail/p_6119c193e4b0cce271be5bfc/8" target="_blank" rel="noopener noreferrer">互联网未来架构之道DDD领域驱动设计<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li>还有一种常见拆分场景，从已有单体架构中逐步拆分服务。</li></ul><p>拆分步骤： 前后端分离，提取公共基础服务（如授权服务，分布式ID服务），不断从老系统抽取服务，垂直划分优先，适当水平切分</p><p>以上几种拆分方式不是多选一，而是可以根据实际情况自由排列组合。<strong>同时拆分不仅仅是架构上的调整，也意味着要在组织结构上做出相应的适应性优化，以确保拆分后的服务由相对独立的团队负责维护。</strong></p><p><strong>非功能维度拆分策略</strong></p><p>主要考虑六点包括扩展性、复用性、高性能、高可用、安全性、异构性</p><p><strong>扩展性</strong></p><p>区分系统中变与不变的部分，不变的部分一般是成熟的、通用的服务功能，变的部分一般是改动比较多、满足业务迭代扩展性需要的功能，我们可以将不变的部分拆分出来，作为共用的服务，将变的部分独立出来满足个性化扩展需要</p><p>同时根据二八原则，系统中经常变动的部分大约只占 20%，而剩下的 80% 基本不变或极少变化，这样的拆分也解决了发布频率过多而影响成熟服务稳定性的问题。</p><p><strong>复用性</strong></p><p>不同的业务里或服务里经常会出现重复的功能，比如每个服务都有鉴权、限流、安全及日志监控等功能，可以将这些通过的功能拆分出来形成独立的服务。</p><p><strong>高性能</strong></p><p>将性能要求高或者性能压力大的模块拆分出来，避免性能压力大的服务影响其它服务。</p><p>我们也可以基于读写分离来拆分，比如电商的商品信息，在 App 端主要是商品详情有大量的读取操作，但是写入端商家中心访问量确很少。因此可以对流量较大或较为核心的服务做读写分离，拆分为两个服务发布，一个负责读，另外一个负责写。</p><p>数据一致性是另一个基于性能维度拆分需要考虑的点，对于强一致的数据，属于强耦合，尽量放在同一个服务中（但是有时会因为各种原因需要进行拆分，那就需要有响应的机制进行保证），弱一致性通常可以拆分为不同的服务。</p><p><strong>高可用</strong></p><p>将可靠性要求高的核心服务和可靠性要求低的非核心服务拆分开来，然后重点保证核心服务的高可用。</p><p><strong>安全性</strong></p><p>不同的服务可能对信息安全有不同的要求，因此把需要高度安全的服务拆分出来，进行区别部署，比如设置特定的 DMZ 区域对服务进行分区部署，可以更有针对性地满足信息安全的要求，也可以降低对防火墙等安全设备吞吐量、并发性等方面的要求，降低成本，提高效率。</p><p><strong>异构性</strong></p><p>对于对开发语言种类有要求的业务场景，可以用不同的语言将其功能独立出来实现一个独立服务。</p><h3 id="拆分注意的风险" tabindex="-1"><a class="header-anchor" href="#拆分注意的风险" aria-hidden="true">#</a> 拆分注意的风险</h3><p>**不打无准备之仗：**开发团队是否具备足够的经验，能否驾驭微服务的技术栈，可能是第一个需要考虑的点。</p><p>**不断纠正：**我们需要承认我们的认知是有限的，只能基于目前的业务状态和有限的对未来的预测来制定出一个相对合适的拆分方案，而不是所谓的最优方案，任何方案都只能保证在当下提供了相对合适的粒度和划分原则，要时刻做好在未来的末一个时刻会变得不和时宜、需要再次调整的准备。</p><p>**要做行动派，而不是理论派：**在具体怎么拆分上，也不要太纠结于是否合适，如果拆了之后发现真的不合适，在重新调整就好了。如果要灵活调整，可以针对服务化架构搭建起一套完成的能力体系，比如服务治理平台、数据迁移工具、数据双写等等</p><p><strong>服务只拆不合：</strong></p><ul><li>拆相当于我们开发代码，合相当于重构代码。随着我们对应用程序领域的了解越来越深，它们需要随着时间的推移而变化。</li><li>人员和服务数量的不匹配，导致的维护成本增加，也是导致服务合并的一个重要原因。</li><li>如果微服务数量过多和资源不匹配，则可以考虑合并多个微服务到服务包，部署到一台服务器，这样可以节省服务运行时的基础资源消耗也降低了维护成本。需要注意的是，虽然服务包是运行在一个进程中，但是服务包内的服务依然要满足微服务定义，以便在未来某一天要重新拆开的时候可以很快就分离</li></ul><p>​ <img src="https://img.jssjqd.cn/202308292354398.png" alt="image-20230829235437575" loading="lazy"></p><h2 id="电商项目微服务拆分" tabindex="-1"><a class="header-anchor" href="#电商项目微服务拆分" aria-hidden="true">#</a> 电商项目微服务拆分</h2><h3 id="电商项目微服务架构图" tabindex="-1"><a class="header-anchor" href="#电商项目微服务架构图" aria-hidden="true">#</a> 电商项目微服务架构图</h3><p>五期项目的各个模块和中间件组合起来，发挥着各自的作用，组成了如下图 所示的<a href="https://www.processon.com/view/link/633176c3e0b34d33007f2c4f" target="_blank" rel="noopener noreferrer">架构图<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>：</p><p>​ <img src="https://img.jssjqd.cn/202308292354860.png" alt="image-20230829235448858" loading="lazy"></p><h3 id="spring-cloud-spring-cloud-alibaba技术栈选型" tabindex="-1"><a class="header-anchor" href="#spring-cloud-spring-cloud-alibaba技术栈选型" aria-hidden="true">#</a> Spring Cloud&amp;Spring Cloud Alibaba技术栈选型</h3><p>Spring Cloud Alibaba官网：<a href="https://github.com/alibaba/spring-cloud-alibaba/wiki" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/spring-cloud-alibaba/wiki<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>SpringCloud的几大痛点：</p><ul><li>SpringCloud部分组件停止维护和更新，给开发带来不便;</li><li>SpringCloud部分环境搭建复杂，没有完善的可视化界面，我们需要大量的二次开发和定制</li><li>SpringCloud配置复杂，难以上手，部分配置差别难以区分和合理应用</li></ul><p>SpringCloud Alibaba的优势:</p><ul><li>阿里使用过的组件经历了考验，性能强悍，设计合理，现在开源出来大家用成套的产品搭配完善的可视化界面给开发运维带来极大的便利</li><li>搭建简单，学习曲线低。</li></ul><p>所以我们优先选择Spring Cloud Alibaba提供的微服务组件</p><p>Spring Cloud Alibaba官方推荐版本选择:</p><p><a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><table><thead><tr><th>Spring Cloud Alibaba Version</th><th>Spring Cloud Version</th><th>Spring Boot Version</th></tr></thead><tbody><tr><td>2.2.6.RELEASE</td><td>Spring Cloud Hoxton.SR9</td><td>2.3.2.RELEASE</td></tr></tbody></table><p><strong>关于依赖下载不下来的问题：</strong></p><ol><li>idea使用专业版，检查idea的maven环境配置</li><li>maven配置<a href="https://developer.aliyun.com/mvn/guide" target="_blank" rel="noopener noreferrer">阿里云镜像<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ol><h3 id="服务模块的拆分" tabindex="-1"><a class="header-anchor" href="#服务模块的拆分" aria-hidden="true">#</a> 服务模块的拆分</h3><p>五期项目是在以前的项目上发展而来，在业务上基本保持不动，但做了更细 致的微服务拆分，大体上秉承了前面所说的微服务设计原则，同时在具体的业务 模块实现上，根据实际资源情况和教学、授课要求做了一定程度的取舍和合并。具体来说，相对一般的电商系统，我们没有单独实现账户、库存、支付服务，报 表往往需要和 BI（Business Intelligence）报表框架集成，所以也未实现。因为说到底，我们学习本项目的目的是为了学习技术而不是为了学习电商业务。</p><p>​ <img src="https://img.jssjqd.cn/202308292355810.png" alt="image-20230829235551621" loading="lazy"></p><ul><li>tulingmall-authcenter 认证中心程序</li><li>tulingmall-canal 数据同步程序</li><li>tulingmall-cart 购物车程序</li><li>tulingmall-common 通用模块，被其他程序以 jar 包形式使用</li><li>tulingmall-core 遗留模块，主要包含 model 的声明，被其他程序以 jar 包形 式使用</li><li>tulingmall-gateway 网关程序</li><li>tulingmall-member 用户管理程序</li><li>tulingmall-order-curr 订单程序</li><li>tulingmall-order-history 历史订单处理程序</li><li>tulingmall-portal 商城首页入口程序</li><li>tulingmall-product 商品管理程序</li><li>tulingmall-promotion 促销管理程序</li><li>tulingmall-redis-comm 缓存模块，被其他程序以 jar 包形式使用</li><li>tulingmall-redis-multi 多源缓存模块，被其他程序以 jar 包形式使用</li><li>tulingmall-search 商品搜索程序</li><li>tulingmall-security 安全模块，被其他程序以 jar 包形式使用</li><li>tulingmall-sk-cart 秒杀确认单处理</li><li>tulingmall-sk-order 秒杀订单处理</li><li>tulingmall-unqid 分布式 ID 生成程序</li></ul><p>本节课会以tulingmall-member，tulingmall-promotion模块演示接入微服务Spring Cloud&amp;Spring Cloud Alibaba技术栈</p><p><strong>课后作业</strong></p><p>电商项目单体架构版本进行微服务拆分</p><p><a href="https://vip.tulingxueyuan.cn/detail/p_607e83a2e4b09134c989f5cd/8?product_id=p_607e83a2e4b09134c989f5cd" target="_blank" rel="noopener noreferrer">https://vip.tulingxueyuan.cn/detail/p_607e83a2e4b09134c989f5cd/8?product_id=p_607e83a2e4b09134c989f5cd<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="数据库的拆分" tabindex="-1"><a class="header-anchor" href="#数据库的拆分" aria-hidden="true">#</a> 数据库的拆分</h3><p>整个项目中数据库被拆分为：</p><ul><li>商品库 : tl_mall_goods</li><li>促销库 : tl_mall_promotion</li><li>用户库 : tl_mall_user</li><li>其他库 : tl_mall_normal</li><li>订单库 : tl_mall_order</li><li>购物车库: tl_mall_cart</li></ul><p><strong>课程关键 Table</strong></p><ul><li>用户库 ums_member ，用户/会员表</li><li>商品库 pms_product 商品表，主要包括四部分：商品的基本信息、商品的 促销信息、商品的属性信息、商品的关联</li><li>商品库 pms_sku_stock 商品 SKU 库存表</li><li>订单库 oms_order 订单表</li><li>订单库 oms_order_item 订单详情表，订单中包含的商品信息，一个订单中 会有多个订单商品信息，所以 oms_order 和它是一对多的关系</li><li>促销库 sms_home_brand 首页品牌推荐表</li><li>促销库 sms_home_new_product 首页显示的新鲜好物信息</li><li>促销库 sms_home_recommend_product 首页显示的人气推荐信息</li><li>促销库 sms_home_recommend_subject 首页显示的专题精选信息</li><li>促销库 sms_home_advertise 首页显示的轮播广告信息</li><li>促销库 sms_flash_promotion 秒杀/限时购活动的信息</li><li>促销库 sms_flash_promotion_product_relation 存储与秒杀/限时购相关的 商品信息，也包含了秒杀/限时购的库存信息</li></ul><h3 id="接入nacos注册中心" tabindex="-1"><a class="header-anchor" href="#接入nacos注册中心" aria-hidden="true">#</a> 接入Nacos注册中心</h3><p>​ <img src="https://img.jssjqd.cn/202308292358615.png" alt="image-20230829235844467" loading="lazy"></p><p>注意：项目使用的nacos server版本：v1.4.3</p><p><a href="https://github.com/alibaba/nacos/releases/download/1.4.3/nacos-server-1.4.3.zip" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/nacos/releases/download/1.4.3/nacos-server-1.4.3.zip<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>将微服务注册到Nacos Server</p><p>1）引入依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--nacos 注册中心 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）在yml中配置注册中心地址</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mall<span class="token punctuation">-</span>order  <span class="token comment">#微服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.65.103<span class="token punctuation">:</span><span class="token number">8848</span>    <span class="token comment">#注册中心地址</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 6cd8d896<span class="token punctuation">-</span>4d19<span class="token punctuation">-</span>4e33<span class="token punctuation">-</span>9840<span class="token punctuation">-</span>26e4bee9a618   <span class="token comment">#环境隔离          </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="接入nacos配置中心" tabindex="-1"><a class="header-anchor" href="#接入nacos配置中心" aria-hidden="true">#</a> 接入Nacos配置中心</h3><p>使用nacos作为微服务配置中心</p><p>1）引入依赖</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;!-- nacos 配置中心 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2） 创建bootstrap.yml文件，添加配置中心的配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>member  <span class="token comment">#微服务的名称</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">serverAddr</span><span class="token punctuation">:</span> 192.168.65.103<span class="token punctuation">:</span><span class="token number">8848</span>  <span class="token comment">#配置中心的地址</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 6cd8d896<span class="token punctuation">-</span>4d19<span class="token punctuation">-</span>4e33<span class="token punctuation">-</span>9840<span class="token punctuation">-</span>26e4bee9a618  
        <span class="token comment"># dataid 为 yml 的文件扩展名配置方式</span>
        <span class="token comment"># `${spring.application.name}.${file-extension:properties}`</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yml

        <span class="token comment">#通用配置</span>
        shared<span class="token punctuation">-</span>configs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
          <span class="token key atrule">data-id</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>nacos.yml
          <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
          <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        shared<span class="token punctuation">-</span>configs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
          <span class="token key atrule">data-id</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>redis.yml <span class="token comment"># redis服务集群配置</span>
          <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
          <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token comment">#profile粒度的配置</span>
<span class="token comment">#`${spring.application.name}-${profile}.${file-extension:properties}`</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev         
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3） 添加微服务配置和公共的配置到nacos配置中心 <img src="https://img.jssjqd.cn/202308300002722.png" alt="image-20230830000204836" loading="lazy"></p><p><strong>2.7 基于openfeign实现微服务间的调用</strong></p><p>使用openfeign作为服务间调用组件，业务场景： 用户查询优惠券</p><p>1）引入依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 服务远程调用 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）编写调用接口+@FeignClient注解，指定要调用的微服务及其接口方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;tulingmall-coupons&quot;</span><span class="token punctuation">,</span>path <span class="token operator">=</span> <span class="token string">&quot;/coupon&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponsFeignService</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/list&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SmsCouponHistory</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;useStatus&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> useStatus
            <span class="token punctuation">,</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）启动类添加@EnableFeignClients注解，开启openFeign远程调用功能</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TulingmallMemberApplication</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TulingmallMemberApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4） 测试，发起远程服务调用</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">CouponsFeignService</span> couponsFeignService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/coupons&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">getCoupons</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;useStatus&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> useStatus
        <span class="token punctuation">,</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> memberId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 通过openfeign从远程微服务tulingmall-coupons获取优惠券信息</span>
    <span class="token keyword">return</span> couponsFeignService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>useStatus<span class="token punctuation">,</span> memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5）开启openfeign日志配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignConfig</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span><span class="token constant">FULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果日志不显示，可以在yml中通过logging.level设置日志级别</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">com.tuling</span><span class="token punctuation">:</span> debug
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>扩展场景：实现RequestInterceptor，添加请求头参数用于传递memberId</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeaderInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> attributes<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;从Request中解析请求头&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">,</span>request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

# <span class="token class-name">FeignConfig</span><span class="token punctuation">.</span>java中添加拦截器配置
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeaderInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>RequestInterceptor作用：在发送请求前，对发送的模板进行操作，例如设置请求头等属性。</strong></p><h3 id="网关服务搭建" tabindex="-1"><a class="header-anchor" href="#网关服务搭建" aria-hidden="true">#</a> 网关服务搭建</h3><p>创建tulingmall-gateway服务</p><p>1） 引入依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- gateway网关 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- nacos服务注册与发现 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- nacos 配置中心 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：会和spring-webmvc的依赖冲突，需要排除spring-webmvc</p><p>2） 编写yml配置文件</p><p>application.yml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>gateway
  <span class="token comment">#配置nacos注册中心地址</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.65.103<span class="token punctuation">:</span><span class="token number">8848</span>  <span class="token comment">#注册中心地址</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 6cd8d896<span class="token punctuation">-</span>4d19<span class="token punctuation">-</span>4e33<span class="token punctuation">-</span>9840<span class="token punctuation">-</span>26e4bee9a618  <span class="token comment">#环境隔离</span>

    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>member   <span class="token comment">#路由ID，全局唯一</span>
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//tulingmall<span class="token punctuation">-</span>member
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/member/<span class="token important">**</span><span class="token punctuation">,</span>/sso/<span class="token important">**</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>promotion
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//tulingmall<span class="token punctuation">-</span>promotion
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/coupon/<span class="token important">**</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">org.springframework.cloud.gateway</span><span class="token punctuation">:</span> debug          
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）gateway配置移植到配置中心，添加bootstrap.yml ：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>gateway  <span class="token comment">#微服务的名称</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">serverAddr</span><span class="token punctuation">:</span> 192.168.65.103<span class="token punctuation">:</span><span class="token number">8848</span>  <span class="token comment">#配置中心的地址</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 6cd8d896<span class="token punctuation">-</span>4d19<span class="token punctuation">-</span>4e33<span class="token punctuation">-</span>9840<span class="token punctuation">-</span>26e4bee9a618
        <span class="token comment"># dataid 为 yml 的文件扩展名配置方式</span>
        <span class="token comment"># `${spring.application.name}.${file-extension:properties}`</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yml

        <span class="token comment">#通用配置</span>
        shared<span class="token punctuation">-</span>configs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
          <span class="token key atrule">data-id</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>nacos.yml
          <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
          <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token comment">#profile粒度的配置</span>
  <span class="token comment">#`${spring.application.name}-${profile}.${file-extension:properties}`</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev           
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="接入skywalking" tabindex="-1"><a class="header-anchor" href="#接入skywalking" aria-hidden="true">#</a> 接入Skywalking</h3><p><strong>1） 搭建Skywalking OAP服务</strong></p><p>参考微服务专题Skywalking课程</p><p>​ <img src="https://img.jssjqd.cn/202308300047074.png" alt="image-20230830004659118" loading="lazy"></p><p><strong>2） 微服务配置Skywalking Agent</strong></p><p>以tulingmall-member为例，在jvm参数中增加agent配置</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>-javaagent:D:<span class="token punctuation">\</span>apache<span class="token punctuation">\</span>apache-skywalking-java-agent-8.11.0<span class="token punctuation">\</span>skywalking-agent<span class="token punctuation">\</span>skywalking-agent.jar
<span class="token parameter variable">-Dskywalking.agent.service_name</span><span class="token operator">=</span>tulingmall-member
<span class="token parameter variable">-Dskywalking.collector.backend_service</span><span class="token operator">=</span><span class="token number">192.168</span>.65.103:11800
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问Skywalking UI : <a href="http://192.168.65.103:8080/" target="_blank" rel="noopener noreferrer">http://192.168.65.103:8080/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><strong>3） 集成日志框架，生成traceId</strong></p><p><a href="https://skywalking.apache.org/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-logback-1.x/" target="_blank" rel="noopener noreferrer">logback官方配置<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>引入依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- apm-toolkit-logback-1.x --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.skywalking<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>apm-toolkit-logback-1.x<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加logback日志文件logback-spring.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 引入 Spring Boot 默认的 logback XML 配置文件  --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org/springframework/boot/logging/logback/defaults.xml<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    
    <span class="token comment">&lt;!-- 控制台 Appender --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>console<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 日志的格式化 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.encoder.LayoutWrappingEncoder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.apache.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Pattern</span><span class="token punctuation">&gt;</span></span>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %tid %t %logger{36}: %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Pattern</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 从 Spring Boot 配置文件中，读取 spring.application.name 应用名 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>springProperty</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>applicationName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>context<span class="token punctuation">&quot;</span></span> <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>spring.application.name<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    
    <span class="token comment">&lt;!-- 日志文件 Appender --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 日志文件的路径 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>/logs/tulingmall/${applicationName}.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--滚动策略，基于时间 + 大小的分包策略 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.rolling.TimeBasedRollingPolicy<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>/logs/tulingmall/${applicationName}-%d{yyyy-MM-dd}-%i.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxHistory</span><span class="token punctuation">&gt;</span></span>20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxHistory</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeBasedFileNamingAndTriggeringPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxFileSize</span><span class="token punctuation">&gt;</span></span>500MB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxFileSize</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeBasedFileNamingAndTriggeringPolicy</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 日志的格式化 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.encoder.LayoutWrappingEncoder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.apache.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!-- 日志格式中添加 %tid 即可输出 trace id --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Pattern</span><span class="token punctuation">&gt;</span></span>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %tid %t %logger{36}: %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Pattern</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 设置 Appender --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>DEBUG<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>console<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="整合elk收集微服务链路日志" tabindex="-1"><a class="header-anchor" href="#整合elk收集微服务链路日志" aria-hidden="true">#</a> 整合ELK收集微服务链路日志</h3><figure><img src="https://img.jssjqd.cn/202308300114978.png" alt="image-20230830011446164" tabindex="0" loading="lazy"><figcaption>image-20230830011446164</figcaption></figure><h4 id="方案一-使用logstash日志插件" tabindex="-1"><a class="header-anchor" href="#方案一-使用logstash日志插件" aria-hidden="true">#</a> <strong>方案一：使用logstash日志插件</strong></h4><p><strong>1）引入依赖</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.logstash.logback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>logstash-logback-encoder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>6.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2）logback-spring.xml中添加logstash配置</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- add converter for %tid --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conversionRule</span> <span class="token attr-name">conversionWord</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tid<span class="token punctuation">&quot;</span></span> <span class="token attr-name">converterClass</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.apache.skywalking.apm.toolkit.log.logback.v1.x.LogbackPatternConverter<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token comment">&lt;!-- add converter for %sw_ctx --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conversionRule</span> <span class="token attr-name">conversionWord</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sw_ctx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">converterClass</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.apache.skywalking.apm.toolkit.log.logback.v1.x.LogbackSkyWalkingContextPatternConverter<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>LOGSTASH<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>net.logstash.logback.appender.LogstashTcpSocketAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>destination</span><span class="token punctuation">&gt;</span></span>192.168.65.25:9527<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>destination</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>providers</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timestamp</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeZone</span><span class="token punctuation">&gt;</span></span>UTC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeZone</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timestamp</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>
                    {
                    &quot;level&quot;: &quot;%level&quot;,
                    &quot;tid&quot;: &quot;%tid&quot;,
                    &quot;skyWalkingContext&quot;: &quot;%sw_ctx&quot;,
                    &quot;thread&quot;: &quot;%thread&quot;,
                    &quot;class&quot;: &quot;%logger{1.}:%L&quot;,
                    &quot;message&quot;: &quot;%message&quot;,
                    &quot;stackTrace&quot;: &quot;%exception{10}&quot;
                    }
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>providers</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 设置 Appender --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>LOGSTASH<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3）添加tulingmall-logstash.conf配置，启动logstash</strong></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">input</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">    tcp</span> <span class="token value attr-value">{        </span>
<span class="token comment">	# 在9527端口接收logback传来的日志</span>
<span class="token key attr-name">        host</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; &quot;0.0.0.0&quot;</span>
<span class="token key attr-name">        port</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; 9527</span>
<span class="token key attr-name">        mode</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; &quot;server&quot;</span>
<span class="token key attr-name">        tags</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; [&quot;tulingmall&quot;]</span>
<span class="token key attr-name">        codec</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; json_lines</span>
    }
}
<span class="token key attr-name">filter</span> <span class="token value attr-value">{</span>
}
<span class="token key attr-name">output</span> <span class="token value attr-value">{</span>
<span class="token comment">    #控制台输出</span>
<span class="token key attr-name">    stdout</span> <span class="token value attr-value">{ codec =&gt; rubydebug }</span>
<span class="token comment">    #输出到es</span>
<span class="token key attr-name">    elasticsearch</span> <span class="token value attr-value">{ </span>
<span class="token key attr-name">	    hosts</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; [&quot;127.0.0.1:9200&quot;]</span>
<span class="token key attr-name">	    user</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; &quot;elastic&quot;</span>
<span class="token key attr-name">	    password</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; &quot;123456&quot;</span>
<span class="token key attr-name">	    index</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; &quot;tulingmall-%{+YYYY.MM.dd}&quot;</span>
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动logstash</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/logstash <span class="token parameter variable">-f</span> tulingmall-logstash.conf <span class="token parameter variable">--config.reload.automatic</span>
<span class="token comment"># 后台启动</span>
<span class="token function">nohup</span> bin/logstash <span class="token parameter variable">-f</span> tulingmall-logstash.conf <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>tulingmall.log <span class="token operator">&amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="方案二-标准的elk收集方案-通过filebeat收集本地日志" tabindex="-1"><a class="header-anchor" href="#方案二-标准的elk收集方案-通过filebeat收集本地日志" aria-hidden="true">#</a> <strong>方案二：标准的ELK收集方案：通过FileBeat收集本地日志</strong></h4><p><strong>1） 启动FileBeat收集本地日志</strong></p><p>修改filebeat.yml的配置，指定日志收集地址和logstash地址</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> f<span class="token punctuation">:</span>\logs\tulingmall\<span class="token important">*.log</span>
  <span class="token key atrule">multiline.pattern</span><span class="token punctuation">:</span> <span class="token string">&#39;^\d{4}\-\d{2}\-\d{2}\s\d{2}\:\d{2}\:\d{2}\.\d{3}&#39;</span>
  <span class="token key atrule">multiline.negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">multiline.match</span><span class="token punctuation">:</span> after
<span class="token comment">#----------------------------- Logstash output --------------------------------</span>
<span class="token key atrule">output.logstash</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;192.168.65.220:5044&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动FileBeats</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#启动FileBeats</span>
filebeat.exe <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> filebeat.yml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2） Logstash 解析 Trace ID</strong></p><p>通过 grok 自定义正则表达式，可以从日志行中抽取出 trace id，就可以在 es 中建立索引，方便日志检索。使用 (?[0-9a-f.]{53,54} 即可抽取出 trace id。</p><figure><img src="https://img.jssjqd.cn/202308300116945.png" alt="image-20230830011658093" tabindex="0" loading="lazy"><figcaption>image-20230830011658093</figcaption></figure><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>input <span class="token punctuation">{</span>
    beats <span class="token punctuation">{</span>
        port =&gt; <span class="token number">5044</span>
        codec =&gt; <span class="token string">&quot;json&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

filter <span class="token punctuation">{</span>
    grok <span class="token punctuation">{</span>
        match =&gt; <span class="token punctuation">{</span>
          <span class="token string">&quot;message&quot;</span> =&gt; <span class="token string">&quot;(?&lt;time&gt;\d{4}\-\d{2}\-\d{2}\s\d{2}\:\d{2}\:\d{2}\.\d{3})\s(?&lt;level&gt;\w{4,5})\s+\T\I\D\:\s*(?&lt;trace_id&gt;[0-9a-f.]{53,54})\s%{DATA:thread}\s%{DATA:class}\:%{GREEDYDATA:content}&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    mutate <span class="token punctuation">{</span>
        remove_field =&gt; <span class="token string">&quot;message&quot;</span> # 删除原始日志内容节省存储和带宽
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

output <span class="token punctuation">{</span>
    elasticsearch <span class="token punctuation">{</span>
        hosts =&gt; <span class="token punctuation">[</span><span class="token string">&quot;192.168.65.220:9200&quot;</span><span class="token punctuation">]</span>
        index =&gt; <span class="token string">&quot;tlmall-log&quot;</span> # ES 重建立索引
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动Logstash</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 测试配置是否正确</span>
bin/logstash <span class="token parameter variable">-f</span> config/tlmall-skywalking.conf <span class="token parameter variable">--config.test_and_exit</span>
<span class="token comment">#启动Logstash</span>
bin/logstash <span class="token parameter variable">-f</span> config/tlmall-skywalking.conf <span class="token parameter variable">--config.reload.automatic</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试：在kibana中根据trace_id搜索对应的系统日志</strong></p><p>整合 Skywalking 和 ELK 后，通过 trace id，在 Skywaling 中快速看到链路中哪个环节出了问题，然后在 ELK 中按 trace id 搜索对应的系统日志，这样就可以很方便的定位出问题，为线上排障提供了方便。 <a href="http://192.168.65.25:5601/" target="_blank" rel="noopener noreferrer">http://192.168.65.25:5601/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://img.jssjqd.cn/202308300122597.png" alt="image-20230830012234498" tabindex="0" loading="lazy"><figcaption>image-20230830012234498</figcaption></figure><h2 id="微服务全链路灰度解决方案" tabindex="-1"><a class="header-anchor" href="#微服务全链路灰度解决方案" aria-hidden="true">#</a> 微服务全链路灰度解决方案</h2><h3 id="灰度发布" tabindex="-1"><a class="header-anchor" href="#灰度发布" aria-hidden="true">#</a> 灰度发布</h3><p><strong>概念</strong></p><p>灰度发布 Gray Release（又名金丝雀发布 Canary Release）。不停机旧版本，部署新版本，高比例流量（例如：95%）走旧版本，低比例流量（例如：5%）切换到新版本，通过监控观察无问题，逐步扩大范围，最终把所有流量都迁移到新版本上。属无损发布。</p><p>​ <img src="https://img.jssjqd.cn/202308300123909.png" alt="image-20230830012305739" loading="lazy"></p><p><strong>优点</strong></p><p>灵活简单，不需要用户标记驱动。安全性高，新版本如果出现问题，只会发生在低比例的流量上</p><p><strong>缺点</strong></p><p>成本较高，需要部署稳定/灰度两套环境</p><h3 id="微服务全链路灰度" tabindex="-1"><a class="header-anchor" href="#微服务全链路灰度" aria-hidden="true">#</a> 微服务全链路灰度</h3><p>微服务体系架构中，服务之间的依赖关系错综复杂，有时某个功能发版依赖多个服务同时升级上线。我们希望可以对这些服务的新版本同时进行小流量灰度验证，这就是微服务架构中特有的全链路灰度场景，通过构建从网关到整个后端服务的环境隔离来对多个不同版本的服务进行灰度验证。在发布过程中，我们只需部署服务的灰度版本，流量在调用链路上流转时，由流经的网关、各个中间件以及各个微服务来识别灰度流量，并动态转发至对应服务的灰度版本。如下图：</p><p>​ <img src="https://img.jssjqd.cn/202308300123587.png" alt="image-20230830012313648" loading="lazy"></p><p>上图可以很好展示这种方案的效果，我们用不同的颜色来表示不同版本的灰度流量，可以看出无论是微服务网关还是微服务本身都需要识别流量，根据治理规则做出动态决策。当服务版本发生变化时，这个调用链路的转发也会实时改变。相比于利用机器搭建的灰度环境，这种方案不仅可以节省大量的机器成本和运维人力，而且可以帮助开发者实时快速的对线上流量进行精细化的全链路控制。</p><h3 id="全链路灰度设计思路" tabindex="-1"><a class="header-anchor" href="#全链路灰度设计思路" aria-hidden="true">#</a> 全链路灰度设计思路</h3><p>那么全链路灰度具体是如何实现呢?</p><p>我们需要解决以下问题:</p><p>1.链路上各个组件和服务能够根据请求流量特征进行动态路由。</p><p>2.需要对服务下的所有节点进行分组，能够区分版本。</p><p>3.需要对流量进行灰度标识、版本标识。</p><p>4.需要识别出不同版本的灰度流量。</p><p><strong>标签路由</strong></p><p>标签路由通过对服务下所有节点按照标签名和标签值不同进行分组，使得订阅该服务节点信息的服务消费端可以按需访问该服务的某个分组，即所有节点的一个子集。服务消费端可以使用服务提供者节点上的任何标签信息，根据所选标签的实际含义，消费端可以将标签路由应用到更多的业务场景中。</p><p><strong>节点打标</strong></p><p>那么如何给服务节点添加不同的标签呢？</p><p>在使用Kubernetes Service作为服务发现的业务系统中，服务提供者通过向ApiServer提交Service资源完成服务暴露，服务消费端监听与该Service资源下关联的Endpoint资源，从Endpoint资源中获取关联的业务Pod 资源，读取上面的Labels数据并作为该节点的元数据信息。所以，我们只要在业务应用描述资源Deployment中的Pod模板中为节点添加标签即可。</p><p>​ <img src="https://img.jssjqd.cn/202308300123072.png" alt="image-20230830012323113" loading="lazy"></p><p>在使用Nacos作为服务发现的业务系统中，一般是需要业务根据其使用的微服务框架来决定打标方式。如果Java应用使用的Spring Cloud微服务开发框架，我们可以为业务容器添加对应的环境变量来完成标签的添加操作。比如我们希望为节点添加版本灰度标，那么为业务容器添加<code>spring.cloud.nacos.discovery.metadata.version=gray</code>，这样框架向Nacos注册该节点时会为其添加一个标签<code>verison=gray</code>。</p><p>​ <img src="https://img.jssjqd.cn/202308300123123.png" alt="image-20230830012327991" loading="lazy"></p><p><strong>流量染色</strong></p><p>请求链路上各个组件如何识别出不同的灰度流量?</p><p>答案就是流量染色，为请求流量添加不同灰度标识来方便区分。我们可以在请求的源头上对流量进行染色，前端在发起请求时根据用户信息或者平台信息的不同对流量进行打标。如果前端无法做到，我们也可以在微服务网关上对匹配特定路由规则的请求动态添加流量标识。此外，流量在链路中流经灰度节点时，如果请求信息中不含有灰度标识，需要自动为其染色，接下来流量就可以在后续的流转过程中优先访问服务的灰度版本。</p><p><strong>分布式链路追踪</strong></p><p>如何保证灰度标识能够在链路中一直传递下去呢?</p><p>借助于分布式链路追踪思想，我们也可以传递一些自定义信息，比如灰度标识。</p><p><strong>总结</strong></p><p>首先，需要支持动态路由功能，对于Spring Cloud、Dubbo开发框架，可以对出口流量实现自定义Filter，在该Filter中完成流量识别以及标签路由。同时需要借助分布式链路追踪技术完成流量标识链路传递以及流量自动染色。此外，需要引入一个中心化的流量治理平台，方便各个业务线的开发者定义自己的全链路灰度规则。</p><p>实现全链路灰度的能力，无论是成本还是技术复杂度都是比较高的，以及后期的维护、扩展都是非常大的成本。</p><h3 id="基于discovery实现全链路灰度" tabindex="-1"><a class="header-anchor" href="#基于discovery实现全链路灰度" aria-hidden="true">#</a> 基于Discovery实现全链路灰度</h3><p><a href="https://github.com/Nepxion/Discovery" target="_blank" rel="noopener noreferrer">Discovery【探索】<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>企业级云原生微服务开源解决方案</p><p>官方文档：<a href="http://nepxion.gitee.io/discovery/#/?id=%E5%85%A8%E9%93%BE%E8%B7%AF%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83" target="_blank" rel="noopener noreferrer">全链路灰度发布<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://github.com/Nepxion/Discovery/wiki" target="_blank" rel="noopener noreferrer">https://github.com/Nepxion/Discovery/wiki<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><strong>Discovery版本选择</strong></p><p>当前项目可以选择Discovery版本6.12.1</p><p>​ <img src="https://img.jssjqd.cn/202308300123053.png" alt="image-20230830012346999" loading="lazy"></p><p>父pom引入Discovery</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--discovery 相关依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.nepxion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>6.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>网关服务接入Dicovery</strong></p><p>1）引入依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 1.注册中心插件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.nepxion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>discovery-plugin-register-center-starter-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 2.配置中心插件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.nepxion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>discovery-plugin-config-center-starter-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 3.管理中心插件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.nepxion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>discovery-plugin-admin-center-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 4.网关策略编排插件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.nepxion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>discovery-plugin-strategy-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）application.yml中添加discovery配置</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>spring:
  application:
    name: tulingmall-gateway
    strategy:     #discovery配置
      gateway:
        dynamic:
          route:
            enabled: true  # 开启网关订阅配置中心的动态路由策略,默认为false
  cloud:
    nacos:  #配置nacos注册中心地址
      discovery:
        server-addr: 192.168.65.103:8848  #注册中心地址
        namespace: 6cd8d896-4d19-4e33-9840-26e4bee9a618  #环境隔离
    
    discovery:  #discovery配置，设置流量染色的元数据
      metadata:
        group: discovery-group      #组名必须配置     
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>根据实际的灰度发布维度和场景，配置染色方式的元数据。</strong></p><p>组名必须要配置，版本、区域、环境和可用区根据具体场景选择其中一种或者几种进行配置</p><p>spring.cloud.discovery.metadata.group=discovery-guide-group</p><p>spring.cloud.discovery.metadata.version=1.0</p><p>spring.cloud.discovery.metadata.region=dev</p><p>spring.cloud.discovery.metadata.env=env1</p><p>spring.cloud.discovery.metadata.zone=zone1</p><p>spring.cloud.discovery.metadata.active=true</p></blockquote><p><strong>应用微服务接入Dicovery</strong></p><p>1）引入依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 1.注册中心插件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.nepxion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>discovery-plugin-register-center-starter-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 2.配置中心插件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.nepxion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>discovery-plugin-config-center-starter-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 3.管理中心插件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.nepxion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>discovery-plugin-admin-center-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 4.服务策略编排插件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.nepxion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>discovery-plugin-strategy-starter-service<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）application.yml中添加discovery配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">main</span><span class="token punctuation">:</span>
    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>member
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.65.103<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 6cd8d896<span class="token punctuation">-</span>4d19<span class="token punctuation">-</span>4e33<span class="token punctuation">-</span>9840<span class="token punctuation">-</span>26e4bee9a618
    
    <span class="token key atrule">discovery</span><span class="token punctuation">:</span> <span class="token comment">#discovery配置，设置流量染色的元数据</span>
      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> discovery<span class="token punctuation">-</span>group  <span class="token comment">#组名必须配置</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">1.0</span>   <span class="token comment">#指定版本号          </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>全链路版本权重灰度发布</strong></p><p>在nacos配置中心中增加网关的版本权重灰度发布策略，Group为discovery-group，Data Id为tulingmall-gateway，策略内容如下，实现从网关发起的调用全链路1.0版本流量权重为90%，1.1版本流量权重为10%</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strategy</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version-weight</span><span class="token punctuation">&gt;</span></span>1.0=90;1.1=10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version-weight</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strategy</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也可以指定具体每个微服务的版本权重</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strategy</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version-weight</span><span class="token punctuation">&gt;</span></span>{&quot;tulingmall-member&quot;:&quot;1.0=90;1.1=10&quot;, &quot;tulingmall-promotion&quot;:&quot;1.0=90;1.1=10&quot;}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version-weight</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strategy</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://img.jssjqd.cn/202308300127066.png" alt="image-20230830012722304" tabindex="0" loading="lazy"><figcaption>image-20230830012722304</figcaption></figure><p>结合课堂代码进行测试</p><p><strong>全链路版本条件权重灰度发布</strong></p><p><strong>指定百分比流量分配</strong></p><ul><li>灰度路由，即服务a和b 1.1版本被调用到的概率为5%</li><li>稳定路由，即服务a和b 1.0版本被调用到的概率为95%</li></ul><p>在nacos配置中心修改网关控制的灰度发布策略</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strategy-release</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray-condition<span class="token punctuation">&quot;</span></span> <span class="token attr-name">version-id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray-route=5;stable-route=95<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>routes</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>route</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray-route<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>version<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{&quot;tulingmall-member&quot;:&quot;1.1&quot;, &quot;tulingmall-promotion&quot;:&quot;1.1&quot;}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>route</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>route</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stable-route<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>version<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{&quot;tulingmall-member&quot;:&quot;1.0&quot;, &quot;tulingmall-promotion&quot;:&quot;1.0&quot;}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>route</span><span class="token punctuation">&gt;</span></span>      
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>routes</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strategy-release</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>        
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结合课堂代码进行测试</p><p><strong>根据前端传递的Header参数动态选择百分比流量分配</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strategy-release</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 灰度路由1，条件expression驱动 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray-condition-1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#H[&#39;a&#39;] == &#39;1&#39;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">version-id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray-route=10;stable-route=90<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!-- 灰度路由2，条件expression驱动 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray-condition-2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#H[&#39;a&#39;] == &#39;1&#39; and #H[&#39;b&#39;] == &#39;2&#39;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">version-id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray-route=85;stable-route=15<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!-- 兜底路由，无条件expression驱动 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>basic-condition<span class="token punctuation">&quot;</span></span> <span class="token attr-name">version-id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray-route=0;stable-route=100<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>routes</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>route</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gray-route<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>version<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{&quot;tulingmall-member&quot;:&quot;1.1&quot;, &quot;tulingmall-promotion&quot;:&quot;1.1&quot;}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>route</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>route</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stable-route<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>version<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{&quot;tulingmall-member&quot;:&quot;1.0&quot;, &quot;tulingmall-promotion&quot;:&quot;1.0&quot;}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>route</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>routes</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strategy-release</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3.5 MSE 微服务治理全链路灰度</strong></p><p>阿里云MSE服务治理产品就是一款基于Java Agent实现的无侵入式企业生产级服务治理产品，您不需要修改任何一行业务代码，即可拥有不限于全链路灰度的治理能力，并且支持近5年内所有的 Spring Boot、Spring Cloud和Dubbo。</p><p>最佳实践： <a href="https://help.aliyun.com/document_detail/359851.html" target="_blank" rel="noopener noreferrer">基于MSE云原生网关实现全链路灰度<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>全链路灰度作为MSE服务治理专业版中的拳头功能，具备以下六大特点:</p><ul><li>可通过定制规则引入精细化流量</li></ul><figure><img src="https://img.jssjqd.cn/202308300128638.png" alt="image-20230830012804809" tabindex="0" loading="lazy"><figcaption>image-20230830012804809</figcaption></figure><ul><li><p>全链路隔离流量泳道</p><ul><li>通过设置流量规则对所需流量进行&#39;染色&#39;，&#39;染色&#39;流量会路由到灰度机器。</li><li>灰度流量携带灰度标往下游传递，形成灰度专属环境流量泳道，无灰度环境应用会默认选择未打标的基线环境。</li></ul></li><li><p>端到端的稳定基线环境</p></li></ul><p>未打标的应用属于基线稳定版本的应用，即稳定的线上环境。当我们将发布对应的灰度版本 代码，然后可以配置规则定向引入特定的线上流量，控制灰度代码的风险。</p><ul><li>流量一键动态切流</li></ul><p>流量规则定制后，可根据需求进行一键停启，增删改查，实时生效。灰度引流更便捷。</p><ul><li>低成本接入，基于Java Agent技术实现无需修改一行业务代码</li></ul><p>MSE微服务治理能力基于Java Agent字节码增强的技术实现，无缝支持市面上近5年的所有Spring Cloud 和Dubbo的版本，用户不用改一行代码就可以使用，不需要改变业务的现有架构，随时可上可下，没有绑定。只需开启MSE微服务治理专业版，在线配置，实时生效。</p><ul><li>具备无损上下线能力，使得发布更加丝滑</li></ul><p>应用开启MSE微服务治理后就具备无损上下线能力，大流量下的发布、回滚、扩容、缩容等场景，均能保证流量无损。</p></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: thejqd@gmail.com">jiangqingdong</span><!--]--><!--]--></div></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">Copyright © 2023 江</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-8ca06c83.js" defer></script>
  </body>
</html>
