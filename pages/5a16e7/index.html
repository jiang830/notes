<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高性能网关服务及授权中心对接 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="个人技术博客,技术文档,学习,面试,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.80e00cb3.css" as="style"><link rel="preload" href="/assets/js/app.9bc55a4a.js" as="script"><link rel="preload" href="/assets/js/2.712f36ff.js" as="script"><link rel="preload" href="/assets/js/105.6f034fca.js" as="script"><link rel="prefetch" href="/assets/js/10.79f90b54.js"><link rel="prefetch" href="/assets/js/100.15c80436.js"><link rel="prefetch" href="/assets/js/101.38c7234c.js"><link rel="prefetch" href="/assets/js/102.4473ab1c.js"><link rel="prefetch" href="/assets/js/103.f628c695.js"><link rel="prefetch" href="/assets/js/104.ac15b9bd.js"><link rel="prefetch" href="/assets/js/106.a7fb5820.js"><link rel="prefetch" href="/assets/js/107.db86e279.js"><link rel="prefetch" href="/assets/js/108.7809d6a0.js"><link rel="prefetch" href="/assets/js/109.0b7730df.js"><link rel="prefetch" href="/assets/js/11.72d2a105.js"><link rel="prefetch" href="/assets/js/110.6376fe7d.js"><link rel="prefetch" href="/assets/js/111.e5426020.js"><link rel="prefetch" href="/assets/js/12.702cfabb.js"><link rel="prefetch" href="/assets/js/13.e6ed07d0.js"><link rel="prefetch" href="/assets/js/14.d4895d97.js"><link rel="prefetch" href="/assets/js/15.be0b2498.js"><link rel="prefetch" href="/assets/js/16.9cbb07dc.js"><link rel="prefetch" href="/assets/js/17.ae80c005.js"><link rel="prefetch" href="/assets/js/18.41b2037e.js"><link rel="prefetch" href="/assets/js/19.0d80d192.js"><link rel="prefetch" href="/assets/js/20.9227e85a.js"><link rel="prefetch" href="/assets/js/21.97be6ed2.js"><link rel="prefetch" href="/assets/js/22.be61ffb1.js"><link rel="prefetch" href="/assets/js/23.3a39ac58.js"><link rel="prefetch" href="/assets/js/24.885ccd31.js"><link rel="prefetch" href="/assets/js/25.4d90ed52.js"><link rel="prefetch" href="/assets/js/26.82068fa3.js"><link rel="prefetch" href="/assets/js/27.73898638.js"><link rel="prefetch" href="/assets/js/28.ecf93e53.js"><link rel="prefetch" href="/assets/js/29.7be39b64.js"><link rel="prefetch" href="/assets/js/3.4f34eb88.js"><link rel="prefetch" href="/assets/js/30.89328833.js"><link rel="prefetch" href="/assets/js/31.d14a8fc8.js"><link rel="prefetch" href="/assets/js/32.0ce0041a.js"><link rel="prefetch" href="/assets/js/33.1f3abdce.js"><link rel="prefetch" href="/assets/js/34.eee2a883.js"><link rel="prefetch" href="/assets/js/35.78ea8ca9.js"><link rel="prefetch" href="/assets/js/36.adb5b83a.js"><link rel="prefetch" href="/assets/js/37.52a8645b.js"><link rel="prefetch" href="/assets/js/38.49c7286c.js"><link rel="prefetch" href="/assets/js/39.f99d3d35.js"><link rel="prefetch" href="/assets/js/4.bae9e911.js"><link rel="prefetch" href="/assets/js/40.621c7dd7.js"><link rel="prefetch" href="/assets/js/41.0ef5b18e.js"><link rel="prefetch" href="/assets/js/42.904f70d1.js"><link rel="prefetch" href="/assets/js/43.5e518c0b.js"><link rel="prefetch" href="/assets/js/44.6f9c451b.js"><link rel="prefetch" href="/assets/js/45.42727041.js"><link rel="prefetch" href="/assets/js/46.b9d5a1f2.js"><link rel="prefetch" href="/assets/js/47.0aaa423c.js"><link rel="prefetch" href="/assets/js/48.c18e972f.js"><link rel="prefetch" href="/assets/js/49.1d67db3f.js"><link rel="prefetch" href="/assets/js/5.f1a94486.js"><link rel="prefetch" href="/assets/js/50.ecfbc5f7.js"><link rel="prefetch" href="/assets/js/51.9a473700.js"><link rel="prefetch" href="/assets/js/52.84ccdd6a.js"><link rel="prefetch" href="/assets/js/53.543a15f1.js"><link rel="prefetch" href="/assets/js/54.93d5cc48.js"><link rel="prefetch" href="/assets/js/55.8c359df5.js"><link rel="prefetch" href="/assets/js/56.2e0774d4.js"><link rel="prefetch" href="/assets/js/57.44390766.js"><link rel="prefetch" href="/assets/js/58.5a103736.js"><link rel="prefetch" href="/assets/js/59.f2c27b47.js"><link rel="prefetch" href="/assets/js/6.0d937ada.js"><link rel="prefetch" href="/assets/js/60.c8c926f8.js"><link rel="prefetch" href="/assets/js/61.a4e0a07d.js"><link rel="prefetch" href="/assets/js/62.caafc7cd.js"><link rel="prefetch" href="/assets/js/63.53fb767a.js"><link rel="prefetch" href="/assets/js/64.3e0cea09.js"><link rel="prefetch" href="/assets/js/65.84b642e8.js"><link rel="prefetch" href="/assets/js/66.067f7d2e.js"><link rel="prefetch" href="/assets/js/67.b1aaaadd.js"><link rel="prefetch" href="/assets/js/68.0292eef7.js"><link rel="prefetch" href="/assets/js/69.6cb6dd73.js"><link rel="prefetch" href="/assets/js/7.d7f256d5.js"><link rel="prefetch" href="/assets/js/70.2c1fa852.js"><link rel="prefetch" href="/assets/js/71.0bb9e101.js"><link rel="prefetch" href="/assets/js/72.90c366c1.js"><link rel="prefetch" href="/assets/js/73.61dcbb5f.js"><link rel="prefetch" href="/assets/js/74.5d86ecc0.js"><link rel="prefetch" href="/assets/js/75.e522d4f9.js"><link rel="prefetch" href="/assets/js/76.2b8f9d11.js"><link rel="prefetch" href="/assets/js/77.8de2988e.js"><link rel="prefetch" href="/assets/js/78.e0dd54ae.js"><link rel="prefetch" href="/assets/js/79.d7df7998.js"><link rel="prefetch" href="/assets/js/8.61eb6b1a.js"><link rel="prefetch" href="/assets/js/80.2fdf76fe.js"><link rel="prefetch" href="/assets/js/81.4ff9fc1d.js"><link rel="prefetch" href="/assets/js/82.3d387e82.js"><link rel="prefetch" href="/assets/js/83.40b971bb.js"><link rel="prefetch" href="/assets/js/84.57d174e5.js"><link rel="prefetch" href="/assets/js/85.1b9e4a6a.js"><link rel="prefetch" href="/assets/js/86.8572229f.js"><link rel="prefetch" href="/assets/js/87.49d62718.js"><link rel="prefetch" href="/assets/js/88.a2849e4f.js"><link rel="prefetch" href="/assets/js/89.6e0e0640.js"><link rel="prefetch" href="/assets/js/9.ac0fc468.js"><link rel="prefetch" href="/assets/js/90.0021c322.js"><link rel="prefetch" href="/assets/js/91.f3765ada.js"><link rel="prefetch" href="/assets/js/92.8c73639a.js"><link rel="prefetch" href="/assets/js/93.efd31011.js"><link rel="prefetch" href="/assets/js/94.678751b3.js"><link rel="prefetch" href="/assets/js/95.776e0397.js"><link rel="prefetch" href="/assets/js/96.def971c3.js"><link rel="prefetch" href="/assets/js/97.0a2f3a5e.js"><link rel="prefetch" href="/assets/js/98.adf1c50e.js"><link rel="prefetch" href="/assets/js/99.936d1008.js">
    <link rel="stylesheet" href="/assets/css/0.styles.80e00cb3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="学习笔记" class="logo"> <span class="site-name can-hide">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://img.jssjqd.cn/202303140455599.jpg"> <div class="blogger-info"><h3>江</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/pages/a2556c/" class="sidebar-link">电商项目整体架构</a></li><li><a href="/pages/5fb399/" class="sidebar-link">电商项目环境配置</a></li><li><a href="/pages/cb237e/" class="sidebar-link">秒杀系统-商品详情多级缓存优化-1</a></li><li><a href="/pages/81eaf4/" class="sidebar-link">秒杀系统-商品详情多级缓存优化-2</a></li><li><a href="/pages/364bf0/" class="sidebar-link">秒杀系统-商品详情多级缓存优化-3</a></li><li><a href="/pages/c460d9/" class="sidebar-link">微服务架构拆分及授权中心实战</a></li><li><a href="/pages/5a16e7/" aria-current="page" class="active sidebar-link">高性能网关服务及授权中心对接</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/5a16e7/#_1-架构设计分析" class="sidebar-link">1. 架构设计分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_1-1-多点登录" class="sidebar-link">1.1 多点登录</a></li><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_1-2-单点登录" class="sidebar-link">1.2 单点登录</a></li><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_1-3-微服务接入网关实现单点登录设计思路" class="sidebar-link">1.3 微服务接入网关实现单点登录设计思路</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5a16e7/#_2-搭建微服务授权中心" class="sidebar-link">2. 搭建微服务授权中心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_2-1-引入依赖" class="sidebar-link">2.1 引入依赖</a></li><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_2-2-添加yml配置" class="sidebar-link">2.2 添加yml配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_2-3-配置授权服务器" class="sidebar-link">2.3 配置授权服务器</a></li><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_2-4-配置springsecurity" class="sidebar-link">2.4 配置SpringSecurity</a></li><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_2-5-测试模拟用户登录" class="sidebar-link">2.5 测试模拟用户登录</a></li><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_2-6-配置资源服务器" class="sidebar-link">2.6 配置资源服务器</a></li><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_2-7-spring-security-oauth2整合jwt" class="sidebar-link">2.7 Spring Security Oauth2整合JWT</a></li><li class="sidebar-sub-header level3"><a href="/pages/5a16e7/#_2-8-优化-实现jwt非对称加密-公钥私钥" class="sidebar-link">2.8 优化：实现JWT非对称加密（公钥私钥）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5a16e7/#_3-接入网关服务" class="sidebar-link">3. 接入网关服务</a></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98" title="分类" data-v-06225672>项目实战</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>江</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-12-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">高性能网关服务及授权中心对接<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="_1-架构设计分析"><a href="#_1-架构设计分析" class="header-anchor">#</a> 1. 架构设计分析</h2> <h3 id="_1-1-多点登录"><a href="#_1-1-多点登录" class="header-anchor">#</a> 1.1 多点登录</h3> <p>​    <img src="https://img.jssjqd.cn/202212110423229.png" alt="image-20221211042338650"></p> <h3 id="_1-2-单点登录"><a href="#_1-2-单点登录" class="header-anchor">#</a> 1.2 单点登录</h3> <p><img src="https://img.jssjqd.cn/202212110424337.png" alt="image-20221211042430379"></p> <h3 id="_1-3-微服务接入网关实现单点登录设计思路"><a href="#_1-3-微服务接入网关实现单点登录设计思路" class="header-anchor">#</a> 1.3 微服务接入网关实现单点登录设计思路</h3> <p>网关整合 OAuth2.0 有两种思路，一种是授权服务器生成令牌, 所有请求统一在网关层验证，判断权限等操作；另一种是由各资源服务处理，网关只做请求转发。  比较常用的是第一种，把API网关作为OAuth2.0的资源服务器角色，实现接入客户端权限拦截、令牌解析并转发当前登录用户信息给微服务，这样下游微服务就不需要关心令牌格式解析以及OAuth2.0相关机制了。</p> <p>网关在认证授权体系里主要负责两件事： （1）作为OAuth2.0的资源服务器角色，实现接入方访问权限拦截。 （2）令牌解析并转发当前登录用户信息（明文token）给微服务 微服务拿到明文token(明文token中包含登录用户的身份和权限信息)后也需要做两件事： （1）用户授权拦截（看当前用户是否有权访问该资源） （2）将用户信息存储进当前线程上下文（有利于后续业务逻辑随时获取当前用户信息）</p> <p><img src="https://img.jssjqd.cn/202212110424526.png" alt="image-20221211042449579"></p> <h2 id="_2-搭建微服务授权中心"><a href="#_2-搭建微服务授权中心" class="header-anchor">#</a> 2. 搭建微服务授权中心</h2> <p>授权中心的认证依赖：</p> <ul><li>第三方客户端的信息</li> <li>微服务的信息</li> <li>登录用户的信息</li></ul> <p>创建微服务tulingmall-auth</p> <h3 id="_2-1-引入依赖"><a href="#_2-1-引入依赖" class="header-anchor">#</a> 2.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tuling<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tulingmall-mbg<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--nacos 注册中心 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- spring security oauth2--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- openfeign 服务远程调用 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_2-2-添加yml配置"><a href="#_2-2-添加yml配置" class="header-anchor">#</a> 2.2 添加yml配置</h3> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9999</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>auth
    <span class="token comment">#配置nacos注册中心地址</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.65.232<span class="token punctuation">:</span><span class="token number">8848</span>  <span class="token comment">#注册中心地址</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 80a98d11<span class="token punctuation">-</span>492c<span class="token punctuation">-</span>4008<span class="token punctuation">-</span>85aa<span class="token punctuation">-</span>32d889e9b0d0  <span class="token comment">#环境隔离</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//tuling.com<span class="token punctuation">:</span>3306/tlmall_oauth<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-</span><span class="token number">8</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
    <span class="token key atrule">druid</span><span class="token punctuation">:</span>
      <span class="token key atrule">initial-size</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment">#连接池初始化大小</span>
      <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment">#最小空闲连接数</span>
      <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">20</span> <span class="token comment">#最大连接数</span>
      <span class="token key atrule">web-stat-filter</span><span class="token punctuation">:</span>
        <span class="token key atrule">exclusions</span><span class="token punctuation">:</span> <span class="token string">&quot;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&quot;</span> <span class="token comment">#不统计这些请求数据</span>
      <span class="token key atrule">stat-view-servlet</span><span class="token punctuation">:</span> <span class="token comment">#访问监控网页的登录用户名和密码</span>
        <span class="token key atrule">login-username</span><span class="token punctuation">:</span> druid
        <span class="token key atrule">login-password</span><span class="token punctuation">:</span> druid 
</code></pre></div><h3 id="_2-3-配置授权服务器"><a href="#_2-3-配置授权服务器" class="header-anchor">#</a> 2.3 配置授权服务器</h3> <p><strong>基于DB模式配置授权服务器存储第三方客户端的信息</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TulingAuthorizationServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 配置授权服务器存储第三方客户端的信息  基于DB存储   oauth_client_details</span>
        clients<span class="token punctuation">.</span><span class="token function">withClientDetails</span><span class="token punctuation">(</span><span class="token function">clientDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ClientDetailsService</span> <span class="token function">clientDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcClientDetailsService</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>在oauth_client_details中添加第三方客户端信息（client_id  client_secret  scope等等）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>resource_ids<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>scope<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authorized_grant_types<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>web_server_redirect_uri<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>access_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refresh_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>additional_information<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>autoapprove<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>
</code></pre></div><p><strong>基于内存模式配置授权服务器存储第三方客户端的信息</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//TulingAuthorizationServerConfig.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//  配置授权服务器存储第三方客户端的信息  基于DB存储   oauth_client_details</span>
   <span class="token comment">// clients.withClientDetails(clientDetails());</span>
    
    <span class="token comment">/**
     *授权码模式
     *http://localhost:9999/oauth/authorize?response_type=code&amp;client_id=client&amp;redirect_uri=http://www.baidu.com&amp;scope=all
     *
     * password模式
     *  http://localhost:8080/oauth/token?username=fox&amp;password=123456&amp;grant_type=password&amp;client_id=client&amp;client_secret=123123&amp;scope=all
     *
     */</span>
    clients<span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//配置client_id</span>
            <span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">//配置client-secret</span>
            <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//配置访问token的有效期</span>
            <span class="token punctuation">.</span><span class="token function">accessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
            <span class="token comment">//配置刷新token的有效期</span>
            <span class="token punctuation">.</span><span class="token function">refreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">864000</span><span class="token punctuation">)</span>
            <span class="token comment">//配置redirect_uri，用于授权成功后跳转</span>
            <span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.baidu.com&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">//配置申请的权限范围</span>
            <span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">/**
             * 配置grant_type，表示授权类型
             * authorization_code: 授权码
             * password： 密码
             * refresh_token: 更新令牌
             */</span>
            <span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">&quot;authorization_code&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;refresh_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-4-配置springsecurity"><a href="#_2-4-配置springsecurity" class="header-anchor">#</a> 2.4 配置SpringSecurity</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TulingUserDetailsService</span> tulingUserDetailsService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从DB获取用户信息</span>
        auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>tulingUserDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// oauth2 密码模式需要拿到这个bean</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>获取会员信息，此处通过feign从tulingmall-member获取会员信息，需要配置feign，核心代码：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TulingUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加载用户信息</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;用户登陆用户名为空:{}&quot;</span><span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;用户名不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token class-name">UmsMember</span> umsMember <span class="token operator">=</span> <span class="token function">getByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> umsMember<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;根据用户名没有查询到对应的用户信息:{}&quot;</span><span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;根据用户名:{}获取用户登陆信息:{}&quot;</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span>umsMember<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 会员信息的封装 implements UserDetails</span>
        <span class="token class-name">MemberDetails</span> memberDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberDetails</span><span class="token punctuation">(</span>umsMember<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> memberDetails<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UmsMemberFeignService</span> umsMemberFeignService<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">UmsMember</span> <span class="token function">getByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// fegin获取会员信息</span>
        <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UmsMember</span><span class="token punctuation">&gt;</span></span> umsMemberCommonResult <span class="token operator">=</span> umsMemberFeignService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> umsMemberCommonResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;tulingmall-member&quot;</span><span class="token punctuation">,</span>path<span class="token operator">=</span><span class="token string">&quot;/member/center&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UmsMemberFeignService</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/loadUmsMember&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UmsMember</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberDetails</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">UmsMember</span> umsMember<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MemberDetails</span><span class="token punctuation">(</span><span class="token class-name">UmsMember</span> umsMember<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>umsMember <span class="token operator">=</span> umsMember<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//返回当前用户的权限</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span><span class="token string">&quot;TEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> umsMember<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> umsMember<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> umsMember<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">UmsMember</span> <span class="token function">getUmsMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> umsMember<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>修改授权服务配置，支持密码模式</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//TulingAuthorizationServerConfig.java </span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TulingUserDetailsService</span> tulingUserDetailsService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManagerBean<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//使用密码模式需要配置</span>
        endpoints<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManagerBean<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">reuseRefreshTokens</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment">//refresh_token是否重复使用</span>
                <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>tulingUserDetailsService<span class="token punctuation">)</span> <span class="token comment">//刷新令牌授权包含对用户信息的检查</span>
                <span class="token punctuation">.</span><span class="token function">allowedTokenEndpointRequestMethods</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//支持GET,POST请求</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 授权服务器安全配置
     * @param security
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerSecurityConfigurer</span> security<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//第三方客户端校验token需要带入 clientId 和clientSecret来校验</span>
        security<span class="token punctuation">.</span><span class="token function">checkTokenAccess</span><span class="token punctuation">(</span><span class="token string">&quot;isAuthenticated()&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenKeyAccess</span><span class="token punctuation">(</span><span class="token string">&quot;isAuthenticated()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//来获取我们的tokenKey需要带入clientId,clientSecret</span>
    
        <span class="token comment">//允许表单认证</span>
        security<span class="token punctuation">.</span><span class="token function">allowFormAuthenticationForClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-5-测试模拟用户登录"><a href="#_2-5-测试模拟用户登录" class="header-anchor">#</a> 2.5 测试模拟用户登录</h3> <p><strong>授权码模式</strong></p> <p>授权码（authorization code）方式，指的是第三方应用先申请一个授权码，然后再用该码获取令牌。</p> <p>这种方式是最常用的流程，安全性也最高，它适用于那些有后端的 Web 应用。授权码通过前端传送，令牌则是储存在后端，而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏。</p> <p>适用场景：目前市面上主流的第三方验证都是采用这种模式</p> <p><img src="https://img.jssjqd.cn/202212110431180.png" alt="image-20221211043120060"></p> <p>它的步骤如下：</p> <p>（A）用户访问客户端，后者将前者导向授权服务器。</p> <p>（B）用户选择是否给予客户端授权。</p> <p>（C）假设用户给予授权，授权服务器将用户导向客户端事先指定的&quot;重定向URI&quot;（redirection URI），同时附上一个授权码。</p> <p>（D）客户端收到授权码，附上早先的&quot;重定向URI&quot;，向授权服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。</p> <p>（E）授权服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）。</p> <p>http://localhost:9999/oauth/authorize?response_type=code&amp;client_id=client&amp;redirect_uri=http://www.baidu.com&amp;scope=all</p> <p>获取到code</p> <p>​    <img src="https://note.youdao.com/yws/public/resource/7b3179e6fa5d39fb758bb4677fb7e2df/xmlnote/0ADB1310330449EF811BEB4629E4DD43/16071" alt="0"></p> <p><img src="https://img.jssjqd.cn/202212110431204.png" alt="image-20221211043138164"></p> <p><strong>密码模式</strong></p> <p>如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌，这种方式称为&quot;密码式&quot;（password）。</p> <p>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而授权服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</p> <p>适用场景：自家公司搭建的授权服务器</p> <p>测试获取token</p> <p>http://localhost:9999/oauth/token?username=test&amp;password=test&amp;grant_type=password&amp;client_id=client&amp;client_secret=123123&amp;scope=all</p> <p><img src="https://img.jssjqd.cn/202212110431761.png" alt="image-20221211043149520"></p> <p>测试校验token接口</p> <p><img src="https://img.jssjqd.cn/202212110432002.png" alt="image-20221211043229914"></p> <p>因为授权服务器的security配置需要携带clientId和clientSecret，可以采用basic Auth的方式发请求</p> <p><img src="https://note.youdao.com/yws/public/resource/7b3179e6fa5d39fb758bb4677fb7e2df/xmlnote/20E068967EF54C6CB999D61BEE9FA421/16184" alt="0"></p> <p>注意： 传参是token</p> <p><img src="https://img.jssjqd.cn/202212110432197.png" alt="image-20221211043235193"></p> <h3 id="_2-6-配置资源服务器"><a href="#_2-6-配置资源服务器" class="header-anchor">#</a> 2.6 配置资源服务器</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableResourceServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TulingResourceServerConfig</span>  <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    
    
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getCurrentUser&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre></div><p>测试携带token访问资源</p> <p><img src="https://img.jssjqd.cn/202212110433375.png" alt="image-20221211043356369"></p> <p>或者请求头配置Authorization</p> <p><img src="https://img.jssjqd.cn/202212110434630.png" alt="image-20221211043413677"></p> <h3 id="_2-7-spring-security-oauth2整合jwt"><a href="#_2-7-spring-security-oauth2整合jwt" class="header-anchor">#</a> 2.7 Spring Security Oauth2整合JWT</h3> <p>JSON Web Token（JWT）是一个开放的行业标准（RFC 7519），它定义了一种简介的、自包含的协议格式，用于在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任。JWT可以使用HMAC算法或使用RSA的公钥/私钥对来签名，防止被篡改。 官网：https://jwt.io/</p> <p>JWT令牌的优点：</p> <ul><li>jwt基于json，非常方便解析。</li> <li>可以在令牌中自定义丰富的内容，易扩展。</li> <li>通过非对称加密算法及数字签名技术，JWT防止篡改，安全性高。</li> <li>资源服务使用JWT可不依赖认证服务即可完成授权。</li></ul> <p>缺点：</p> <p>​	JWT令牌较长，占存储空间比较大。</p> <p>JWT组成</p> <p>一个JWT实际上就是一个字符串，它由三部分组成，头部（header）、载荷（payload）与签名（signature）。</p> <p><img src="https://img.jssjqd.cn/202212110435789.png" alt="image-20221211043524814"></p> <p><strong>头部（header）</strong></p> <p>头部用于描述关于该JWT的最基本的信息：类型（即JWT）以及签名所用的算法（如HMACSHA256或RSA）等。</p> <p>这也可以被表示成一个JSON对象：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后将头部进行base64加密（该加密是可以对称解密的),构成了第一部分:</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</span> <span class="token value attr-value">             </span>
</code></pre></div><p><strong>载荷（payload）</strong></p> <p>第二部分是载荷，就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息包含三个部分：</p> <ul><li>标准中注册的声明（建议但不强制使用）</li></ul> <p><strong>iss</strong>: jwt签发者</p> <p><strong>sub</strong>: jwt所面向的用户</p> <p><strong>aud</strong>: 接收jwt的一方</p> <p><strong>exp</strong>: jwt的过期时间，这个过期时间必须要大于签发时间</p> <p><strong>nbf</strong>: 定义在什么时间之前，该jwt都是不可用的.</p> <p><strong>iat</strong>: jwt的签发时间</p> <p><strong>jti</strong>: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</p> <ul><li>公共的声明 公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.</li> <li>私有的声明 私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</li></ul> <p>定义一个payload：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;sub&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1234567890&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John Doe&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;iat&quot;</span><span class="token operator">:</span> <span class="token number">1516239022</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后将其进行base64加密，得到Jwt的第二部分:</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ</span> <span class="token value attr-value">             </span>
</code></pre></div><p><strong>签名（signature）</strong></p> <p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p> <ul><li>header (base64后的)</li> <li>payload (base64后的)</li> <li>secret(盐，一定要保密）</li></ul> <p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> encodedString <span class="token operator">=</span> <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> signature <span class="token operator">=</span> <span class="token constant">HMACSHA256</span><span class="token punctuation">(</span>encodedString<span class="token punctuation">,</span> <span class="token string">'fox'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// khA7TNYc7_0iELcDyTc7gHBZ_xfIcgbfpzUNWwQtzME</span>
</code></pre></div><p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p> <div class="language-properties extra-class"><pre class="language-properties"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.khA7TNYc7_0iELcDyTc7gHBZ_xfIcgbfpzUNWwQtzME
</code></pre></div><p>注意：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</p> <p>引入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--spring secuity对jwt的支持 spring cloud oauth2已经依赖，可以不配置--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-jwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>  
</code></pre></div><p>添加JWT配置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTokenStoreConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">jwtTokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">JwtAccessTokenConverter</span> accessTokenConverter <span class="token operator">=</span> <span class="token keyword">new</span>
                <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置JWT使用的秘钥</span>
        accessTokenConverter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accessTokenConverter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在授权服务器配置中指定令牌的存储策略为JWT</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//TulingAuthorizationServerConfig.java</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;jwtTokenStore&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">JwtAccessTokenConverter</span> jwtAccessTokenConverter<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">TulingUserDetailsService</span> tulingUserDetailsService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManagerBean<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//使用密码模式需要配置</span>
    endpoints<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManagerBean<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span>  <span class="token comment">//指定token存储策略是jwt</span>
            <span class="token punctuation">.</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">reuseRefreshTokens</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment">//refresh_token是否重复使用</span>
            <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>tulingUserDetailsService<span class="token punctuation">)</span> <span class="token comment">//刷新令牌授权包含对用户信息的检查</span>
            <span class="token punctuation">.</span><span class="token function">allowedTokenEndpointRequestMethods</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//支持GET,POST请求</span>
<span class="token punctuation">}</span>
</code></pre></div><p>密码模式测试：</p> <p>http://localhost:9999/oauth/token?username=test&amp;password=test&amp;grant_type=password&amp;client_id=client&amp;client_secret=123123&amp;scope=all</p> <p><img src="https://img.jssjqd.cn/202212110440866.png" alt="image-20221211044054963"></p> <p>将access_token复制到https://jwt.io/的Encoded中打开,可以看到会员认证信息<img src="https://img.jssjqd.cn/202212110443989.png" alt="image-20221211044333012"></p> <p>测试校验token</p> <p><img src="https://img.jssjqd.cn/202212110443481.png" alt="image-20221211044346232"></p> <p>​    <img src="https://note.youdao.com/yws/public/resource/7b3179e6fa5d39fb758bb4677fb7e2df/xmlnote/EDEA6DA3062D423E909179F2A7575082/16207" alt="0"></p> <p>测试获取token_key</p> <p><img src="https://img.jssjqd.cn/202212110443327.png" alt="image-20221211044356218"></p> <p>测试刷新token</p> <p><img src="https://img.jssjqd.cn/202212110444315.png" alt="image-20221211044403383"></p> <h3 id="_2-8-优化-实现jwt非对称加密-公钥私钥"><a href="#_2-8-优化-实现jwt非对称加密-公钥私钥" class="header-anchor">#</a> 2.8 优化：实现JWT非对称加密（公钥私钥）</h3> <p><strong>第一步：生成jks 证书文件</strong></p> <p>我们使用jdk自动的工具生成</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">命令格式</span> 
keytool 
<span class="token key attr-name">-genkeypair</span> <span class="token value attr-value"> 生成密钥对</span>
-alias jwt(别名) 
-keypass 123456(别名密码) 
-keyalg RSA(生证书的算法名称，RSA是一种非对称加密算法) 
-keysize 1024(密钥长度,证书大小) 
-validity 365(证书有效期，天单位) 
-keystore D<span class="token punctuation">:</span>/jwt/jwt.jks(指定生成证书的位置和证书名称) 
-storepass 123456(获取keystore信息的密码)
-storetype (指定密钥仓库类型)
<span class="token key attr-name">使用</span> <span class="token value attr-value">&quot;keytool -help&quot; 获取所有可用命令</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>keytool  <span class="token parameter variable">-genkeypair</span> <span class="token parameter variable">-alias</span> jwt <span class="token parameter variable">-keyalg</span> RSA <span class="token parameter variable">-keysize</span> <span class="token number">2048</span> <span class="token parameter variable">-keystore</span> D:/jwt/jwt.jks
</code></pre></div><p><img src="https://img.jssjqd.cn/202212110447037.png" alt="image-20221211044710890"></p> <p>将生成的jwt.jks文件cope到授权服务器的resource目录下</p> <p>​    <img src="https://img.jssjqd.cn/202212110447765.png" alt="image-20221211044718985"></p> <p>查看公钥信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code>keytool <span class="token parameter variable">-list</span> <span class="token parameter variable">-rfc</span> <span class="token parameter variable">--keystore</span> jwt.jks  <span class="token operator">|</span> openssl x509 <span class="token parameter variable">-inform</span> pem <span class="token parameter variable">-pubkey</span>              
</code></pre></div><p><img src="https://img.jssjqd.cn/202212110447764.png" alt="image-20221211044738941"></p> <p>第二步：授权服务中增加jwt的属性配置类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;tuling.jwt&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtCAProperties</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 证书名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> keyPairName<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 证书别名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> keyPairAlias<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 证书私钥
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> keyPairSecret<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 证书存储密钥
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> keyPairStoreSecret<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token comment">// 指定属性配置类</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">JwtCAProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTokenStoreConfig</span> <span class="token punctuation">{</span>
    。。。。。。
<span class="token punctuation">}</span>
</code></pre></div><p>yml中添加jwt配置</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">tuling</span><span class="token punctuation">:</span>
  <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
    <span class="token key atrule">keyPairName</span><span class="token punctuation">:</span> jwt.jks
    <span class="token key atrule">keyPairAlias</span><span class="token punctuation">:</span> jwt
    <span class="token key atrule">keyPairSecret</span><span class="token punctuation">:</span> <span class="token number">123123</span>
    <span class="token key atrule">keyPairStoreSecret</span><span class="token punctuation">:</span> <span class="token number">123123</span>
</code></pre></div><p>第三步：修改JwtTokenStoreConfig的配置，支持非对称加密</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">JwtAccessTokenConverter</span> accessTokenConverter <span class="token operator">=</span> <span class="token keyword">new</span>
            <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//配置JWT使用的秘钥  对称加密</span>
    <span class="token comment">//accessTokenConverter.setSigningKey(&quot;123123&quot;);</span>
    <span class="token comment">//配置JWT使用的秘钥 非对称加密</span>
    accessTokenConverter<span class="token punctuation">.</span><span class="token function">setKeyPair</span><span class="token punctuation">(</span><span class="token function">keyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> accessTokenConverter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">JwtCAProperties</span> jwtCAProperties<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">KeyPair</span> <span class="token function">keyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">KeyStoreKeyFactory</span> keyStoreKeyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyStoreKeyFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span>jwtCAProperties<span class="token punctuation">.</span><span class="token function">getKeyPairName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jwtCAProperties<span class="token punctuation">.</span><span class="token function">getKeyPairSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> keyStoreKeyFactory<span class="token punctuation">.</span><span class="token function">getKeyPair</span><span class="token punctuation">(</span>jwtCAProperties<span class="token punctuation">.</span><span class="token function">getKeyPairAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jwtCAProperties<span class="token punctuation">.</span><span class="token function">getKeyPairStoreSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第四步：扩展JWT中的存储内容</p> <p>有时候我们需要扩展JWT中存储的内容，根据自己业务添加字段到Jwt中。 继承TokenEnhancer实现一个JWT内容增强器</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TulingTokenEnhancer</span> <span class="token keyword">implements</span> <span class="token class-name">TokenEnhancer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AccessToken</span> accessToken<span class="token punctuation">,</span> <span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">MemberDetails</span> memberDetails <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberDetails</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> additionalInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> retMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//todo 这里暴露memberId到Jwt的令牌中,后期可以根据自己的业务需要 进行添加字段</span>
        additionalInfo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">,</span>memberDetails<span class="token punctuation">.</span><span class="token function">getUmsMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        additionalInfo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;nickName&quot;</span><span class="token punctuation">,</span>memberDetails<span class="token punctuation">.</span><span class="token function">getUmsMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        additionalInfo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;integration&quot;</span><span class="token punctuation">,</span>memberDetails<span class="token punctuation">.</span><span class="token function">getUmsMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        retMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;additionalInfo&quot;</span><span class="token punctuation">,</span>additionalInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">)</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAdditionalInformation</span><span class="token punctuation">(</span>retMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在JwtTokenStoreConfig中配置TulingTokenEnhancer</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//JwtTokenStoreConfig.java</span>
<span class="token comment">/**
 * token的增强器 根据自己业务添加字段到Jwt中
 * @return
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">TulingTokenEnhancer</span> <span class="token function">tulingTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TulingTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在授权服务器配置中配置JWT的内容增强器</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// TulingAuthorizationServerConfig.java</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">TulingTokenEnhancer</span> tulingTokenEnhancer<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//配置JWT的内容增强器</span>
    <span class="token class-name">TokenEnhancerChain</span> enhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TokenEnhancer</span><span class="token punctuation">&gt;</span></span> delegates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    delegates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tulingTokenEnhancer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    delegates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    enhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span>delegates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//使用密码模式需要配置</span>
    endpoints<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManagerBean<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span>  <span class="token comment">//指定token存储策略是jwt</span>
            <span class="token punctuation">.</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span>enhancerChain<span class="token punctuation">)</span> <span class="token comment">//配置tokenEnhancer</span>
            <span class="token punctuation">.</span><span class="token function">reuseRefreshTokens</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token comment">//refresh_token是否重复使用</span>
            <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>tulingUserDetailsService<span class="token punctuation">)</span> <span class="token comment">//刷新令牌授权包含对用户信息的检查</span>
            <span class="token punctuation">.</span><span class="token function">allowedTokenEndpointRequestMethods</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//支持GET,POST请求</span>
<span class="token punctuation">}</span>      
</code></pre></div><p>1）通过密码模式测试获取token</p> <p><img src="https://img.jssjqd.cn/202212110451933.png" alt="image-20221211045110849"></p> <p>https://jwt.io/中校验token，可以获取到增强的用户信息，传入私钥和公钥可以校验通过。</p> <p><img src="https://img.jssjqd.cn/202212110451388.png" alt="image-20221211045118322"></p> <p>2）测试校验token</p> <p><img src="https://img.jssjqd.cn/202212110451630.png" alt="image-20221211045136721"></p> <h2 id="_3-接入网关服务"><a href="#_3-接入网关服务" class="header-anchor">#</a> 3. 接入网关服务</h2> <p>在网关服务tulingmall-gateway中配置tulingmall-auth</p> <p>1）yml中添加对tulingmall-auth的路由</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9999</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>gateway
  <span class="token comment">#配置nacos注册中心地址</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.65.232<span class="token punctuation">:</span><span class="token number">8848</span>  <span class="token comment">#注册中心地址</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 80a98d11<span class="token punctuation">-</span>492c<span class="token punctuation">-</span>4008<span class="token punctuation">-</span>85aa<span class="token punctuation">-</span>32d889e9b0d0  <span class="token comment">#环境隔离</span>

    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>member   <span class="token comment">#路由ID，全局唯一</span>
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//tulingmall<span class="token punctuation">-</span>member
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/member/<span class="token important">**</span><span class="token punctuation">,</span>/sso/<span class="token important">**</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>coupons
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//tulingmall<span class="token punctuation">-</span>coupons
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/coupon/<span class="token important">**</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>auth
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//tulingmall<span class="token punctuation">-</span>auth
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> Path=/oauth/<span class="token important">**</span>
</code></pre></div><p>2）编写GateWay的全局过滤器进行权限的校验拦截</p> <p>认证过滤器AuthenticationFilter#filter中需要实现的逻辑</p> <div class="language- extra-class"><pre class="language-text"><code>//1.过滤不需要认证的url,比如/oauth/**

//2. 获取token
// 从请求头中解析 Authorization  value:  bearer xxxxxxx
// 或者从请求参数中解析 access_token

//3. 校验token
// 拿到token后，通过公钥（需要从授权服务获取公钥）校验
// 校验失败或超时抛出异常

//4. 校验通过后，从token中获取的用户登录信息存储到请求头中
</code></pre></div><p>1）过滤不需要认证的url ，可以通过yml设置不需要认证的url。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * @author Fox
 *
 * 认证过滤器: 实现认证逻辑
 *
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">NotAuthUrlProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>
    
    <span class="token comment">/**
     * 请求各个微服务 不需要用户认证的URL
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">NotAuthUrlProperties</span> notAuthUrlProperties<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token class-name">String</span> currentUrl <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">//过滤不需要认证的url</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>currentUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//log.info(&quot;跳过认证的URL:{}&quot;,currentUrl);</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//log.info(&quot;需要认证的URL:{}&quot;,currentUrl);</span>
    
        
    
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取公钥  TODO</span>
        
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">/**
     * 方法实现说明:不需要授权的路径
     * @author:smlz
     * @param currentUrl 当前请求路径
     * @return:
     * @exception:
     * @date:2019/12/26 13:49
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span><span class="token class-name">String</span> currentUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//路径匹配器(简介SpringMvc拦截器的匹配器)</span>
        <span class="token comment">//比如/oauth/** 可以匹配/oauth/token    /oauth/check_token等</span>
        <span class="token class-name">PathMatcher</span> pathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> skipPath<span class="token operator">:</span>notAuthUrlProperties<span class="token punctuation">.</span><span class="token function">getShouldSkipUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>skipPath<span class="token punctuation">,</span>currentUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span><span class="token string">&quot;tuling.gateway&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotAuthUrlProperties</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> shouldSkipUrls<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//application.yml</span>
tuling<span class="token operator">:</span>
  gateway<span class="token operator">:</span>
    shouldSkipUrls<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token operator">/</span>oauth<span class="token comment">/**
    - /sso/**  
</span></code></pre></div><p>网关中引入授权中心配置</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> tulingmall<span class="token punctuation">-</span>auth
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//tulingmall<span class="token punctuation">-</span>auth
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Path=/oauth/<span class="token important">**</span>
</code></pre></div><p>测试： 密码模式 client_id为会员微服务，能够获取到token信息</p> <p><img src="https://img.jssjqd.cn/202212110454717.png" alt="image-20221211045439781"></p> <p>测试：  会员微服务会员登录逻辑</p> <p><img src="https://img.jssjqd.cn/202212110454783.png" alt="image-20221211045448890"></p> <p>2） 解析请求，获取token</p> <p>从请求头中解析 Authorization  value:  bearer xxxxxxx 或者 从请求参数中解析 access_token</p> <p>引入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tuling<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tulingmall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.pagehelper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>pagehelper-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在AuthenticationFilter#filter中实现获取token的逻辑</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//2. 获取token</span>
<span class="token comment">// 从请求头中解析 Authorization  value:  bearer xxxxxxx</span>
<span class="token comment">// 或者从请求参数中解析 access_token</span>
<span class="token comment">//第一步:解析出我们Authorization的请求头  value为: “bearer XXXXXXXXXXXXXX”</span>
<span class="token class-name">String</span> authHeader <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//第二步:判断Authorization的请求头是否为空</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;需要认证的url,请求头为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GateWayException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">AUTHORIZATION_HEADER_IS_EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试： 通过网关获取用户优惠券信息，因为请求头中不带token信息，所以会抛出异常</p> <p><img src="https://img.jssjqd.cn/202212110455780.png" alt="image-20221211045542896"></p> <p>3）校验token</p> <p>拿到token后，通过公钥（需要从授权服务获取公钥）校验，校验失败或超时抛出异常</p> <p>引入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--添加jwt相关的包--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.10.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt-impl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.10.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt-jackson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.10.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    
</code></pre></div><p>在AuthenticationFilter#filter中实现校验token的逻辑</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//3. 校验token</span>
<span class="token comment">// 拿到token后，通过公钥（需要从授权服务获取公钥）校验</span>
<span class="token comment">// 校验失败或超时抛出异常</span>
<span class="token comment">//第三步 校验我们的jwt 若jwt不对或者超时都会抛出异常</span>
<span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">validateJwtToken</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">,</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>校验token逻辑</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// AuthenticationFilter.java</span>
<span class="token comment">/**
 * 请求头中的 token的开始
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">AUTH_HEADER</span> <span class="token operator">=</span> <span class="token string">&quot;bearer &quot;</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Claims</span> <span class="token function">validateJwtToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> authHeader<span class="token punctuation">,</span><span class="token class-name">PublicKey</span> publicKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span><span class="token keyword">null</span> <span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        token <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substringAfter</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">,</span> <span class="token constant">AUTH_HEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Jwt</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JwsHeader</span><span class="token punctuation">,</span> <span class="token class-name">Claims</span><span class="token punctuation">&gt;</span></span> parseClaimsJwt <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> parseClaimsJwt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//log.info(&quot;claims:{}&quot;,claims);</span>
        
        <span class="token keyword">return</span> claims<span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;校验token异常:{},异常信息:{}&quot;</span><span class="token punctuation">,</span>token<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GateWayException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">JWT_TOKEN_EXPIRE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre></div><p>工具类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtils</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 认证服务器许可我们的网关的clientId(需要在oauth_client_details表中配置)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CLIENT_ID</span> <span class="token operator">=</span> <span class="token string">&quot;tulingmall-gateway&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 认证服务器许可我们的网关的client_secret(需要在oauth_client_details表中配置)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CLIENT_SECRET</span> <span class="token operator">=</span> <span class="token string">&quot;123123&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 认证服务器暴露的获取token_key的地址
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">AUTH_TOKEN_KEY_URL</span> <span class="token operator">=</span> <span class="token string">&quot;http://tulingmall-auth/oauth/token_key&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 请求头中的 token的开始
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">AUTH_HEADER</span> <span class="token operator">=</span> <span class="token string">&quot;bearer &quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 方法实现说明: 通过远程调用获取认证服务器颁发jwt的解析的key
     * @author:smlz
     * @param restTemplate 远程调用的操作类
     * @return: tokenKey 解析jwt的tokenKey
     * @exception:
     * @date:2020/1/22 11:31
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getTokenKeyByRemoteCall</span><span class="token punctuation">(</span><span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GateWayException</span> <span class="token punctuation">{</span>

        <span class="token comment">//第一步:封装请求头</span>
        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_FORM_URLENCODED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">setBasicAuth</span><span class="token punctuation">(</span><span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span><span class="token constant">CLIENT_SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MultiValueMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//第二步:远程调用获取token_key</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token constant">AUTH_TOKEN_KEY_URL</span><span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> entity<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> tokenKey <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;去认证服务器获取Token_Key:{}&quot;</span><span class="token punctuation">,</span>tokenKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> tokenKey<span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;远程调用认证服务器获取Token_Key失败:{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GateWayException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">GET_TOKEN_KEY_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 方法实现说明:生成公钥
     * @author:smlz
     * @param restTemplate:远程调用操作类
     * @return: PublicKey 公钥对象
     * @exception:
     * @date:2020/1/22 11:52
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PublicKey</span> <span class="token function">genPulicKey</span><span class="token punctuation">(</span><span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GateWayException</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> tokenKey <span class="token operator">=</span> <span class="token function">getTokenKeyByRemoteCall</span><span class="token punctuation">(</span>restTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span><span class="token punctuation">{</span>

            <span class="token comment">//把获取的公钥开头和结尾替换掉</span>
            <span class="token class-name">String</span> dealTokenKey <span class="token operator">=</span>tokenKey<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\-*BEGIN PUBLIC KEY\\-*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\-*END PUBLIC KEY\\-*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>Security</span><span class="token punctuation">.</span><span class="token function">addProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>bouncycastle<span class="token punctuation">.</span>jce<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span>BouncyCastleProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">X509EncodedKeySpec</span> pubKeySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">X509EncodedKeySpec</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decodeBase64</span><span class="token punctuation">(</span>dealTokenKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;RSA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">PublicKey</span> publicKey <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePublic</span><span class="token punctuation">(</span>pubKeySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;生成公钥:{}&quot;</span><span class="token punctuation">,</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> publicKey<span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;生成公钥异常:{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GateWayException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">GEN_PUBLIC_KEY_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Claims</span> <span class="token function">validateJwtToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> authHeader<span class="token punctuation">,</span><span class="token class-name">PublicKey</span> publicKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span><span class="token keyword">null</span> <span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            token <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substringAfter</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">,</span> <span class="token constant">AUTH_HEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Jwt</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JwsHeader</span><span class="token punctuation">,</span> <span class="token class-name">Claims</span><span class="token punctuation">&gt;</span></span> parseClaimsJwt <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Claims</span> claims <span class="token operator">=</span> parseClaimsJwt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//log.info(&quot;claims:{}&quot;,claims);</span>

            <span class="token keyword">return</span> claims<span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>

            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;校验token异常:{},异常信息:{}&quot;</span><span class="token punctuation">,</span>token<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GateWayException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">JWT_TOKEN_EXPIRE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要从tulingmall-auth获取公钥，实现公钥获取逻辑</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// AuthenticationFilter.java</span>
<span class="token comment">/**
 * jwt的公钥,需要网关启动,远程调用认证中心去获取公钥
 */</span>
<span class="token keyword">private</span> <span class="token class-name">PublicKey</span> publicKey<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取公钥  TODO</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>publicKey <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">genPulicKey</span><span class="token punctuation">(</span>restTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonConfig</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadBalancerClient</span> loadBalancer<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        restTemplate<span class="token punctuation">.</span><span class="token function">setInterceptors</span><span class="token punctuation">(</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">LoadBalancerInterceptor</span><span class="token punctuation">(</span>loadBalancer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>注意： 此处不能直接通过@LoadBalancer配置RestTemplate去获取公钥，思考为什么？</p> <div class="language-java extra-class"><pre class="language-java"><code>源码参考：
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span></span>LoadBalancerAutoConfiguration</span>
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>DefaultListableBeanFactory</span>#preInstantiateSingletons
</code></pre></div><p>测试： 正确的token，通过网关获取用户优惠券信息</p> <p><img src="https://img.jssjqd.cn/202212110458734.png" alt="image-20221211045813027"></p> <p>错误的token，抛出异常</p> <p><img src="https://img.jssjqd.cn/202212110458272.png" alt="image-20221211045818434"></p> <p>4）校验通过后，从token中获取的用户登录信息存储到请求头中</p> <p>在AuthenticationFilter#filter中，将从token中获取的用户登陆信息存储到请求头中</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//4. 校验通过后，从token中获取的用户登录信息存储到请求头中</span>
<span class="token comment">//第四步 把从jwt中解析出来的 用户登陆信息存储到请求头中</span>
<span class="token class-name">ServerWebExchange</span> webExchange <span class="token operator">=</span> <span class="token function">wrapHeader</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>解析用户登录信息存储到请求头中</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// AuthenticationFilter.java</span>

<span class="token keyword">private</span> <span class="token class-name">ServerWebExchange</span> <span class="token function">wrapHeader</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> serverWebExchange<span class="token punctuation">,</span><span class="token class-name">Claims</span> claims<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token class-name">String</span> loginUserInfo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//log.info(&quot;jwt的用户信息:{}&quot;,loginUserInfo);</span>
    
    <span class="token class-name">String</span> memberId <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;additionalInfo&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">String</span> nickName <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;additionalInfo&quot;</span><span class="token punctuation">,</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;nickName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//向headers中放文件，记得build</span>
    <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> serverWebExchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span>claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user_name&quot;</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">,</span>memberId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;nickName&quot;</span><span class="token punctuation">,</span>nickName<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//将现在的request 变成 change对象</span>
    <span class="token keyword">return</span> serverWebExchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/04/09, 18:55:28</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/c460d9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">微服务架构拆分及授权中心实战</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/c460d9/" class="prev">微服务架构拆分及授权中心实战</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/ed68ae/"><div>
            负载均衡Ribbon&amp;LoadBalancer实战
            <!----></div></a> <span class="date">04-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/e79a05/"><div>
            SpringBoot自动配置底层源码解析
            <!----></div></a> <span class="date">04-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5655a2/"><div>
            idea加密连接服务器docker
            <!----></div></a> <span class="date">04-04</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>江</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9bc55a4a.js" defer></script><script src="/assets/js/2.712f36ff.js" defer></script><script src="/assets/js/105.6f034fca.js" defer></script>
  </body>
</html>
