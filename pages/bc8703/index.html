<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM调优实战及常量池详解 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="个人技术博客,技术文档,学习,面试,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.80e00cb3.css" as="style"><link rel="preload" href="/assets/js/app.9bc55a4a.js" as="script"><link rel="preload" href="/assets/js/2.712f36ff.js" as="script"><link rel="preload" href="/assets/js/33.1f3abdce.js" as="script"><link rel="prefetch" href="/assets/js/10.79f90b54.js"><link rel="prefetch" href="/assets/js/100.15c80436.js"><link rel="prefetch" href="/assets/js/101.38c7234c.js"><link rel="prefetch" href="/assets/js/102.4473ab1c.js"><link rel="prefetch" href="/assets/js/103.f628c695.js"><link rel="prefetch" href="/assets/js/104.ac15b9bd.js"><link rel="prefetch" href="/assets/js/105.6f034fca.js"><link rel="prefetch" href="/assets/js/106.a7fb5820.js"><link rel="prefetch" href="/assets/js/107.db86e279.js"><link rel="prefetch" href="/assets/js/108.7809d6a0.js"><link rel="prefetch" href="/assets/js/109.0b7730df.js"><link rel="prefetch" href="/assets/js/11.72d2a105.js"><link rel="prefetch" href="/assets/js/110.6376fe7d.js"><link rel="prefetch" href="/assets/js/111.e5426020.js"><link rel="prefetch" href="/assets/js/12.702cfabb.js"><link rel="prefetch" href="/assets/js/13.e6ed07d0.js"><link rel="prefetch" href="/assets/js/14.d4895d97.js"><link rel="prefetch" href="/assets/js/15.be0b2498.js"><link rel="prefetch" href="/assets/js/16.9cbb07dc.js"><link rel="prefetch" href="/assets/js/17.ae80c005.js"><link rel="prefetch" href="/assets/js/18.41b2037e.js"><link rel="prefetch" href="/assets/js/19.0d80d192.js"><link rel="prefetch" href="/assets/js/20.9227e85a.js"><link rel="prefetch" href="/assets/js/21.97be6ed2.js"><link rel="prefetch" href="/assets/js/22.be61ffb1.js"><link rel="prefetch" href="/assets/js/23.3a39ac58.js"><link rel="prefetch" href="/assets/js/24.885ccd31.js"><link rel="prefetch" href="/assets/js/25.4d90ed52.js"><link rel="prefetch" href="/assets/js/26.82068fa3.js"><link rel="prefetch" href="/assets/js/27.73898638.js"><link rel="prefetch" href="/assets/js/28.ecf93e53.js"><link rel="prefetch" href="/assets/js/29.7be39b64.js"><link rel="prefetch" href="/assets/js/3.4f34eb88.js"><link rel="prefetch" href="/assets/js/30.89328833.js"><link rel="prefetch" href="/assets/js/31.d14a8fc8.js"><link rel="prefetch" href="/assets/js/32.0ce0041a.js"><link rel="prefetch" href="/assets/js/34.eee2a883.js"><link rel="prefetch" href="/assets/js/35.78ea8ca9.js"><link rel="prefetch" href="/assets/js/36.adb5b83a.js"><link rel="prefetch" href="/assets/js/37.52a8645b.js"><link rel="prefetch" href="/assets/js/38.49c7286c.js"><link rel="prefetch" href="/assets/js/39.f99d3d35.js"><link rel="prefetch" href="/assets/js/4.bae9e911.js"><link rel="prefetch" href="/assets/js/40.621c7dd7.js"><link rel="prefetch" href="/assets/js/41.0ef5b18e.js"><link rel="prefetch" href="/assets/js/42.904f70d1.js"><link rel="prefetch" href="/assets/js/43.5e518c0b.js"><link rel="prefetch" href="/assets/js/44.6f9c451b.js"><link rel="prefetch" href="/assets/js/45.42727041.js"><link rel="prefetch" href="/assets/js/46.b9d5a1f2.js"><link rel="prefetch" href="/assets/js/47.0aaa423c.js"><link rel="prefetch" href="/assets/js/48.c18e972f.js"><link rel="prefetch" href="/assets/js/49.1d67db3f.js"><link rel="prefetch" href="/assets/js/5.f1a94486.js"><link rel="prefetch" href="/assets/js/50.ecfbc5f7.js"><link rel="prefetch" href="/assets/js/51.9a473700.js"><link rel="prefetch" href="/assets/js/52.84ccdd6a.js"><link rel="prefetch" href="/assets/js/53.543a15f1.js"><link rel="prefetch" href="/assets/js/54.93d5cc48.js"><link rel="prefetch" href="/assets/js/55.8c359df5.js"><link rel="prefetch" href="/assets/js/56.2e0774d4.js"><link rel="prefetch" href="/assets/js/57.44390766.js"><link rel="prefetch" href="/assets/js/58.5a103736.js"><link rel="prefetch" href="/assets/js/59.f2c27b47.js"><link rel="prefetch" href="/assets/js/6.0d937ada.js"><link rel="prefetch" href="/assets/js/60.c8c926f8.js"><link rel="prefetch" href="/assets/js/61.a4e0a07d.js"><link rel="prefetch" href="/assets/js/62.caafc7cd.js"><link rel="prefetch" href="/assets/js/63.53fb767a.js"><link rel="prefetch" href="/assets/js/64.3e0cea09.js"><link rel="prefetch" href="/assets/js/65.84b642e8.js"><link rel="prefetch" href="/assets/js/66.067f7d2e.js"><link rel="prefetch" href="/assets/js/67.b1aaaadd.js"><link rel="prefetch" href="/assets/js/68.0292eef7.js"><link rel="prefetch" href="/assets/js/69.6cb6dd73.js"><link rel="prefetch" href="/assets/js/7.d7f256d5.js"><link rel="prefetch" href="/assets/js/70.2c1fa852.js"><link rel="prefetch" href="/assets/js/71.0bb9e101.js"><link rel="prefetch" href="/assets/js/72.90c366c1.js"><link rel="prefetch" href="/assets/js/73.61dcbb5f.js"><link rel="prefetch" href="/assets/js/74.5d86ecc0.js"><link rel="prefetch" href="/assets/js/75.e522d4f9.js"><link rel="prefetch" href="/assets/js/76.2b8f9d11.js"><link rel="prefetch" href="/assets/js/77.8de2988e.js"><link rel="prefetch" href="/assets/js/78.e0dd54ae.js"><link rel="prefetch" href="/assets/js/79.d7df7998.js"><link rel="prefetch" href="/assets/js/8.61eb6b1a.js"><link rel="prefetch" href="/assets/js/80.2fdf76fe.js"><link rel="prefetch" href="/assets/js/81.4ff9fc1d.js"><link rel="prefetch" href="/assets/js/82.3d387e82.js"><link rel="prefetch" href="/assets/js/83.40b971bb.js"><link rel="prefetch" href="/assets/js/84.57d174e5.js"><link rel="prefetch" href="/assets/js/85.1b9e4a6a.js"><link rel="prefetch" href="/assets/js/86.8572229f.js"><link rel="prefetch" href="/assets/js/87.49d62718.js"><link rel="prefetch" href="/assets/js/88.a2849e4f.js"><link rel="prefetch" href="/assets/js/89.6e0e0640.js"><link rel="prefetch" href="/assets/js/9.ac0fc468.js"><link rel="prefetch" href="/assets/js/90.0021c322.js"><link rel="prefetch" href="/assets/js/91.f3765ada.js"><link rel="prefetch" href="/assets/js/92.8c73639a.js"><link rel="prefetch" href="/assets/js/93.efd31011.js"><link rel="prefetch" href="/assets/js/94.678751b3.js"><link rel="prefetch" href="/assets/js/95.776e0397.js"><link rel="prefetch" href="/assets/js/96.def971c3.js"><link rel="prefetch" href="/assets/js/97.0a2f3a5e.js"><link rel="prefetch" href="/assets/js/98.adf1c50e.js"><link rel="prefetch" href="/assets/js/99.936d1008.js">
    <link rel="stylesheet" href="/assets/css/0.styles.80e00cb3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="学习笔记" class="logo"> <span class="site-name can-hide">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://img.jssjqd.cn/202303140455599.jpg"> <div class="blogger-info"><h3>江</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/pages/a80a7f/" class="sidebar-link">JVM类加载机制</a></li><li><a href="/pages/a3b500/" class="sidebar-link">JVM内存模型深度剖析与优化</a></li><li><a href="/pages/fd3a46/" class="sidebar-link">JVM对象创建与内存分配机制</a></li><li><a href="/pages/d64172/" class="sidebar-link">Class文件结构</a></li><li><a href="/pages/1d1280/" class="sidebar-link">垃圾收集器ParNew&amp;CMS与底层三色标记算法详解</a></li><li><a href="/pages/c9b6ed/" class="sidebar-link">垃圾收集器G1&amp;ZGC详解</a></li><li><a href="/pages/80485b/" class="sidebar-link">JVM调优工具详解及调优实战</a></li><li><a href="/pages/bc8703/" aria-current="page" class="active sidebar-link">JVM调优实战及常量池详解</a><ul class="sidebar-sub-headers"></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98" title="分类" data-v-06225672>JVM性能调优</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>江</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-03-14</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">JVM调优实战及常量池详解<!----></h1>  <div class="theme-vdoing-content content__default"><h3 id="阿里巴巴arthas详解"><a href="#阿里巴巴arthas详解" class="header-anchor">#</a> <strong>阿里巴巴Arthas详解</strong></h3> <p><strong>Arthas</strong> 是 Alibaba 在 2018 年 9 月开源的 <strong>Java 诊断</strong>工具。支持 JDK6+， 采用命令行交互模式，可以方便的定位和诊断线上程序运行问题。<strong>Arthas</strong> 官方文档十分详细，详见：https://arthas.aliyun.com/doc</p> <h4 id="arthas使用场景"><a href="#arthas使用场景" class="header-anchor">#</a> Arthas使用场景</h4> <p>得益于 <strong>Arthas</strong> 强大且丰富的功能，让 <strong>Arthas</strong> 能做的事情超乎想象。下面仅仅列举几项常见的使用情况，更多的使用场景可以在熟悉了 <strong>Arthas</strong> 之后自行探索。</p> <ol><li>是否有一个全局视角来查看系统的运行状况？</li> <li>为什么 CPU 又升高了，到底是哪里占用了 CPU ？</li> <li>运行的多线程有死锁吗？有阻塞吗？</li> <li>程序运行耗时很长，是哪里耗时比较长呢？如何监测呢？</li> <li>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？</li> <li>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</li> <li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</li> <li>有什么办法可以监控到 JVM 的实时运行状态？</li></ol> <h4 id="arthas下载"><a href="#arthas下载" class="header-anchor">#</a> Arthas下载</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># github下载arthas</span>
https://github.com/alibaba/arthas/releases
</code></pre></div><h4 id="arthas启动"><a href="#arthas启动" class="header-anchor">#</a> Arthas启动</h4> <p><strong>用 as.sh 启动</strong></p> <p>解压后，在文件夹里有as.sh，直接用./as.sh的方式启动：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./as.sh
</code></pre></div><p>打印帮助信息：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./as.sh <span class="token parameter variable">-h</span>
</code></pre></div><p><strong>用arthas-boot启动</strong></p> <p>或者在解压后，在文件夹里有arthas-boot.jar，直接用java -jar的方式启动：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> arthas-boot.jar
</code></pre></div><p>打印帮助信息：</p> <div class="language-java extra-class"><pre class="language-java"><code>java <span class="token operator">-</span>jar arthas<span class="token operator">-</span>boot<span class="token punctuation">.</span>jar <span class="token operator">-</span>h
</code></pre></div><p><img src="https://img.jssjqd.cn/202303141657653.png" alt=""></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tuling<span class="token punctuation">.</span>jvm</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashSet</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Arthas</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">HashSet</span> hashSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 模拟 CPU 过高</span>
        <span class="token function">cpuHigh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 模拟线程死锁</span>
        <span class="token function">deadThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 不断的向 hashSet 集合增加数据</span>
        <span class="token function">addHashSetThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 不断的向 hashSet 集合添加数据
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addHashSetThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化常量</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    hashSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    count<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cpuHigh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 死锁
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deadThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/** 创建资源 */</span>
        <span class="token class-name">Object</span> resourceA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> resourceB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建线程</span>
        <span class="token class-name">Thread</span> threadA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>resourceA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; get ResourceA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;waiting get resourceB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>resourceB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; get resourceB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> threadB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>resourceB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; get ResourceB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;waiting get resourceA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>resourceA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; get resourceA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadA<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadB<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>     
</code></pre></div><h5 id="选择进程序号1-进入进程信息操作"><a href="#选择进程序号1-进入进程信息操作" class="header-anchor">#</a> <strong>选择进程序号1，进入进程信息操作</strong><img src="https://img.jssjqd.cn/202303141658052.png" alt="image-20230314165836080"></h5> <h5 id="输入dashboard可以查看整个进程的运行情况-线程、内存、gc、运行环境信息"><a href="#输入dashboard可以查看整个进程的运行情况-线程、内存、gc、运行环境信息" class="header-anchor">#</a> 输入dashboard可以查看整个进程的运行情况，线程、内存、GC、运行环境信息<img src="https://img.jssjqd.cn/202303141658427.png" alt="image-20230314165857285"></h5> <h5 id="输入thread可以查看线程详细情况"><a href="#输入thread可以查看线程详细情况" class="header-anchor">#</a> 输入thread可以查看线程详细情况<img src="https://img.jssjqd.cn/202303141659255.png" alt="image-20230314165907051"></h5> <h5 id="输入thread加上线程id可以查看线程堆栈"><a href="#输入thread加上线程id可以查看线程堆栈" class="header-anchor">#</a> 输入thread加上线程ID可以查看线程堆栈</h5> <img src="https://img.jssjqd.cn/202303141659219.png" alt="image-20230314165918646" style="zoom:200%;"> <h5 id="输入-thread-b-可以查看线程死锁"><a href="#输入-thread-b-可以查看线程死锁" class="header-anchor">#</a> 输入 thread -b 可以查看线程死锁</h5> <p><img src="https://img.jssjqd.cn/202303141659560.png" alt="image-20230314165929508"></p> <h5 id="输入jad加类的全名可以反编译-这样可以方便我们查看线上代码是否是正确的版本"><a href="#输入jad加类的全名可以反编译-这样可以方便我们查看线上代码是否是正确的版本" class="header-anchor">#</a> 输入jad加类的全名可以反编译，这样可以方便我们查看线上代码是否是正确的版本</h5> <p>​    <img src="https://img.jssjqd.cn/202303141659044.png" alt="image-20230314165935081"></p> <h5 id="使用ognl命令可以查看线上系统变量的值-甚至可以修改变量的值"><a href="#使用ognl命令可以查看线上系统变量的值-甚至可以修改变量的值" class="header-anchor">#</a> 使用ognl命令可以查看线上系统变量的值，甚至可以修改变量的值</h5> <p>​    <img src="https://img.jssjqd.cn/202303141659673.png" alt="image-20230314165941413"></p> <p>​    <img src="https://img.jssjqd.cn/202303141659050.png" alt="image-20230314165945915"></p> <p>更多命令使用可以用help命令查看，或查看文档：https://alibaba.github.io/arthas/commands.html#arthas</p> <h3 id="gc日志详解"><a href="#gc日志详解" class="header-anchor">#</a> GC日志详解</h3> <p>对于java应用我们可以通过一些配置把程序运行过程中的gc日志全部打印出来，然后分析gc日志得到关键性指标，分析GC原因，调优JVM参数。</p> <p>打印GC日志方法，在JVM参数里增加参数，%t 代表时间</p> <div class="language-bash extra-class"><pre class="language-bash"><code>-Xloggc:./gc-%t.log <span class="token parameter variable">-XX:+PrintGCDetails</span> <span class="token parameter variable">-XX:+PrintGCDateStamps</span>  <span class="token parameter variable">-XX:+PrintGCTimeStamps</span> <span class="token parameter variable">-XX:+PrintGCCause</span>  
<span class="token parameter variable">-XX:+UseGCLogFileRotation</span> <span class="token parameter variable">-XX:NumberOfGCLogFiles</span><span class="token operator">=</span><span class="token number">10</span> <span class="token parameter variable">-XX:GCLogFileSize</span><span class="token operator">=</span>100M        
</code></pre></div><p>Tomcat则直接加在JAVA_OPTS变量里。</p> <h4 id="如何分析gc日志"><a href="#如何分析gc日志" class="header-anchor">#</a> 如何分析GC日志</h4> <p>运行程序加上对应gc日志</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> -Xloggc:./gc-%t.log <span class="token parameter variable">-XX:+PrintGCDetails</span> <span class="token parameter variable">-XX:+PrintGCDateStamps</span>  <span class="token parameter variable">-XX:+PrintGCTimeStamps</span> <span class="token parameter variable">-XX:+PrintGCCause</span>  
<span class="token parameter variable">-XX:+UseGCLogFileRotation</span> <span class="token parameter variable">-XX:NumberOfGCLogFiles</span><span class="token operator">=</span><span class="token number">10</span> <span class="token parameter variable">-XX:GCLogFileSize</span><span class="token operator">=</span>100M microservice-eureka-server.jar
</code></pre></div><p>下图中是我截取的JVM刚启动的一部分GC日志</p> <p><img src="https://img.jssjqd.cn/202303141708728.png" alt="image-20230314170806702"></p> <p>我们可以看到图中第一行红框，是项目的配置参数。这里不仅配置了打印GC日志，还有相关的VM内存参数。</p> <p>第二行红框中的是在这个GC时间点发生GC之后相关GC情况。</p> <p>1、对于<strong>2.909：</strong>  这是从jvm启动开始计算到这次GC经过的时间，前面还有具体的发生时间日期。</p> <p>2、Full GC(Metadata GC Threshold)指这是一次full gc，括号里是gc的原因， PSYoungGen是年轻代的GC，ParOldGen是老年代的GC，Metaspace是元空间的GC</p> <p>3、 6160K-&gt;0K(141824K)，这三个数字分别对应GC之前占用年轻代的大小，GC之后年轻代占用，以及整个年轻代的大小。</p> <p>4、112K-&gt;6056K(95744K)，这三个数字分别对应GC之前占用老年代的大小，GC之后老年代占用，以及整个老年代的大小。</p> <p>5、6272K-&gt;6056K(237568K)，这三个数字分别对应GC之前占用堆内存的大小，GC之后堆内存占用，以及整个堆内存的大小。</p> <p>6、20516K-&gt;20516K(1069056K)，这三个数字分别对应GC之前占用元空间内存的大小，GC之后元空间内存占用，以及整个元空间内存的大小。</p> <p>7、0.0209707是该时间点GC总耗费时间。</p> <p>从日志可以发现几次fullgc都是由于元空间不够导致的，所以我们可以将元空间调大点</p> <div class="language-java extra-class"><pre class="language-java"><code>java <span class="token operator">-</span>jar <span class="token operator">-</span><span class="token class-name">Xloggc</span><span class="token operator">:</span><span class="token punctuation">.</span>/gc<span class="token operator">-</span>adjust<span class="token operator">-</span><span class="token operator">%</span>t<span class="token punctuation">.</span>log <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MetaspaceSize</span><span class="token operator">=</span><span class="token number">256</span>M <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MaxMetaspaceSize</span><span class="token operator">=</span><span class="token number">256</span>M <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCDetails</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCDateStamps</span>  
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCTimeStamps</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCCause</span>  <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">UseGCLogFileRotation</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">NumberOfGCLogFiles</span><span class="token operator">=</span><span class="token number">10</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">GCLogFileSize</span><span class="token operator">=</span><span class="token number">100</span>M 
microservice<span class="token operator">-</span>eureka<span class="token operator">-</span>server<span class="token punctuation">.</span>jar        
</code></pre></div><p>调整完我们再看下gc日志发现已经没有因为元空间不够导致的fullgc了</p> <p>对于CMS和G1收集器的日志会有一点不一样，也可以试着打印下对应的gc日志分析下，可以发现gc日志里面的gc步骤跟我们之前讲过的步骤是类似的</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//100KB</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HeapTest</span><span class="token punctuation">&gt;</span></span> heapTests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            heapTests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeapTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>      
</code></pre></div><p><strong>CMS</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">-</span><span class="token class-name">Xloggc</span><span class="token operator">:</span>d<span class="token operator">:</span><span class="token operator">/</span>gc<span class="token operator">-</span>cms<span class="token operator">-</span><span class="token operator">%</span>t<span class="token punctuation">.</span>log <span class="token operator">-</span><span class="token class-name">Xms50M</span> <span class="token operator">-</span><span class="token class-name">Xmx50M</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MetaspaceSize</span><span class="token operator">=</span><span class="token number">256</span>M <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MaxMetaspaceSize</span><span class="token operator">=</span><span class="token number">256</span>M <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCDetails</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCDateStamps</span>  
 <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCTimeStamps</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCCause</span>  <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">UseGCLogFileRotation</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">NumberOfGCLogFiles</span><span class="token operator">=</span><span class="token number">10</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">GCLogFileSize</span><span class="token operator">=</span><span class="token number">100</span>M 
 <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">UseParNewGC</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">UseConcMarkSweepGC</span>           
</code></pre></div><p><strong>G1</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>java <span class="token operator">-</span>jar <span class="token operator">-</span><span class="token class-name">Xloggc</span><span class="token operator">:</span><span class="token punctuation">.</span>/gc<span class="token operator">-</span>g1<span class="token operator">-</span><span class="token operator">%</span>t<span class="token punctuation">.</span>log <span class="token operator">-</span><span class="token class-name">Xms50M</span> <span class="token operator">-</span><span class="token class-name">Xmx50M</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MetaspaceSize</span><span class="token operator">=</span><span class="token number">256</span>M <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MaxMetaspaceSize</span><span class="token operator">=</span><span class="token number">256</span>M <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCDetails</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCDateStamps</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCTimeStamps</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCCause</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">UseGCLogFileRotation</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">NumberOfGCLogFiles</span><span class="token operator">=</span><span class="token number">10</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">GCLogFileSize</span><span class="token operator">=</span><span class="token number">100</span>M <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">UseG1GC</span> microservice<span class="token operator">-</span>eureka<span class="token operator">-</span>server<span class="token punctuation">.</span>jar        
</code></pre></div><p>上面的这些参数，能够帮我们查看分析GC的垃圾收集情况。但是如果GC日志很多很多，成千上万行。就算你一目十行，看完了，脑子也是一片空白。所以我们可以借助一些功能来帮助我们分析，这里推荐一个gceasy(<a href="https://gceasy.io/" target="_blank" rel="noopener noreferrer">https://gceasy.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)，可以上传gc文件，然后他会利用可视化的界面来展现GC情况。具体下图所示  <img src="https://img.jssjqd.cn/202303141715040.png" alt="image-20230314171537605"></p> <p>上图我们可以看到年轻代，老年代，以及永久代的内存分配，和最大使用情况。</p> <p><img src="https://img.jssjqd.cn/202303141715671.png" alt="image-20230314171556651"></p> <p>上图我们可以看到堆内存在GC之前和之后的变化，以及其他信息。</p> <p>这个工具还提供基于机器学习的JVM智能优化建议，当然现在这个功能需要付费<img src="https://img.jssjqd.cn/202303141716328.png" alt="image-20230314171623394"></p> <p><img src="https://img.jssjqd.cn/202303141716013.png" alt="image-20230314171627886"></p> <h3 id="jvm参数汇总查看命令"><a href="#jvm参数汇总查看命令" class="header-anchor">#</a> JVM参数汇总查看命令</h3> <p>java -XX:+PrintFlagsInitial 表示打印出所有参数选项的默认值</p> <p>java -XX:+PrintFlagsFinal 表示打印出所有参数选项在运行程序时生效的值</p> <h3 id="class常量池与运行时常量池"><a href="#class常量池与运行时常量池" class="header-anchor">#</a> Class常量池与运行时常量池</h3> <p>Class常量池可以理解为是Class文件中的资源仓库。 Class文件中除了包含类的版本、字段、方法、接口等描述信息外，还有一项信息就是<strong>常量池(constant pool table)</strong>，用于存放编译期生成的各种<strong>字面量(Literal)和符号引用(Symbolic References)</strong>。</p> <p>一个class文件的16进制大体结构如下图：</p> <p><img src="https://img.jssjqd.cn/202303141716176.png" alt="image-20230314171656193"></p> <p>对应的含义如下，细节可以查下oracle官方文档</p> <p><img src="https://img.jssjqd.cn/202303141717403.png" alt="image-20230314171705459"></p> <p>当然我们一般不会去人工解析这种16进制的字节码文件，我们一般可以通过javap命令生成更可读的JVM字节码指令文件：</p> <p><strong>javap -v Math.class</strong></p> <p><img src="https://img.jssjqd.cn/202303141717873.png" alt="image-20230314171726949"></p> <p>红框标出的就是class常量池信息，常量池中主要存放两大类常量：<strong>字面量和符号引用</strong>。</p> <h4 id="字面量"><a href="#字面量" class="header-anchor">#</a> 字面量</h4> <p><strong>字面量就是指由字母、数字等构成的字符串或者数值常量</strong></p> <p>字面量只可以右值出现，所谓右值是指等号右边的值，如：int a=1 这里的a为左值，1为右值。在这个例子中1就是字面量。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>int a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
int b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
int c <span class="token operator">=</span> <span class="token string">&quot;abcdefg&quot;</span><span class="token punctuation">;</span>
int d <span class="token operator">=</span> <span class="token string">&quot;abcdefg&quot;</span><span class="token punctuation">;</span>         
</code></pre></div><h4 id="符号引用"><a href="#符号引用" class="header-anchor">#</a> 符号引用</h4> <p>符号引用是编译原理中的概念，是相对于直接引用来说的。主要包括了以下三类常量：</p> <ul><li>类和接口的全限定名</li> <li>字段的名称和描述符</li> <li>方法的名称和描述符</li></ul> <p>上面的a，b就是字段名称，就是一种符号引用，还有Math类常量池里的 Lcom/tuling/jvm/Math 是类的全限定名，main和compute是方法名称，()是一种UTF8格式的描述符，这些都是符号引用。</p> <p>这些常量池现在是静态信息，只有到运行时被加载到内存后，这些符号才有对应的内存地址信息，这些常量池一旦被装入内存就变成<strong>运行时常量池</strong>，对应的符号引用在程序加载或运行时会被转变为被加载到内存区域的代码的直接引用，也就是我们说的<strong>动态链接了。例如，compute()这个符号引用在运行时就会被转变为compute()方法具体代码在内存中的地址，主要通过对象头里的类型指针去转换直接引用。</strong></p> <h4 id="字符串常量池"><a href="#字符串常量池" class="header-anchor">#</a> 字符串常量池</h4> <h5 id="字符串常量池的设计思想"><a href="#字符串常量池的设计思想" class="header-anchor">#</a> 字符串常量池的设计思想</h5> <ol><li>字符串的分配，和其他的对象分配一样，耗费高昂的时间与空间代价，作为最基础的数据类型，大量频繁的创建字符串，极大程度地影响程序的性能</li> <li>JVM为了提高性能和减少内存开销，在实例化字符串常量的时候进行了一些优化</li></ol> <ul><li>为字符串开辟一个字符串常量池，类似于缓存区</li> <li>创建字符串常量时，首先查询字符串常量池是否存在该字符串</li> <li>存在该字符串，返回引用实例，不存在，实例化该字符串并放入池中</li></ul> <h5 id="三种字符串操作-jdk1-7-及以上版本"><a href="#三种字符串操作-jdk1-7-及以上版本" class="header-anchor">#</a> 三种字符串操作(Jdk1.7 及以上版本)</h5> <ul><li>直接赋值字符串</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">&quot;zhuge&quot;</span><span class="token punctuation">;</span>  <span class="token comment">// s指向常量池中的引用</span>
这种方式创建的字符串对象，只会在常量池中。
</code></pre></div><p>这种方式创建的字符串对象，只会在常量池中。</p> <p>因为有&quot;zhuge&quot;这个字面量，创建对象s的时候，JVM会先去常量池中通过 equals(key) 方法，判断是否有相同的对象</p> <p>如果有，则直接返回该对象在常量池中的引用；</p> <p>如果没有，则会在常量池中创建一个新对象，再返回引用。</p> <ul><li>new String();</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;zhuge&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// s1指向内存中的对象引用</span>
这种方式会保证字符串常量池和堆中都有这个对象，没有就创建，最后返回堆内存中的对象引用。
</code></pre></div><p>这种方式会保证字符串常量池和堆中都有这个对象，没有就创建，最后返回堆内存中的对象引用。</p> <p>步骤大致如下：</p> <p>因为有&quot;zhuge&quot;这个字面量，所以会先检查字符串常量池中是否存在字符串&quot;zhuge&quot;</p> <p>不存在，先在字符串常量池里创建一个字符串对象；再去内存中创建一个字符串对象&quot;zhuge&quot;；</p> <p>存在的话，就直接去堆内存中创建一个字符串对象&quot;zhuge&quot;；</p> <p>最后，将内存中的引用返回。</p> <ul><li>intern方法</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;zhuge&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token class-name">String</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//false</span>
</code></pre></div><p>String中的intern方法是一个 native 的方法，当调用 intern方法时，如果池已经包含一个等于此String对象的字符串（用equals(oject)方法确定），则返回池中的字符串。<strong>否则，将intern返回的引用指向当前字符串 s1</strong>(<strong>jdk1.6版本需要将 s1 复制到字符串常量池里</strong>)。</p> <h5 id="字符串常量池位置"><a href="#字符串常量池位置" class="header-anchor">#</a> <strong>字符串常量池位置</strong></h5> <p>Jdk1.6及之前： 有永久代, 运行时常量池在永久代，运行时常量池包含字符串常量池</p> <p>Jdk1.7：有永久代，但已经逐步“去永久代”，字符串常量池从永久代里的运行时常量池分离到堆里</p> <p>Jdk1.8及之后： 无永久代，运行时常量池在元空间，字符串常量池里依然在堆里</p> <p>用一个程序证明下字符串常量池在哪里：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * jdk6：-Xms6M -Xmx6M -XX:PermSize=6M -XX:MaxPermSize=6M  
 * jdk8：-Xms6M -Xmx6M -XX:MetaspaceSize=6M -XX:MaxMetaspaceSize=6M
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuntimeConstantPoolOOM</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

运行结果：
jdk7及以上：<span class="token class-name">Exception</span> in thread <span class="token string">&quot;main&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">Java</span> heap space
jdk6：<span class="token class-name">Exception</span> in thread <span class="token string">&quot;main&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">PermGen</span> space          
</code></pre></div><h5 id="字符串常量池设计原理"><a href="#字符串常量池设计原理" class="header-anchor">#</a> 字符串常量池设计原理</h5> <p>字符串常量池底层是hotspot的C++实现的，底层类似一个 HashTable， 保存的本质上是字符串对象的引用。</p> <p>看一道比较常见的面试题，下面的代码创建了多少个 String 对象？</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;he&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;llo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 在 JDK 1.6 下输出是 false，创建了 6 个对象</span>
<span class="token comment">// 在 JDK 1.7 及以上的版本输出是 true，创建了 5 个对象</span>
<span class="token comment">// 当然我们这里没有考虑GC，但这些对象确实存在或存在过</span>
</code></pre></div><p>为什么输出会有这些变化呢？主要还是字符串池从永久代中脱离、移入堆区的原因，intern()方法也相应发生了变化：</p> <p>1、在 JDK 1.6 中，调用 intern() 首先会在字符串池中寻找 equal() 相等的字符串，假如字符串存在就返回该字符串在字符串池中的引用；假如字符串不存在，虚拟机会重新在永久代上创建一个实例，将 StringTable 的一个表项指向这个新创建的实例。</p> <p><img src="https://img.jssjqd.cn/202303141745555.png" alt="image-20230314174532304"></p> <p>2、在 JDK 1.7 (及以上版本)中，由于字符串池不在永久代了，intern() 做了一些修改，更方便地利用堆中的对象。字符串存在时和 JDK 1.6一样，但是字符串不存在时不再需要重新创建实例，可以直接指向堆上的实例。</p> <p><img src="https://img.jssjqd.cn/202303141745358.png" alt="image-20230314174552361"></p> <p>由上面两个图，也不难理解为什么 JDK 1.6 字符串池溢出会抛出 OutOfMemoryError: PermGen space ，而在 JDK 1.7 及以上版本抛出 OutOfMemoryError: Java heap space 。</p> <h5 id="string常量池问题的几个例子"><a href="#string常量池问题的几个例子" class="header-anchor">#</a> String常量池问题的几个例子</h5> <p>示例1：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> s0<span class="token operator">=</span><span class="token string">&quot;zhuge&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s1<span class="token operator">=</span><span class="token string">&quot;zhuge&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2<span class="token operator">=</span><span class="token string">&quot;zhu&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;ge&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> s0<span class="token operator">==</span>s1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> s0<span class="token operator">==</span>s2 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true    </span>
</code></pre></div><p>分析：因为例子中的 s0和s1中的”zhuge”都是字符串常量，它们在编译期就被确定了，所以s0==s1为true；而”zhu”和”ge”也都是字符串常量，当一个字 符串由多个字符串常量连接而成时，它自己肯定也是字符串常量，所以s2也同样在编译期就被优化为一个字符串常量&quot;zhuge&quot;，所以s2也是常量池中” zhuge”的一个引用。所以我们得出s0==s1==s2；</p> <p>示例2：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> s0<span class="token operator">=</span><span class="token string">&quot;zhuge&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;zhuge&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2<span class="token operator">=</span><span class="token string">&quot;zhu&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;ge&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> s0<span class="token operator">==</span>s1 <span class="token punctuation">)</span><span class="token punctuation">;</span>　　<span class="token comment">// false</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> s0<span class="token operator">==</span>s2 <span class="token punctuation">)</span>；　 <span class="token comment">// false</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> s1<span class="token operator">==</span>s2 <span class="token punctuation">)</span><span class="token punctuation">;</span>　　<span class="token comment">// false   </span>
</code></pre></div><p>分析：用new String() 创建的字符串不是常量，不能在编译期就确定，所以new String() 创建的字符串不放入常量池中，它们有自己的地址空间。</p> <p>s0还是常量池 中&quot;zhuge”的引用，s1因为无法在编译期确定，所以是运行时创建的新对象”zhuge”的引用，s2因为有后半部分 new String(”ge”)所以也无法在编译期确定，所以也是一个新创建对象”zhuge”的引用;明白了这些也就知道为何得出此结果了。</p> <p>示例3：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;a1&quot;</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true </span>
  
  <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;atrue&quot;</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true </span>
  
  <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;a3.4&quot;</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> <span class="token number">3.4</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true  </span>
</code></pre></div><p>分析：JVM对于字符串常量的&quot;+&quot;号连接，将在程序编译期，JVM就将常量字符串的&quot;+&quot;连接优化为连接后的值，拿&quot;a&quot; + 1来说，经编译器优化后在class中就已经是a1。在编译期其字符串常量的值就确定下来，故上面程序最终的结果都为true。</p> <p>示例4：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> bb <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> bb<span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre></div><p>分析：JVM对于字符串引用，由于在字符串的&quot;+&quot;连接中，有字符串引用存在，而引用的值在程序编译期是无法确定的，即&quot;a&quot; + bb无法被编译器优化，只有在程序运行期来动态分配并将连接后的新地址赋给b。所以上面程序的结果也就为false。</p> <p>示例5：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">String</span> bb <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> bb<span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><p>分析：和示例4中唯一不同的是bb字符串加了final修饰，对于final修饰的变量，它在编译时被解析为常量值的一个本地拷贝存储到自己的常量池中或嵌入到它的字节码流中。所以此时的&quot;a&quot; + bb和&quot;a&quot; + &quot;b&quot;效果是一样的。故上面程序的结果为true。</p> <p>示例6：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">String</span> bb <span class="token operator">=</span> <span class="token function">getBB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> bb<span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getBB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>  
 <span class="token punctuation">}</span>
</code></pre></div><p>分析：JVM对于字符串引用bb，它的值在编译期无法确定，只有在程序运行期调用方法后，将方法的返回值和&quot;a&quot;来动态连接并分配地址为b，故上面 程序的结果为false。</p> <h5 id="关于string是不可变的"><a href="#关于string是不可变的" class="header-anchor">#</a> 关于String是不可变的</h5> <p>通过上面例子可以得出得知：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span>  s  <span class="token operator">=</span>  <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;b&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">;</span>  <span class="token comment">//就等价于String s = &quot;abc&quot;;</span>
<span class="token class-name">String</span>  a  <span class="token operator">=</span>  <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span>  b  <span class="token operator">=</span>  <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span>  c  <span class="token operator">=</span>  <span class="token string">&quot;c&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span>  s1  <span class="token operator">=</span>   a  <span class="token operator">+</span>  b  <span class="token operator">+</span>  c<span class="token punctuation">;</span>     
</code></pre></div><p>s1 这个就不一样了，可以通过观察其<strong>JVM指令码</strong>发现s1的&quot;+&quot;操作会变成如下操作：</p> <div class="language- extra-class"><pre class="language-text"><code>StringBuilder temp = new StringBuilder();
temp.append(a).append(b).append(c);
String s = temp.toString();
</code></pre></div><p><strong>最后再看一个例子</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//字符串常量池：&quot;计算机&quot;和&quot;技术&quot;     堆内存：str1引用的对象&quot;计算机技术&quot;  </span>
<span class="token comment">//堆内存中还有个StringBuilder的对象，但是会被gc回收，StringBuilder的toString方法会new String()，这个String才是真正返回的对象引用</span>
<span class="token class-name">String</span> str2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;计算机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;技术&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//没有出现&quot;计算机技术&quot;字面量，所以不会在常量池里生成&quot;计算机技术&quot;对象</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str2 <span class="token operator">==</span> str2<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//true</span>
<span class="token comment">//&quot;计算机技术&quot; 在池中没有，但是在heap中存在，则intern时，会直接返回该heap中的引用</span>

<span class="token comment">//字符串常量池：&quot;ja&quot;和&quot;va&quot;     堆内存：str1引用的对象&quot;java&quot;  </span>
<span class="token comment">//堆内存中还有个StringBuilder的对象，但是会被gc回收，StringBuilder的toString方法会new String()，这个String才是真正返回的对象引用</span>
<span class="token class-name">String</span> str1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;ja&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;va&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//没有出现&quot;java&quot;字面量，所以不会在常量池里生成&quot;java&quot;对象</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str1 <span class="token operator">==</span> str1<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//false</span>
<span class="token comment">//java是关键字，在JVM初始化的相关类里肯定早就放进字符串常量池了</span>

<span class="token class-name">String</span> s1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1<span class="token operator">==</span>s1<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//false</span>
<span class="token comment">//&quot;test&quot;作为字面量，放入了池中，而new时s1指向的是heap中新生成的string对象，s1.intern()指向的是&quot;test&quot;字面量之前在池中生成的字符串对象</span>

<span class="token class-name">String</span> s2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s2<span class="token operator">==</span>s2<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//false</span>
<span class="token comment">//同上</span>
</code></pre></div><h5 id="八种基本类型的包装类和对象池"><a href="#八种基本类型的包装类和对象池" class="header-anchor">#</a> 八种基本类型的包装类和对象池</h5> <p>java中基本类型的包装类的大部分都实现了常量池技术(严格来说应该叫**对象池，**在堆上)，这些类是Byte,Short,Integer,Long,Character,Boolean,另外两种浮点数类型的包装类则没有实现。另外Byte,Short,Integer,Long,Character这5种整型的包装类也只是在对应值小于等于127时才可使用对象池，也即对象不负责创建和管理大于127的这些类的对象。因为一般这种比较小的数用到的概率相对较大。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//5种整形的包装类Byte,Short,Integer,Long,Character的对象，  </span>
        <span class="token comment">//在值小于127时可以使用对象池  </span>
        <span class="token class-name">Integer</span> i1 <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span>  <span class="token comment">//这种调用底层实际是执行的Integer.valueOf(127)，里面用到了IntegerCache对象池</span>
        <span class="token class-name">Integer</span> i2 <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i1 <span class="token operator">==</span> i2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出true  </span>

        <span class="token comment">//值大于127时，不会从对象池中取对象  </span>
        <span class="token class-name">Integer</span> i3 <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> i4 <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i3 <span class="token operator">==</span> i4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出false  </span>
        
        <span class="token comment">//用new关键词新生成对象不会使用对象池</span>
        <span class="token class-name">Integer</span> i5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token class-name">Integer</span> i6 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i5 <span class="token operator">==</span> i6<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出false </span>

        <span class="token comment">//Boolean类也实现了对象池技术  </span>
        <span class="token class-name">Boolean</span> bool1 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> bool2 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bool1 <span class="token operator">==</span> bool2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出true  </span>

        <span class="token comment">//浮点类型的包装类没有实现对象池技术  </span>
        <span class="token class-name">Double</span> d1 <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        <span class="token class-name">Double</span> d2 <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>d1 <span class="token operator">==</span> d2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出false  </span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>                
</code></pre></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/04/09, 18:55:28</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/80485b/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">JVM调优工具详解及调优实战</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/80485b/" class="prev">JVM调优工具详解及调优实战</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/ed68ae/"><div>
            负载均衡Ribbon&amp;LoadBalancer实战
            <!----></div></a> <span class="date">04-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/e79a05/"><div>
            SpringBoot自动配置底层源码解析
            <!----></div></a> <span class="date">04-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5655a2/"><div>
            idea加密连接服务器docker
            <!----></div></a> <span class="date">04-04</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>江</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9bc55a4a.js" defer></script><script src="/assets/js/2.712f36ff.js" defer></script><script src="/assets/js/33.1f3abdce.js" defer></script>
  </body>
</html>
