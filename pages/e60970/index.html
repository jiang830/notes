<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>linux 网络虚拟化：network namespace | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="个人技术博客,技术文档,学习,面试,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.b0792086.css" as="style"><link rel="preload" href="/assets/js/app.f6e3ccbc.js" as="script"><link rel="preload" href="/assets/js/2.1211d3e1.js" as="script"><link rel="preload" href="/assets/js/106.9d9a0548.js" as="script"><link rel="prefetch" href="/assets/js/10.a044793b.js"><link rel="prefetch" href="/assets/js/100.19e48c35.js"><link rel="prefetch" href="/assets/js/101.9d59e9a6.js"><link rel="prefetch" href="/assets/js/102.ade2e331.js"><link rel="prefetch" href="/assets/js/103.c16e4cc0.js"><link rel="prefetch" href="/assets/js/104.c95d4b72.js"><link rel="prefetch" href="/assets/js/105.e526a57f.js"><link rel="prefetch" href="/assets/js/107.aa122f8e.js"><link rel="prefetch" href="/assets/js/108.a454c42d.js"><link rel="prefetch" href="/assets/js/109.d4c073df.js"><link rel="prefetch" href="/assets/js/11.5e7d0c95.js"><link rel="prefetch" href="/assets/js/110.ec6aa9f5.js"><link rel="prefetch" href="/assets/js/111.e2c800ca.js"><link rel="prefetch" href="/assets/js/12.e841c0c3.js"><link rel="prefetch" href="/assets/js/13.41a2fb93.js"><link rel="prefetch" href="/assets/js/14.e2a3317c.js"><link rel="prefetch" href="/assets/js/15.a81a6ef1.js"><link rel="prefetch" href="/assets/js/16.7b69e07f.js"><link rel="prefetch" href="/assets/js/17.777b188a.js"><link rel="prefetch" href="/assets/js/18.c81cf408.js"><link rel="prefetch" href="/assets/js/19.a59301e0.js"><link rel="prefetch" href="/assets/js/20.18827160.js"><link rel="prefetch" href="/assets/js/21.8d5d511f.js"><link rel="prefetch" href="/assets/js/22.a8ac93a6.js"><link rel="prefetch" href="/assets/js/23.1bbe4807.js"><link rel="prefetch" href="/assets/js/24.00525e76.js"><link rel="prefetch" href="/assets/js/25.3c90e0a0.js"><link rel="prefetch" href="/assets/js/26.c93f745b.js"><link rel="prefetch" href="/assets/js/27.01181006.js"><link rel="prefetch" href="/assets/js/28.93af4585.js"><link rel="prefetch" href="/assets/js/29.a0806690.js"><link rel="prefetch" href="/assets/js/3.cff2a167.js"><link rel="prefetch" href="/assets/js/30.3beac9a7.js"><link rel="prefetch" href="/assets/js/31.3ee788ac.js"><link rel="prefetch" href="/assets/js/32.6522140e.js"><link rel="prefetch" href="/assets/js/33.24b1949c.js"><link rel="prefetch" href="/assets/js/34.90e39367.js"><link rel="prefetch" href="/assets/js/35.a67486b8.js"><link rel="prefetch" href="/assets/js/36.d9ffefc3.js"><link rel="prefetch" href="/assets/js/37.e3a99db4.js"><link rel="prefetch" href="/assets/js/38.8e250355.js"><link rel="prefetch" href="/assets/js/39.fc7bdfc1.js"><link rel="prefetch" href="/assets/js/4.9805163b.js"><link rel="prefetch" href="/assets/js/40.454bd56a.js"><link rel="prefetch" href="/assets/js/41.a235b641.js"><link rel="prefetch" href="/assets/js/42.af91ee0f.js"><link rel="prefetch" href="/assets/js/43.ee9374e7.js"><link rel="prefetch" href="/assets/js/44.36c8feb3.js"><link rel="prefetch" href="/assets/js/45.d8301c73.js"><link rel="prefetch" href="/assets/js/46.9a5a32af.js"><link rel="prefetch" href="/assets/js/47.d58b6a64.js"><link rel="prefetch" href="/assets/js/48.f02903e0.js"><link rel="prefetch" href="/assets/js/49.19767842.js"><link rel="prefetch" href="/assets/js/5.c3d6e4f2.js"><link rel="prefetch" href="/assets/js/50.48750e81.js"><link rel="prefetch" href="/assets/js/51.c4254bbf.js"><link rel="prefetch" href="/assets/js/52.b343e884.js"><link rel="prefetch" href="/assets/js/53.98458ade.js"><link rel="prefetch" href="/assets/js/54.fde5639b.js"><link rel="prefetch" href="/assets/js/55.1d6eee4b.js"><link rel="prefetch" href="/assets/js/56.b00d9d45.js"><link rel="prefetch" href="/assets/js/57.eaec60f9.js"><link rel="prefetch" href="/assets/js/58.4b703868.js"><link rel="prefetch" href="/assets/js/59.26a30b6e.js"><link rel="prefetch" href="/assets/js/6.c77dab88.js"><link rel="prefetch" href="/assets/js/60.eb33df05.js"><link rel="prefetch" href="/assets/js/61.d173fa46.js"><link rel="prefetch" href="/assets/js/62.429026f8.js"><link rel="prefetch" href="/assets/js/63.b58a3d49.js"><link rel="prefetch" href="/assets/js/64.99d18334.js"><link rel="prefetch" href="/assets/js/65.d837d9cb.js"><link rel="prefetch" href="/assets/js/66.2856ae98.js"><link rel="prefetch" href="/assets/js/67.0f6cebe6.js"><link rel="prefetch" href="/assets/js/68.307b98c1.js"><link rel="prefetch" href="/assets/js/69.df75865b.js"><link rel="prefetch" href="/assets/js/7.76f628a5.js"><link rel="prefetch" href="/assets/js/70.e07f77b7.js"><link rel="prefetch" href="/assets/js/71.42485a27.js"><link rel="prefetch" href="/assets/js/72.4baf0854.js"><link rel="prefetch" href="/assets/js/73.404ba776.js"><link rel="prefetch" href="/assets/js/74.c0ae67a0.js"><link rel="prefetch" href="/assets/js/75.3fa98553.js"><link rel="prefetch" href="/assets/js/76.932b0bf4.js"><link rel="prefetch" href="/assets/js/77.4f04b304.js"><link rel="prefetch" href="/assets/js/78.5eae2b57.js"><link rel="prefetch" href="/assets/js/79.8f73c293.js"><link rel="prefetch" href="/assets/js/8.d2e1201f.js"><link rel="prefetch" href="/assets/js/80.6b69b1c6.js"><link rel="prefetch" href="/assets/js/81.f8c4c107.js"><link rel="prefetch" href="/assets/js/82.b508d009.js"><link rel="prefetch" href="/assets/js/83.1ecb0ef4.js"><link rel="prefetch" href="/assets/js/84.76fceee6.js"><link rel="prefetch" href="/assets/js/85.d32f922a.js"><link rel="prefetch" href="/assets/js/86.d51d0105.js"><link rel="prefetch" href="/assets/js/87.8eadb26a.js"><link rel="prefetch" href="/assets/js/88.0ae44d13.js"><link rel="prefetch" href="/assets/js/89.d0e86356.js"><link rel="prefetch" href="/assets/js/9.2821f128.js"><link rel="prefetch" href="/assets/js/90.65387d98.js"><link rel="prefetch" href="/assets/js/91.ae9db7c9.js"><link rel="prefetch" href="/assets/js/92.0822d0e9.js"><link rel="prefetch" href="/assets/js/93.3632b4b7.js"><link rel="prefetch" href="/assets/js/94.2ae5e875.js"><link rel="prefetch" href="/assets/js/95.3e73b7f6.js"><link rel="prefetch" href="/assets/js/96.8060e5d8.js"><link rel="prefetch" href="/assets/js/97.a38c3af1.js"><link rel="prefetch" href="/assets/js/98.c9e52d85.js"><link rel="prefetch" href="/assets/js/99.4eeff47b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b0792086.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="学习笔记" class="logo"> <span class="site-name can-hide">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://img.jssjqd.cn/202303140455599.jpg"> <div class="blogger-info"><h3>江</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=Linux" title="分类" data-v-06225672>Linux</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>江</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-12-27</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">linux 网络虚拟化：network namespace<!----></h1>  <div class="theme-vdoing-content content__default"><p>network namespace 是实现网络虚拟化的重要功能，它能创建多个隔离的网络空间，它们有独自的网络栈信息。不管是虚拟机还是容器，运行的时候仿佛自己就在独立的网络中。这篇文章介绍 network namespace 的基本概念和用法，network namespace 是 linux 内核提供的功能，这篇文章借助 <code>ip</code> 命令来完成各种操作。<code>ip</code> 命令来自于 <code>iproute2</code> 安装包，一般系统会默认安装，如果没有的话，请读者自行安装。</p> <p><strong>NOTE</strong>：<code>ip</code> 命令因为需要修改系统的网络配置，默认需要 sudo 权限。这篇文章使用 root 用户执行，请不要在生产环境或者重要的系统中用 root 直接执行，以防产生错误。</p> <p><code>ip</code> 命令管理的功能很多， 和 network namespace 有关的操作都是在子命令 <code>ip netns</code> 下进行的，可以通过 ``ip netns help` 查看所有操作的帮助信息。</p> <p>默认情况下，使用 <code>ip netns</code> 是没有网络 namespace 的，所以 <code>ip netns ls</code> 命令看不到任何输出。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns help</span>
Usage:  <span class="token function">ip</span> netns list
        <span class="token function">ip</span> netns <span class="token function">add</span> NAME
        <span class="token function">ip</span> netns attach NAME PID
        <span class="token function">ip</span> netns <span class="token builtin class-name">set</span> NAME NETNSID
        <span class="token function">ip</span> <span class="token punctuation">[</span>-all<span class="token punctuation">]</span> netns delete <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span>
        <span class="token function">ip</span> netns identify <span class="token punctuation">[</span>PID<span class="token punctuation">]</span>
        <span class="token function">ip</span> netns pids NAME
        <span class="token function">ip</span> <span class="token punctuation">[</span>-all<span class="token punctuation">]</span> netns <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> cmd <span class="token punctuation">..</span>.
        <span class="token function">ip</span> netns monitor
        <span class="token function">ip</span> netns list-id <span class="token punctuation">[</span>target
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns ls</span>
</code></pre></div><p>创建 network namespace 也非常简单，直接使用 <code>ip netns add</code> 后面跟着要创建的 namespace 名称。如果相同名字的 namespace 已经存在，命令会报 <code>Cannot create namespace</code> 的错误。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns add net1</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns ls</span>
net1
</code></pre></div><p><code>ip netns</code> 命令创建的 network namespace 会出现在 <code>/var/run/netns/</code>(<strong>ubuntu目录为/run/netns/</strong>) 目录下，如果需要管理其他不是 <code>ip netns</code> 创建的 network namespace，只要在这个目录下创建一个指向对应 network namespace 文件的链接就行。</p> <p>有了自己创建的 network namespace，我们还需要看看它里面有哪些东西。对于每个 network namespace 来说，它会有自己独立的网卡、路由表、ARP 表、iptables 等和网络相关的资源。<code>ip</code> 命令提供了 <code>ip netns exec</code> 子命令可以在对应的 network namespace 中执行命令，比如我们要看一下这个 network namespace 中有哪些网卡。更棒的是，<strong>要执行的可以是任何命令，不只是和网络相关的</strong>（当然，和网络无关命令执行的结果和在外部执行没有区别）。比如下面例子中，执行 <code>bash</code> 命令了之后，后面所有的命令都是在这个 network namespace 中执行的，好处是不用每次执行命令都要把 <code>ip netns exec NAME</code> 补全，缺点是你无法清楚知道自己当前所在的 <code>shell</code>，容易混淆。</p> <div class="language- extra-class"><pre class="language-text"><code>[root@localhost ~]# ip netns exec net1 ip addr
1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
[root@localhost ~]# ip netns exec net1 bash
[root@localhost ~]# ip addr
1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
[root@localhost ~]# exit
exit
</code></pre></div><p><strong>更新</strong>：通过修改 bash 的前缀信息可以区分不同 shell，操作如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns1 /bin/bash <span class="token parameter variable">--rcfile</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;PS1=<span class="token entity" title="\&quot;">\&quot;</span>namespace ns1&gt; <span class="token entity" title="\&quot;">\&quot;</span>&quot;</span><span class="token punctuation">)</span>

namespace ns<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token function">ping</span> www.google.com
PING www.google.com <span class="token punctuation">(</span><span class="token number">178.60</span>.128.38<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from cache.google.com <span class="token punctuation">(</span><span class="token number">178.60</span>.128.38<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">58</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">17.6</span> ms
</code></pre></div><p><code>ip netns exec</code> 后面跟着 namespace 的名字，比如这里的 <code>net1</code>，然后是要执行的命令，只要是合法的 shell 命令都能运行，比如上面的 <code>ip addr</code> 或者 <code>bash</code>。</p> <p>每个 namespace 在创建的时候会自动创建一个 <code>lo</code> 的 interface，它的作用和 linux 系统中默认看到的 <code>lo</code> 一样，都是为了实现 loopback 通信。如果希望 <code>lo</code> 能工作，不要忘记启用它：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net1 ip link set lo up</span>
</code></pre></div><p>默认情况下，network namespace 是不能和主机网络，或者其他 network namespace 通信的。</p> <h2 id="network-namespace-之间通信"><a href="#network-namespace-之间通信" class="header-anchor">#</a> network namespace 之间通信</h2> <p>有了不同 network namespace 之后，也就有了网络的隔离，但是如果它们之间没有办法通信，也没有实际用处。要把两个网络连接起来，linux 提供了 <code>veth pair</code> 。可以把 <code>veth pair</code> 当做是双向的 pipe（管道），从一个方向发送的网络数据，可以直接被另外一端接收到；或者也可以想象成两个 namespace 直接通过一个特殊的虚拟网卡连接起来，可以直接通信。</p> <p>使用上面提到的方法，我们再创建另外一个 network namespace，这里我们使用 <code>net0</code> 和 <code>net1</code> 两个名字。</p> <p>我们可以使用 <code>ip link add type veth</code> 来创建一对 veth pair 出来，需要记住的是 veth pair 无法单独存在，删除其中一个，另一个也会自动消失。</p> <div class="language- extra-class"><pre class="language-text"><code>[root@localhost ~]# ip link add type veth
[root@localhost ~]# ip link
4: veth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
    link/ether 36:88:73:83:c9:64 brd ff:ff:ff:ff:ff:ff
5: veth1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
    link/ether fe:7e:75:4d:79:2e brd ff:ff:ff:ff:ff:ff
</code></pre></div><p><strong>小知识</strong>: 创建 veth pair 的时候可以自己指定它们的名字，比如 <strong><code>ip link add vethfoo type veth peer name vethbar</code></strong> 创建出来的两个名字就是 <code>vethfoo</code> 和 <code>vethbar</code> 。因为这里我们对名字没有特殊要求，所以就直接使用系统自动生成的名字。如果 pair 的一端接口处于 DOWN 状态，另一端能自动检测到这个信息，并把自己的状态设置为 <code>NO-CARRIER</code>。</p> <p>创建结束之后，我们能看到名字为 <code>veth0</code> 和 <code>veth1</code> 两个网络接口，名字后面的数字是系统自动生成的。接下来，要做的是把这对 veth pair 分别放到已经两个 namespace 里面，这个可以使用 <code>ip link set DEV netns NAME</code> 来实现：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip link set veth0 netns net0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip link set veth1 netns net1</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net0 ip addr</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
<span class="token number">4</span>: veth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noop state DOWN qlen <span class="token number">1000</span>
    link/ether <span class="token number">36</span>:88:73:83:c9:64 brd ff:ff:ff:ff:ff:ff
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net1 ip addr</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
<span class="token number">5</span>: veth1: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noop state DOWN qlen <span class="token number">1000</span>
    link/ether fe:7e:75:4d:79:2e brd ff:ff:ff:ff:ff:ff
</code></pre></div><p>最后，我们给这对 veth pair 配置上 ip 地址，并启用它们。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net0 ip link set veth0 up</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net0 ip addr add 10.0.1.1/24 dev veth0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net0 ip route</span>
<span class="token number">10.0</span>.1.0/24 dev veth0  proto kernel  scope <span class="token function">link</span>  src <span class="token number">10.0</span>.1.1

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net1 ip link set veth1 up</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net1 ip addr add 10.0.1.2/24 dev veth1</span>
</code></pre></div><p>可以看到，最每个 namespace 中，在配置玩 ip 之后，还自动生成了对应的路由表信息，网络 <code>10.0.1.0/24</code> 数据报文都会通过 veth pair 进行传输。使用 <code>ping</code> 命令可以验证它们的连通性：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net0 ping -c 3 10.0.1.2</span>
PING <span class="token number">10.0</span>.1.2 <span class="token punctuation">(</span><span class="token number">10.0</span>.1.2<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.1.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.039</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.1.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.039</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.1.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.139</span> ms

--- <span class="token number">10.0</span>.1.2 <span class="token function">ping</span> statistics ---
<span class="token number">3</span> packets transmitted, <span class="token number">3</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 2004ms
rtt min/avg/max/mdev <span class="token operator">=</span> <span class="token number">0.039</span>/0.072/0.139/0.047 ms
</code></pre></div><p>完成这些，我们创建的网络拓扑结构如下所示：</p> <p><img src="http://img.jssjqd.cn/202111060751772.jpg" alt="img"></p> <h2 id="使用-bridge-连接不同的-namespace"><a href="#使用-bridge-连接不同的-namespace" class="header-anchor">#</a> 使用 bridge 连接不同的 namespace</h2> <p>虽然 veth pair 可以实现两个 network namespace 之间的通信，但是当多个 namespace 需要通信的时候，就无能为力了。
讲到多个网络设备通信，我们首先想到的交换机和路由器。因为这里要考虑的只是同个网络，所以只用到交换机的功能。linux 当然也提供了虚拟交换机的功能，我们还是用 <code>ip</code> 命令来完成所有的操作。</p> <p><strong>NOTE</strong>：和 bridge 有关的操作也可以使用命令 <code>brctl</code>，这个命令来自 <code>bridge-utils</code> 这个包，读者可以根据自己的发行版进行安装，使用方法请查阅 man 页面或者相关文档。</p> <p>首先我们来创建需要的 bridge，简单起见名字就叫做 <code>br0</code>。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip link add br0 type bridge</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip link set dev br0 up</span>
</code></pre></div><p>下面只演示一个 namespace 的操作，其他 namespace 要做的事情和这个类似。创建 veth pair：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip link add type veth</span>
</code></pre></div><p>把其中一个 veth（veth1） 放到 net0 里面，设置它的 ip 地址并启用它：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip link set dev veth1 netns net0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net0 ip link set dev veth1 name eth0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net0 ip addr add 10.0.1.1/24 dev eth0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net0 ip link set dev eth0 up</span>
</code></pre></div><p>最后，把另一个 veth（veth0）连接到创建的 bridge 上，并启用它：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip link set dev veth0 master br0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip link set dev veth0 up</span>
</code></pre></div><p>可以通过 <code>bridge</code> 命令（也是 iproute2 包自带的命令）来查看 bridge 管理的 link 信息：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># bridge link</span>
<span class="token number">17</span>: veth0 state UP <span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> master br0 state forwarding priority <span class="token number">32</span> cost <span class="token number">2</span>
</code></pre></div><p>最后通过 ping 命令来测试网络的连通性：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns exec net0 ping -c 3 10.0.1.3</span>
PING <span class="token number">10.0</span>.1.3 <span class="token punctuation">(</span><span class="token number">10.0</span>.1.3<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.1.3: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.251</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.1.3: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.047</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.1.3: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.046</span> ms

--- <span class="token number">10.0</span>.1.3 <span class="token function">ping</span> statistics ---
<span class="token number">3</span> packets transmitted, <span class="token number">3</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 2008ms
</code></pre></div><p>下图是这部分网络的拓扑结构，如果对 docker 网络熟悉的话，其实这和 docker 默认的 bridge 网络模型非常相似。当然要实现每个 namespace 对外网的访问还需要额外的配置（设置默认网关，开启 ip_forward，为网络添加 NAT 规则等）。</p> <p><img src="http://img.jssjqd.cn/202111060751372.jpg" alt="img"></p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/27, 17:22:47</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/dc51b7/"><div>
            RabbitMQ工作模式剖析以及常用编程模型
            <!----></div></a> <span class="date">03-27</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/15be7d/"><div>
            Tomcat整体架构及其设计精髓
            <!----></div></a> <span class="date">03-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/01ceff/"><div>
            深入理解网络通信和TCP IP协议
            <!----></div></a> <span class="date">03-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xugaoyi" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>江</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.f6e3ccbc.js" defer></script><script src="/assets/js/2.1211d3e1.js" defer></script><script src="/assets/js/106.9d9a0548.js" defer></script>
  </body>
</html>
