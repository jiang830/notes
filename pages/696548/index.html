<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ docoker集群 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="个人技术博客,技术文档,学习,面试,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.b0792086.css" as="style"><link rel="preload" href="/assets/js/app.da287f9c.js" as="script"><link rel="preload" href="/assets/js/2.1211d3e1.js" as="script"><link rel="preload" href="/assets/js/65.674d6d9d.js" as="script"><link rel="prefetch" href="/assets/js/10.a044793b.js"><link rel="prefetch" href="/assets/js/100.bd0ea6b6.js"><link rel="prefetch" href="/assets/js/101.4d85f6a7.js"><link rel="prefetch" href="/assets/js/102.8037b41b.js"><link rel="prefetch" href="/assets/js/103.3ac2cecf.js"><link rel="prefetch" href="/assets/js/104.b83cc222.js"><link rel="prefetch" href="/assets/js/105.da46c9fd.js"><link rel="prefetch" href="/assets/js/106.6b696d74.js"><link rel="prefetch" href="/assets/js/107.df207272.js"><link rel="prefetch" href="/assets/js/108.0e752b55.js"><link rel="prefetch" href="/assets/js/109.ed01eb47.js"><link rel="prefetch" href="/assets/js/11.5e7d0c95.js"><link rel="prefetch" href="/assets/js/110.d1296d78.js"><link rel="prefetch" href="/assets/js/111.5663587f.js"><link rel="prefetch" href="/assets/js/112.437ce6cc.js"><link rel="prefetch" href="/assets/js/12.e841c0c3.js"><link rel="prefetch" href="/assets/js/13.41a2fb93.js"><link rel="prefetch" href="/assets/js/14.e2a3317c.js"><link rel="prefetch" href="/assets/js/15.a81a6ef1.js"><link rel="prefetch" href="/assets/js/16.7b69e07f.js"><link rel="prefetch" href="/assets/js/17.777b188a.js"><link rel="prefetch" href="/assets/js/18.c81cf408.js"><link rel="prefetch" href="/assets/js/19.a59301e0.js"><link rel="prefetch" href="/assets/js/20.18827160.js"><link rel="prefetch" href="/assets/js/21.8d5d511f.js"><link rel="prefetch" href="/assets/js/22.a8ac93a6.js"><link rel="prefetch" href="/assets/js/23.1bbe4807.js"><link rel="prefetch" href="/assets/js/24.00525e76.js"><link rel="prefetch" href="/assets/js/25.3c90e0a0.js"><link rel="prefetch" href="/assets/js/26.c93f745b.js"><link rel="prefetch" href="/assets/js/27.01181006.js"><link rel="prefetch" href="/assets/js/28.93af4585.js"><link rel="prefetch" href="/assets/js/29.a0806690.js"><link rel="prefetch" href="/assets/js/3.7515da97.js"><link rel="prefetch" href="/assets/js/30.3beac9a7.js"><link rel="prefetch" href="/assets/js/31.3ee788ac.js"><link rel="prefetch" href="/assets/js/32.6522140e.js"><link rel="prefetch" href="/assets/js/33.24b1949c.js"><link rel="prefetch" href="/assets/js/34.90e39367.js"><link rel="prefetch" href="/assets/js/35.a67486b8.js"><link rel="prefetch" href="/assets/js/36.d9ffefc3.js"><link rel="prefetch" href="/assets/js/37.e3a99db4.js"><link rel="prefetch" href="/assets/js/38.8e250355.js"><link rel="prefetch" href="/assets/js/39.fc7bdfc1.js"><link rel="prefetch" href="/assets/js/4.9805163b.js"><link rel="prefetch" href="/assets/js/40.454bd56a.js"><link rel="prefetch" href="/assets/js/41.a235b641.js"><link rel="prefetch" href="/assets/js/42.af91ee0f.js"><link rel="prefetch" href="/assets/js/43.ee9374e7.js"><link rel="prefetch" href="/assets/js/44.36c8feb3.js"><link rel="prefetch" href="/assets/js/45.d8301c73.js"><link rel="prefetch" href="/assets/js/46.9a5a32af.js"><link rel="prefetch" href="/assets/js/47.7f746357.js"><link rel="prefetch" href="/assets/js/48.3a901388.js"><link rel="prefetch" href="/assets/js/49.1ae37a6e.js"><link rel="prefetch" href="/assets/js/5.c3d6e4f2.js"><link rel="prefetch" href="/assets/js/50.48750e81.js"><link rel="prefetch" href="/assets/js/51.c4254bbf.js"><link rel="prefetch" href="/assets/js/52.b343e884.js"><link rel="prefetch" href="/assets/js/53.98458ade.js"><link rel="prefetch" href="/assets/js/54.fde5639b.js"><link rel="prefetch" href="/assets/js/55.1d6eee4b.js"><link rel="prefetch" href="/assets/js/56.b00d9d45.js"><link rel="prefetch" href="/assets/js/57.eaec60f9.js"><link rel="prefetch" href="/assets/js/58.4b703868.js"><link rel="prefetch" href="/assets/js/59.26a30b6e.js"><link rel="prefetch" href="/assets/js/6.c77dab88.js"><link rel="prefetch" href="/assets/js/60.eb33df05.js"><link rel="prefetch" href="/assets/js/61.d173fa46.js"><link rel="prefetch" href="/assets/js/62.429026f8.js"><link rel="prefetch" href="/assets/js/63.b58a3d49.js"><link rel="prefetch" href="/assets/js/64.851d5d76.js"><link rel="prefetch" href="/assets/js/66.ececc579.js"><link rel="prefetch" href="/assets/js/67.b733240a.js"><link rel="prefetch" href="/assets/js/68.6e4191d3.js"><link rel="prefetch" href="/assets/js/69.699a59ea.js"><link rel="prefetch" href="/assets/js/7.76f628a5.js"><link rel="prefetch" href="/assets/js/70.4f4dcf9b.js"><link rel="prefetch" href="/assets/js/71.ed9703c6.js"><link rel="prefetch" href="/assets/js/72.b6d86aab.js"><link rel="prefetch" href="/assets/js/73.d835d9fc.js"><link rel="prefetch" href="/assets/js/74.ee7c0011.js"><link rel="prefetch" href="/assets/js/75.4db81ffe.js"><link rel="prefetch" href="/assets/js/76.0bfb8bde.js"><link rel="prefetch" href="/assets/js/77.4fb5960f.js"><link rel="prefetch" href="/assets/js/78.20e475a5.js"><link rel="prefetch" href="/assets/js/79.1fda7459.js"><link rel="prefetch" href="/assets/js/8.d2e1201f.js"><link rel="prefetch" href="/assets/js/80.b3da8d44.js"><link rel="prefetch" href="/assets/js/81.d57d0933.js"><link rel="prefetch" href="/assets/js/82.66610608.js"><link rel="prefetch" href="/assets/js/83.96744a0a.js"><link rel="prefetch" href="/assets/js/84.b9a8b20b.js"><link rel="prefetch" href="/assets/js/85.e6836d72.js"><link rel="prefetch" href="/assets/js/86.6ee49a02.js"><link rel="prefetch" href="/assets/js/87.b4c2ee51.js"><link rel="prefetch" href="/assets/js/88.a3470f95.js"><link rel="prefetch" href="/assets/js/89.dbea7400.js"><link rel="prefetch" href="/assets/js/9.2821f128.js"><link rel="prefetch" href="/assets/js/90.68c89724.js"><link rel="prefetch" href="/assets/js/91.38e91834.js"><link rel="prefetch" href="/assets/js/92.f6a6b44f.js"><link rel="prefetch" href="/assets/js/93.3fc30f03.js"><link rel="prefetch" href="/assets/js/94.c15a1105.js"><link rel="prefetch" href="/assets/js/95.1af5eca1.js"><link rel="prefetch" href="/assets/js/96.0ce92f32.js"><link rel="prefetch" href="/assets/js/97.b3c0f159.js"><link rel="prefetch" href="/assets/js/98.753c4105.js"><link rel="prefetch" href="/assets/js/99.e289d986.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b0792086.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="学习笔记" class="logo"> <span class="site-name can-hide">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://img.jssjqd.cn/202303140455599.jpg"> <div class="blogger-info"><h3>江</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>RabbitMQ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/9a014b/" class="sidebar-link">RabbitMQ上手以及集群机构</a></li><li><a href="/pages/696548/" aria-current="page" class="active sidebar-link">RabbitMQ docoker集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/696548/#_1-1-普通集群" class="sidebar-link">1.1 普通集群</a></li><li class="sidebar-sub-header level2"><a href="/pages/696548/#_1-2-镜像集群" class="sidebar-link">1.2 镜像集群</a></li><li class="sidebar-sub-header level2"><a href="/pages/696548/#_1-3-节点类型" class="sidebar-link">1.3 节点类型</a></li><li class="sidebar-sub-header level2"><a href="/pages/696548/#_2-1-预备知识" class="sidebar-link">2.1 预备知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/696548/#_2-2-开始搭建" class="sidebar-link">2.2 开始搭建</a></li><li class="sidebar-sub-header level3"><a href="/pages/696548/#_2-3-代码测试" class="sidebar-link">2.3 代码测试</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/696548/#_2-4-反向测试" class="sidebar-link">2.4 反向测试</a></li><li class="sidebar-sub-header level2"><a href="/pages/696548/#_3-1-网页配置镜像队列" class="sidebar-link">3.1 网页配置镜像队列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/696548/#_3-2-命令行配置镜像队列" class="sidebar-link">3.2 命令行配置镜像队列</a></li></ul></li></ul></li><li><a href="/pages/259322/" class="sidebar-link">RabbitMQ工作模式剖析以及常用编程模型</a></li><li><a href="/pages/ae15fa/" class="sidebar-link">RabbitMQ高级使用场景</a></li><li><a href="/pages/def779/" class="sidebar-link">RabbitMQ使用中的常见问题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kafka</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>RocketMQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" title="分类" data-v-06225672>消息队列</a></li><li data-v-06225672><a href="/categories/?category=RabbitMQ" title="分类" data-v-06225672>RabbitMQ</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>江</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-11-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">RabbitMQ docoker集群<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="两种模式"><a href="#两种模式" class="header-anchor">#</a> 两种模式</h1> <p>说到集群，小伙伴们可能第一个问题是，如果我有一个 RabbitMQ 集群，那么是不是我的消息集群中的每一个实例都保存一份呢？</p> <p>这其实就涉及到 RabbitMQ 集群的两种模式：</p> <ul><li>普通集群</li> <li>镜像集群</li></ul> <h2 id="_1-1-普通集群"><a href="#_1-1-普通集群" class="header-anchor">#</a> 1.1 普通集群</h2> <p>普通集群模式，就是将 RabbitMQ 部署到多台服务器上，每个服务器启动一个 RabbitMQ 实例，多个实例之间进行消息通信。</p> <p>此时我们创建的队列 Queue，它的元数据（主要就是 Queue 的一些配置信息）会在所有的 RabbitMQ 实例中进行同步，但是队列中的消息只会存在于一个 RabbitMQ 实例上，而不会同步到其他队列。</p> <p>当我们消费消息的时候，如果连接到了另外一个实例，那么那个实例会通过元数据定位到 Queue 所在的位置，然后访问 Queue 所在的实例，拉取数据过来发送给消费者。</p> <p>这种集群可以提高 RabbitMQ 的消息吞吐能力，但是无法保证高可用，因为一旦一个 RabbitMQ 实例挂了，消息就没法访问了，如果消息队列做了持久化，那么等 RabbitMQ 实例恢复后，就可以继续访问了；如果消息队列没做持久化，那么消息就丢了。</p> <p>大致的流程图如下图：</p> <p><img src="https://img.jssjqd.cn/202211080149876.png" alt=""></p> <h2 id="_1-2-镜像集群"><a href="#_1-2-镜像集群" class="header-anchor">#</a> 1.2 镜像集群</h2> <p>它和普通集群最大的区别在于 Queue 数据和原数据不再是单独存储在一台机器上，而是同时存储在多台机器上。也就是说每个 RabbitMQ 实例都有一份镜像数据（副本数据）。每次写入消息的时候都会自动把数据同步到多台实例上去，这样一旦其中一台机器发生故障，其他机器还有一份副本数据可以继续提供服务，也就实现了高可用。</p> <p>大致流程图如下图：</p> <p><img src="https://img.jssjqd.cn/202211080149140.png" alt=""></p> <h2 id="_1-3-节点类型"><a href="#_1-3-节点类型" class="header-anchor">#</a> 1.3 节点类型</h2> <p>RabbitMQ 中的节点类型有两种：</p> <ul><li>RAM node：内存节点将所有的队列、交换机、绑定、用户、权限和 vhost 的元数据定义存储在内存中，好处是可以使得交换机和队列声明等操作速度更快。</li> <li>Disk node：将元数据存储在磁盘中，单节点系统只允许磁盘类型的节点，防止重启 RabbitMQ 的时候，丢失系统的配置信息</li></ul> <p>RabbitMQ 要求在集群中至少有一个磁盘节点，所有其他节点可以是内存节点，当节点加入或者离开集群时，必须要将该变更通知到至少一个磁盘节点。如果集群中唯一的一个磁盘节点崩溃的话，集群仍然可以保持运行，但是无法进行其他操作（增删改查），直到节点恢复。为了确保集群信息的可靠性，或者在不确定使用磁盘节点还是内存节点的时候，建议直接用磁盘节点。</p> <h1 id="搭建普通集群"><a href="#搭建普通集群" class="header-anchor">#</a> 搭建普通集群</h1> <h2 id="_2-1-预备知识"><a href="#_2-1-预备知识" class="header-anchor">#</a> 2.1 预备知识</h2> <p>大致的结构了解了，接下来我们就把集群给搭建起来。先从普通集群开始，我们就使用 docker 来搭建。</p> <p>搭建之前，有两个预备知识需要大家了解：</p> <ul><li>搭建集群时，节点中的 Erlang Cookie 值要一致，默认情况下，文件在 /var/lib/rabbitmq/.erlang.cookie，我们在用 docker 创建 RabbitMQ 容器时，可以为之设置相应的 Cookie 值。</li> <li>RabbitMQ 是通过主机名来连接服务，必须保证各个主机名之间可以 ping 通。可以通过编辑 /etc/hosts 来手工添加主机名和 IP 对应关系。如果主机名 ping 不通，RabbitMQ 服务启动会失败（如果我们是在不同的服务器上搭建 RabbitMQ 集群，大家需要注意这一点，接下来的 2.2 小结，我们将通过 Docker 的容器连接 link 来实现容器之间的访问，略有不同）。</li></ul> <h3 id="_2-2-开始搭建"><a href="#_2-2-开始搭建" class="header-anchor">#</a> 2.2 开始搭建</h3> <p>执行如下命令创建三个 RabbitMQ 容器：</p> <p>[<img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/copycode.gif" alt="">](javascript:void(0); &quot;复制代码&quot;)</p> <div class="language- extra-class"><pre class="language-text"><code>docker run -d --hostname rabbit01 --name mq01 -p 5671:5672 -p 15671:15672 -e RABBITMQ_ERLANG_COOKIE=&quot;javaboy_rabbitmq_cookie&quot; rabbitmq:3-management
docker run -d --hostname rabbit02 --name mq02 --link mq01:mylink01 -p 5672:5672 -p 15672:15672 -e RABBITMQ_ERLANG_COOKIE=&quot;javaboy_rabbitmq_cookie&quot; rabbitmq:3-management
docker run -d --hostname rabbit03 --name mq03 --link mq01:mylink02 --link mq02:mylink03 -p 5673:5672 -p 15673:15672 -e RABBITMQ_ERLANG_COOKIE=&quot;javaboy_rabbitmq_cookie&quot; rabbitmq:3-management
</code></pre></div><p>[<img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/copycode.gif" alt="">](javascript:void(0); &quot;复制代码&quot;)</p> <p>运行结果如下：</p> <p><img src="https://img.jssjqd.cn/202211080149779.png" alt=""></p> <p>三个节点现在就启动好了，注意在 mq02 和 mq03 中，分别使用了 --link 参数来实现容器连接，关于这个参数，如果大家不懂，可以在公众号江南一点雨后台回复 docker，由松哥写的 docker 入门教程，里边有讲这个。这里我就不啰嗦了。另外还需要注意，mq03 容器中要既能够连接 mq01 也能够连接 mq02。</p> <p>接下来进入到 mq02 容器中，首先查看一下 hosts 文件，可以看到我们配置的容器连接已经生效了：<br> <img src="https://img.jssjqd.cn/202211080149853.png" alt=""></p> <p>将来在 mq02 容器中，就可以通过 mylink01 或者 rabbit01 访问到 mq01 容器了。</p> <p>接下来我们开始集群的配置。</p> <p>分别执行如下命令将 mq02 容器加入集群中：</p> <div class="language- extra-class"><pre class="language-text"><code>rabbitmqctl stop_app
rabbitmqctl join_cluster rabbit@rabbit01
rabbitmqctl start_app
</code></pre></div><p>接下来输入如下命令我们可以查看集群的状态：</p> <div class="language- extra-class"><pre class="language-text"><code>rabbitmqctl cluster_status
</code></pre></div><p><img src="https://img.jssjqd.cn/202211080149513.png" alt=""></p> <p>可以看到，集群中已经有两个节点了。</p> <p>接下来通过相同的方式将 mq03 也加入到集群中：</p> <div class="language- extra-class"><pre class="language-text"><code>rabbitmqctl stop_app
rabbitmqctl join_cluster rabbit@rabbit01
rabbitmqctl start_app
</code></pre></div><p><img src="https://img.jssjqd.cn/202211080149926.png" alt=""></p> <p>接下来，我们可以查看集群信息：</p> <p><img src="https://img.jssjqd.cn/202211080149829.png" alt=""></p> <p>可以看到，此时集群中已经有三个节点了。</p> <p>其实，这个时候，我们也可以通过网页来查看集群信息，在三个 RabbitMQ 实例的 Web 端首页，都可以看到如下内容：</p> <p><img src="https://img.jssjqd.cn/202211080149079.png" alt=""></p> <h3 id="_2-3-代码测试"><a href="#_2-3-代码测试" class="header-anchor">#</a> 2.3 代码测试</h3> <p>接下来我们来简单测试一下这个集群。</p> <p>我们创建一个名为 mq_cluster_demo 的父工程，然后在其中创建两个子工程。</p> <p>第一个子工程名为 provider，是一个消息生产者，创建时引入 Web 和 RabbitMQ 依赖，如下：</p> <p><img src="https://img.jssjqd.cn/202211080149996.png" alt=""></p> <p>然后配置 applicaiton.properties，内容如下（注意集群配置）：</p> <div class="language- extra-class"><pre class="language-text"><code>spring.rabbitmq.addresses=localhost:5671,localhost:5672,localhost:5673
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest
</code></pre></div><p>接下来提供一个简单的队列，如下：</p> <p>[<img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/copycode.gif" alt="">](javascript:void(0); &quot;复制代码&quot;)</p> <div class="language- extra-class"><pre class="language-text"><code>@Configuration
public class RabbitConfig {
    public static final String MY_QUEUE_NAME = &quot;my_queue_name&quot;;
    public static final String MY_EXCHANGE_NAME = &quot;my_exchange_name&quot;;
    public static final String MY_ROUTING_KEY = &quot;my_queue_name&quot;;

    @Bean
    Queue queue() {
        return new Queue(MY_QUEUE_NAME, true, false, false);
    }

    @Bean
    DirectExchange directExchange() {
        return new DirectExchange(MY_EXCHANGE_NAME, true, false);
    }

    @Bean
    Binding binding() {
        return BindingBuilder.bind(queue())
                .to(directExchange())
                .with(MY_ROUTING_KEY);
    }
}
</code></pre></div><p>[<img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/copycode.gif" alt="">](javascript:void(0); &quot;复制代码&quot;)</p> <p>这个没啥好说的，都是基本内容，接下来我们在单元测试中进行消息发送测试：</p> <p>[<img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/copycode.gif" alt="">](javascript:void(0); &quot;复制代码&quot;)</p> <div class="language- extra-class"><pre class="language-text"><code>@SpringBootTest
class ProviderApplicationTests {

    @Autowired
    RabbitTemplate rabbitTemplate;

    @Test
    void contextLoads() {
        rabbitTemplate.convertAndSend(null, RabbitConfig.MY_QUEUE_NAME, &quot;hello 江南一点雨&quot;);
    }

}
</code></pre></div><p>[<img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/copycode.gif" alt="">](javascript:void(0); &quot;复制代码&quot;)</p> <p>这条消息发送成功之后，在 RabbitMQ 的 Web 管理端，我们会看到三个 RabbitMQ 实例上都会显示有一条消息，但是实际上消息本身只存在于一个 RabbitMQ 实例。</p> <p>接下来我们再创建一个消息消费者，消息消费者的依赖以及配置和消息生产者都是一模一样，我就不重复了，消息消费者中增加一个消息接收器：</p> <p>[<img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/copycode.gif" alt="">](javascript:void(0); &quot;复制代码&quot;)</p> <div class="language- extra-class"><pre class="language-text"><code>@Component
public class MsgReceiver {

    @RabbitListener(queues = RabbitConfig.MY_QUEUE_NAME)
    public void handleMsg(String msg) {
        System.out.println(&quot;msg = &quot; + msg);
    }
}
</code></pre></div><p>[<img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/copycode.gif" alt="">](javascript:void(0); &quot;复制代码&quot;)</p> <p>当消息消费者启动成功后，这个方法中只收到一条消息，进一步验证了我们搭建的 RabbitMQ 集群是没问题的。</p> <h2 id="_2-4-反向测试"><a href="#_2-4-反向测试" class="header-anchor">#</a> 2.4 反向测试</h2> <p>接下来松哥再举两个反例，以证明消息并没有同步到其他 RabbitMQ 实例。</p> <p>确保三个 RabbitMQ 实例都是启动状态，关闭掉 Consumer，然后通过 provider 发送一条消息，发送成功之后，关闭 mq01 实例，然后启动 Consumer 实例，此时 Consumer 实例并不会消费消息，反而会报错说 mq01 实例连接不上，这个例子就可以说明消息在 mq01 上，并没有同步到另外两个 MQ 上。相反，如果 provider 发送消息成功之后，我们没有关闭 mq01 实例而是关闭了 mq02 实例，那么你就会发现消息的消费不受影响。</p> <h1 id="搭建镜像集群"><a href="#搭建镜像集群" class="header-anchor">#</a> 搭建镜像集群</h1> <p>所谓的镜像集群模式并不需要额外搭建，只需要我们将队列配置为镜像队列即可。</p> <p>这个配置可以通过网页配置，也可以通过命令行配置，我们分别来看。</p> <h2 id="_3-1-网页配置镜像队列"><a href="#_3-1-网页配置镜像队列" class="header-anchor">#</a> 3.1 网页配置镜像队列</h2> <p>先来看看网页上如何配置镜像队列。</p> <p>点击 Admin 选项卡，然后点击右边的 Policies，再点击 Add/update a policy，如下图：<br> <img src="https://img.jssjqd.cn/202211080149005.png" alt=""></p> <p>接下来添加一个策略，如下图：</p> <p><img src="https://img.jssjqd.cn/202211080149380.png" alt=""></p> <p>各参数含义如下：</p> <ul><li>Name: policy 的名称。</li> <li>Pattern: queue 的匹配模式 (正则表达式)。</li> <li>Definition：镜像定义，主要有三个参数：ha-mode, ha-params, ha-sync-mode。
<ul><li>ha-mode：指明镜像队列的模式，有效值为 all、exactly、nodes。其中 all 表示在集群中所有的节点上进行镜像（默认即此）；exactly 表示在指定个数的节点上进行镜像，节点的个数由 ha-params 指定；nodes 表示在指定的节点上进行镜像，节点名称通过 ha-params 指定。</li> <li>ha-params：ha-mode 模式需要用到的参数。</li> <li>ha-sync-mode：进行队列中消息的同步方式，有效值为 automatic 和 manual。</li> <li>priority 为可选参数，表示 policy 的优先级。</li></ul></li></ul> <p>配置完成后，点击下面的 add/update policy 按钮，完成策略的添加，如下：<br> <img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/1504650-20220831102616405-116167520.png" alt=""></p> <p>添加完成后，我们可以进行一个简单的测试。</p> <p>首先确认三个 RabbitMQ 都启动了，然后用上面的 provider 向消息队列发送一条消息。</p> <p>发完之后关闭 mq01 实例。</p> <p>接下来启动 consumer，此时发现 consumer 可以完成消息的消费（注意和前面的反向测试区分），这就说明镜像队列已经搭建成功了。</p> <h3 id="_3-2-命令行配置镜像队列"><a href="#_3-2-命令行配置镜像队列" class="header-anchor">#</a> 3.2 命令行配置镜像队列</h3> <p>命令行的配置格式如下：</p> <div class="language- extra-class"><pre class="language-text"><code>rabbitmqctl set_policy [-p vhost] [--priority priority] [--apply-to apply-to] {name} {pattern} {definition}
</code></pre></div><p>举一个简单的配置案例：</p> <div class="language- extra-class"><pre class="language-text"><code>rabbitmqctl set_policy -p / --apply-to queues my_queue_mirror &quot;^&quot; '{&quot;ha-mode&quot;:&quot;all&quot;,&quot;ha-sync-mode&quot;:&quot;automatic&quot;}'
</code></pre></div><p><img src="E:/project/temp/01.RabbitMQ%20docoker%E9%9B%86%E7%BE%A4/1504650-20220831102721521-1681189562.png" alt=""></p> <p><a href="https://blog.csdn.net/u012702547/article/details/121890003" target="_blank" rel="noopener noreferrer"><em>https://blog.csdn.net/u012702547/article/details/121890003</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Rabbitmq 集群 docker 版</p> <p><a href="https://blog.csdn.net/qq_31745863/article/details/122946551" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/qq_31745863/article/details/122946551<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/26, 18:49:25</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/9a014b/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">RabbitMQ上手以及集群机构</div></a> <a href="/pages/259322/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">RabbitMQ工作模式剖析以及常用编程模型</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/9a014b/" class="prev">RabbitMQ上手以及集群机构</a></span> <span class="next"><a href="/pages/259322/">RabbitMQ工作模式剖析以及常用编程模型</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/d34f8a/"><div>
            Tomcat整体架构及其设计精髓
            <!----></div></a> <span class="date">03-26</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/8119e2/"><div>
            深入理解网络通信和TCP IP协议
            <!----></div></a> <span class="date">03-26</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/d727e0/"><div>
            BIO NIO编程与直接内存零拷贝
            <!----></div></a> <span class="date">03-26</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xugaoyi" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>江</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.da287f9c.js" defer></script><script src="/assets/js/2.1211d3e1.js" defer></script><script src="/assets/js/65.674d6d9d.js" defer></script>
  </body>
</html>
